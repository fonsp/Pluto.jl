(()=>{var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{};function e(t,e,n,r){Object.defineProperty(t,e,{get:n,set:r,enumerable:!0,configurable:!0})}var n=t.parcelRequire94c2;n.register("4yuRh",(function(r,s){e(r.exports,"setLogLevel",(()=>Gr)),e(r.exports,"_logWarn",(()=>$r)),e(r.exports,"_debugAssert",(()=>Yr)),e(r.exports,"FirestoreError",(()=>Zr)),e(r.exports,"_EmptyAuthCredentialsProvider",(()=>ns)),e(r.exports,"_EmptyAppCheckTokenProvider",(()=>cs)),e(r.exports,"_AutoId",(()=>hs)),e(r.exports,"Timestamp",(()=>ms)),e(r.exports,"_FieldPath",(()=>bs)),e(r.exports,"_DocumentKey",(()=>_s)),e(r.exports,"_isBase64Available",(()=>Vi)),e(r.exports,"_ByteString",(()=>qi)),e(r.exports,"_DatabaseId",(()=>Hi)),e(r.exports,"_validateIsNotUsedTogether",(()=>$f)),e(r.exports,"_cast",(()=>Yf)),e(r.exports,"connectFirestoreEmulator",(()=>tg)),e(r.exports,"Query",(()=>eg)),e(r.exports,"DocumentReference",(()=>ng)),e(r.exports,"CollectionReference",(()=>rg)),e(r.exports,"collection",(()=>sg)),e(r.exports,"collectionGroup",(()=>ig)),e(r.exports,"doc",(()=>og)),e(r.exports,"refEqual",(()=>ag)),e(r.exports,"queryEqual",(()=>ug)),e(r.exports,"LoadBundleTask",(()=>hg)),e(r.exports,"CACHE_SIZE_UNLIMITED",(()=>dg)),e(r.exports,"Firestore",(()=>fg)),e(r.exports,"initializeFirestore",(()=>gg)),e(r.exports,"getFirestore",(()=>mg)),e(r.exports,"ensureFirestoreConfigured",(()=>pg)),e(r.exports,"enableIndexedDbPersistence",(()=>wg)),e(r.exports,"enableMultiTabIndexedDbPersistence",(()=>vg)),e(r.exports,"clearIndexedDbPersistence",(()=>_g)),e(r.exports,"waitForPendingWrites",(()=>Ig)),e(r.exports,"enableNetwork",(()=>Eg)),e(r.exports,"disableNetwork",(()=>Tg)),e(r.exports,"terminate",(()=>Sg)),e(r.exports,"loadBundle",(()=>xg)),e(r.exports,"namedQuery",(()=>Cg)),e(r.exports,"AggregateField",(()=>Ag)),e(r.exports,"AggregateQuerySnapshot",(()=>Ng)),e(r.exports,"Bytes",(()=>kg)),e(r.exports,"FieldPath",(()=>Rg)),e(r.exports,"documentId",(()=>Mg)),e(r.exports,"FieldValue",(()=>Lg)),e(r.exports,"GeoPoint",(()=>Og)),e(r.exports,"QueryConstraint",(()=>fm)),e(r.exports,"query",(()=>gm)),e(r.exports,"QueryCompositeFilterConstraint",(()=>ym)),e(r.exports,"QueryFieldFilterConstraint",(()=>mm)),e(r.exports,"where",(()=>pm)),e(r.exports,"or",(()=>wm)),e(r.exports,"and",(()=>vm)),e(r.exports,"QueryOrderByConstraint",(()=>bm)),e(r.exports,"orderBy",(()=>_m)),e(r.exports,"QueryLimitConstraint",(()=>Im)),e(r.exports,"limit",(()=>Em)),e(r.exports,"limitToLast",(()=>Tm)),e(r.exports,"QueryStartAtConstraint",(()=>Sm)),e(r.exports,"startAt",(()=>xm)),e(r.exports,"startAfter",(()=>Cm)),e(r.exports,"QueryEndAtConstraint",(()=>Dm)),e(r.exports,"endBefore",(()=>Am)),e(r.exports,"endAt",(()=>Nm)),e(r.exports,"AbstractUserDataWriter",(()=>Pm)),e(r.exports,"sum",(()=>qm)),e(r.exports,"average",(()=>Bm)),e(r.exports,"count",(()=>Um)),e(r.exports,"aggregateFieldEqual",(()=>zm)),e(r.exports,"aggregateQuerySnapshotEqual",(()=>Gm)),e(r.exports,"SnapshotMetadata",(()=>jm)),e(r.exports,"DocumentSnapshot",(()=>Km)),e(r.exports,"QueryDocumentSnapshot",(()=>$m)),e(r.exports,"QuerySnapshot",(()=>Qm)),e(r.exports,"snapshotEqual",(()=>Wm)),e(r.exports,"getDoc",(()=>Ym)),e(r.exports,"getDocFromCache",(()=>Jm)),e(r.exports,"getDocFromServer",(()=>Zm)),e(r.exports,"getDocs",(()=>tp)),e(r.exports,"getDocsFromCache",(()=>ep)),e(r.exports,"getDocsFromServer",(()=>np)),e(r.exports,"setDoc",(()=>rp)),e(r.exports,"executeWrite",(()=>cp)),e(r.exports,"updateDoc",(()=>sp)),e(r.exports,"deleteDoc",(()=>ip)),e(r.exports,"addDoc",(()=>op)),e(r.exports,"onSnapshot",(()=>ap)),e(r.exports,"onSnapshotsInSync",(()=>up)),e(r.exports,"getCountFromServer",(()=>hp)),e(r.exports,"getAggregateFromServer",(()=>dp)),e(r.exports,"persistentSingleTabManager",(()=>Ep)),e(r.exports,"memoryEagerGarbageCollector",(()=>yp)),e(r.exports,"memoryLruGarbageCollector",(()=>wp)),e(r.exports,"memoryLocalCache",(()=>vp)),e(r.exports,"persistentLocalCache",(()=>bp)),e(r.exports,"persistentMultipleTabManager",(()=>Tp)),e(r.exports,"WriteBatch",(()=>xp)),e(r.exports,"Transaction",(()=>Dp)),e(r.exports,"runTransaction",(()=>Ap)),e(r.exports,"deleteField",(()=>Np)),e(r.exports,"serverTimestamp",(()=>kp)),e(r.exports,"arrayUnion",(()=>Rp)),e(r.exports,"arrayRemove",(()=>Mp)),e(r.exports,"increment",(()=>Lp)),e(r.exports,"writeBatch",(()=>Op)),e(r.exports,"setIndexConfiguration",(()=>Pp)),e(r.exports,"PersistentCacheIndexManager",(()=>Vp)),e(r.exports,"getPersistentCacheIndexManager",(()=>qp)),e(r.exports,"enablePersistentCacheIndexAutoCreation",(()=>Bp)),e(r.exports,"disablePersistentCacheIndexAutoCreation",(()=>Up)),e(r.exports,"deleteAllPersistentCacheIndexes",(()=>zp)),e(r.exports,"_TestingHooks",(()=>Kp));var i=n("1wlTY"),o=n("6kwV5");const a=function(t){const e=[];let n=0;for(let r=0;r<t.length;r++){let s=t.charCodeAt(r);s<128?e[n++]=s:s<2048?(e[n++]=s>>6|192,e[n++]=63&s|128):55296==(64512&s)&&r+1<t.length&&56320==(64512&t.charCodeAt(r+1))?(s=65536+((1023&s)<<10)+(1023&t.charCodeAt(++r)),e[n++]=s>>18|240,e[n++]=s>>12&63|128,e[n++]=s>>6&63|128,e[n++]=63&s|128):(e[n++]=s>>12|224,e[n++]=s>>6&63|128,e[n++]=63&s|128)}return e},u={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(t,e){if(!Array.isArray(t))throw Error("encodeByteArray takes an array as a parameter");this.init_();const n=e?this.byteToCharMapWebSafe_:this.byteToCharMap_,r=[];for(let e=0;e<t.length;e+=3){const s=t[e],i=e+1<t.length,o=i?t[e+1]:0,a=e+2<t.length,u=a?t[e+2]:0,c=s>>2,l=(3&s)<<4|o>>4;let h=(15&o)<<2|u>>6,d=63&u;a||(d=64,i||(h=64)),r.push(n[c],n[l],n[h],n[d])}return r.join("")},encodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?btoa(t):this.encodeByteArray(a(t),e)},decodeString(t,e){return this.HAS_NATIVE_SUPPORT&&!e?atob(t):function(t){const e=[];let n=0,r=0;for(;n<t.length;){const s=t[n++];if(s<128)e[r++]=String.fromCharCode(s);else if(s>191&&s<224){const i=t[n++];e[r++]=String.fromCharCode((31&s)<<6|63&i)}else if(s>239&&s<365){const i=((7&s)<<18|(63&t[n++])<<12|(63&t[n++])<<6|63&t[n++])-65536;e[r++]=String.fromCharCode(55296+(i>>10)),e[r++]=String.fromCharCode(56320+(1023&i))}else{const i=t[n++],o=t[n++];e[r++]=String.fromCharCode((15&s)<<12|(63&i)<<6|63&o)}}return e.join("")}(this.decodeStringToByteArray(t,e))},decodeStringToByteArray(t,e){this.init_();const n=e?this.charToByteMapWebSafe_:this.charToByteMap_,r=[];for(let e=0;e<t.length;){const s=n[t.charAt(e++)],i=e<t.length?n[t.charAt(e)]:0;++e;const o=e<t.length?n[t.charAt(e)]:64;++e;const a=e<t.length?n[t.charAt(e)]:64;if(++e,null==s||null==i||null==o||null==a)throw new c;const u=s<<2|i>>4;if(r.push(u),64!==o){const t=i<<4&240|o>>2;if(r.push(t),64!==a){const t=o<<6&192|a;r.push(t)}}}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let t=0;t<this.ENCODED_VALS.length;t++)this.byteToCharMap_[t]=this.ENCODED_VALS.charAt(t),this.charToByteMap_[this.byteToCharMap_[t]]=t,this.byteToCharMapWebSafe_[t]=this.ENCODED_VALS_WEBSAFE.charAt(t),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[t]]=t,t>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(t)]=t,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(t)]=t)}}};class c extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const l=function(t){return function(t){const e=a(t);return u.encodeByteArray(e,!0)}(t).replace(/\./g,"")},h=()=>{try{return function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==t)return t;throw new Error("Unable to locate global object.")}().__FIREBASE_DEFAULTS__||(()=>{if(void 0===o||void 0===o.env)return})()||(()=>{if("undefined"==typeof document)return;let t;try{t=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch(t){return}const e=t&&function(t){try{return u.decodeString(t,!0)}catch(t){console.error("base64Decode failed: ",t)}return null}(t[1]);return e&&JSON.parse(e)})()}catch(t){return void console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${t}`)}};function d(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}function f(){return!function(){var e;const n=null===(e=h())||void 0===e?void 0:e.forceEnvironment;if("node"===n)return!0;if("browser"===n)return!1;try{return"[object process]"===Object.prototype.toString.call(t.process)}catch(t){return!1}}()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}class g extends Error{constructor(t,e,n){super(e),this.code=t,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,g.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,m.prototype.create)}}class m{constructor(t,e,n){this.service=t,this.serviceName=e,this.errors=n}create(t,...e){const n=e[0]||{},r=`${this.service}/${t}`,s=this.errors[t],i=s?function(t,e){return t.replace(p,((t,n)=>{const r=e[n];return null!=r?String(r):`<${n}?>`}))}(s,n):"Error",o=`${this.serviceName}: ${i} (${r}).`;return new g(r,o,n)}}const p=/\{\$([^}]+)}/g;function y(t,e){if(t===e)return!0;const n=Object.keys(t),r=Object.keys(e);for(const s of n){if(!r.includes(s))return!1;const n=t[s],i=e[s];if(w(n)&&w(i)){if(!y(n,i))return!1}else if(n!==i)return!1}for(const t of r)if(!n.includes(t))return!1;return!0}function w(t){return null!==t&&"object"==typeof t}function v(t){return t&&t._delegate?t._delegate:t}class b{constructor(t,e,n){this.name=t,this.instanceFactory=e,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(t){return this.instantiationMode=t,this}setMultipleInstances(t){return this.multipleInstances=t,this}setServiceProps(t){return this.serviceProps=t,this}setInstanceCreatedCallback(t){return this.onInstanceCreated=t,this}}var _,I;(I=_||(_={}))[I.DEBUG=0]="DEBUG",I[I.VERBOSE=1]="VERBOSE",I[I.INFO=2]="INFO",I[I.WARN=3]="WARN",I[I.ERROR=4]="ERROR",I[I.SILENT=5]="SILENT";const E={debug:_.DEBUG,verbose:_.VERBOSE,info:_.INFO,warn:_.WARN,error:_.ERROR,silent:_.SILENT},T=_.INFO,S={[_.DEBUG]:"log",[_.VERBOSE]:"log",[_.INFO]:"info",[_.WARN]:"warn",[_.ERROR]:"error"},x=(t,e,...n)=>{if(e<t.logLevel)return;const r=(new Date).toISOString(),s=S[e];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${e})`);console[s](`[${r}]  ${t.name}:`,...n)};var C,D="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==t?t:"undefined"!=typeof self?self:{},A=A||{},N=D||self;function k(t){var e=typeof t;return"array"==(e="object"!=e?e:t?Array.isArray(t)?"array":e:"null")||"object"==e&&"number"==typeof t.length}function R(t){var e=typeof t;return"object"==e&&null!=t||"function"==e}Math.random();function M(t,e,n){return t.call.apply(t.bind,arguments)}function L(t,e,n){if(!t)throw Error();if(2<arguments.length){var r=Array.prototype.slice.call(arguments,2);return function(){var n=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(n,r),t.apply(e,n)}}return function(){return t.apply(e,arguments)}}function O(t,e,n){return(O=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?M:L).apply(null,arguments)}function P(t,e){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function F(t,e){function n(){}n.prototype=e.prototype,t.$=e.prototype,t.prototype=new n,t.prototype.constructor=t,t.ac=function(t,n,r){for(var s=Array(arguments.length-2),i=2;i<arguments.length;i++)s[i-2]=arguments[i];return e.prototype[n].apply(t,s)}}function V(){this.s=this.s,this.o=this.o}V.prototype.s=!1,V.prototype.sa=function(){!this.s&&(this.s=!0,this.N())},V.prototype.N=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const q=Array.prototype.indexOf?function(t,e){return Array.prototype.indexOf.call(t,e,void 0)}:function(t,e){if("string"==typeof t)return"string"!=typeof e||1!=e.length?-1:t.indexOf(e,0);for(let n=0;n<t.length;n++)if(n in t&&t[n]===e)return n;return-1};function B(t){const e=t.length;if(0<e){const n=Array(e);for(let r=0;r<e;r++)n[r]=t[r];return n}return[]}function U(t,e){for(let e=1;e<arguments.length;e++){const n=arguments[e];if(k(n)){const e=t.length||0,r=n.length||0;t.length=e+r;for(let s=0;s<r;s++)t[e+s]=n[s]}else t.push(n)}}function z(t,e){this.type=t,this.g=this.target=e,this.defaultPrevented=!1}z.prototype.h=function(){this.defaultPrevented=!0};var G=function(){if(!N.addEventListener||!Object.defineProperty)return!1;var t=!1,e=Object.defineProperty({},"passive",{get:function(){t=!0}});try{const t=()=>{};N.addEventListener("test",t,e),N.removeEventListener("test",t,e)}catch(t){}return t}();function j(t){return/^[\s\xa0]*$/.test(t)}function K(){var t=N.navigator;return t&&(t=t.userAgent)?t:""}function $(t){return-1!=K().indexOf(t)}function Q(t){return Q[" "](t),t}Q[" "]=function(){};var H,W,Y,X=$("Opera"),J=$("Trident")||$("MSIE"),Z=$("Edge"),tt=Z||J,et=$("Gecko")&&!(-1!=K().toLowerCase().indexOf("webkit")&&!$("Edge"))&&!($("Trident")||$("MSIE"))&&!$("Edge"),nt=-1!=K().toLowerCase().indexOf("webkit")&&!$("Edge");function rt(){var t=N.document;return t?t.documentMode:void 0}t:{var st="",it=(W=K(),et?/rv:([^\);]+)(\)|;)/.exec(W):Z?/Edge\/([\d\.]+)/.exec(W):J?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(W):nt?/WebKit\/(\S+)/.exec(W):X?/(?:Version)[ \/]?(\S+)/.exec(W):void 0);if(it&&(st=it?it[1]:""),J){var ot=rt();if(null!=ot&&ot>parseFloat(st)){H=String(ot);break t}}H=st}N.document&&J?Y=rt()||parseInt(H,10)||void 0:Y=void 0;var at=Y;function ut(t,e){if(z.call(this,t?t.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,t){var n=this.type=t.type,r=t.changedTouches&&t.changedTouches.length?t.changedTouches[0]:null;if(this.target=t.target||t.srcElement,this.g=e,e=t.relatedTarget){if(et){t:{try{Q(e.nodeName);var s=!0;break t}catch(t){}s=!1}s||(e=null)}}else"mouseover"==n?e=t.fromElement:"mouseout"==n&&(e=t.toElement);this.relatedTarget=e,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==t.clientX?t.clientX:t.pageX,this.clientY=void 0!==t.clientY?t.clientY:t.pageY,this.screenX=t.screenX||0,this.screenY=t.screenY||0),this.button=t.button,this.key=t.key||"",this.ctrlKey=t.ctrlKey,this.altKey=t.altKey,this.shiftKey=t.shiftKey,this.metaKey=t.metaKey,this.pointerId=t.pointerId||0,this.pointerType="string"==typeof t.pointerType?t.pointerType:ct[t.pointerType]||"",this.state=t.state,this.i=t,t.defaultPrevented&&ut.$.h.call(this)}}F(ut,z);var ct={2:"touch",3:"pen",4:"mouse"};ut.prototype.h=function(){ut.$.h.call(this);var t=this.i;t.preventDefault?t.preventDefault():t.returnValue=!1};var lt="closure_listenable_"+(1e6*Math.random()|0),ht=0;function dt(t,e,n,r,s){this.listener=t,this.proxy=null,this.src=e,this.type=n,this.capture=!!r,this.la=s,this.key=++ht,this.fa=this.ia=!1}function ft(t){t.fa=!0,t.listener=null,t.proxy=null,t.src=null,t.la=null}function gt(t,e,n){for(const r in t)e.call(n,t[r],r,t)}function mt(t){const e={};for(const n in t)e[n]=t[n];return e}const pt="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function yt(t,e){let n,r;for(let e=1;e<arguments.length;e++){for(n in r=arguments[e],r)t[n]=r[n];for(let e=0;e<pt.length;e++)n=pt[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function wt(t){this.src=t,this.g={},this.h=0}function vt(t,e){var n=e.type;if(n in t.g){var r,s=t.g[n],i=q(s,e);(r=0<=i)&&Array.prototype.splice.call(s,i,1),r&&(ft(e),0==t.g[n].length&&(delete t.g[n],t.h--))}}function bt(t,e,n,r){for(var s=0;s<t.length;++s){var i=t[s];if(!i.fa&&i.listener==e&&i.capture==!!n&&i.la==r)return s}return-1}wt.prototype.add=function(t,e,n,r,s){var i=t.toString();(t=this.g[i])||(t=this.g[i]=[],this.h++);var o=bt(t,e,r,s);return-1<o?(e=t[o],n||(e.ia=!1)):((e=new dt(e,this.src,i,!!r,s)).ia=n,t.push(e)),e};var _t="closure_lm_"+(1e6*Math.random()|0),It={};function Et(t,e,n,r,s){if(r&&r.once)return St(t,e,n,r,s);if(Array.isArray(e)){for(var i=0;i<e.length;i++)Et(t,e[i],n,r,s);return null}return n=Rt(n),t&&t[lt]?t.O(e,n,R(r)?!!r.capture:!!r,s):Tt(t,e,n,!1,r,s)}function Tt(t,e,n,r,s,i){if(!e)throw Error("Invalid event type");var o=R(s)?!!s.capture:!!s,a=Nt(t);if(a||(t[_t]=a=new wt(t)),(n=a.add(e,n,r,o,i)).proxy)return n;if(r=function(){const t=At;return function e(n){return t.call(e.src,e.listener,n)}}(),n.proxy=r,r.src=t,r.listener=n,t.addEventListener)G||(s=o),void 0===s&&(s=!1),t.addEventListener(e.toString(),r,s);else if(t.attachEvent)t.attachEvent(Dt(e.toString()),r);else{if(!t.addListener||!t.removeListener)throw Error("addEventListener and attachEvent are unavailable.");t.addListener(r)}return n}function St(t,e,n,r,s){if(Array.isArray(e)){for(var i=0;i<e.length;i++)St(t,e[i],n,r,s);return null}return n=Rt(n),t&&t[lt]?t.P(e,n,R(r)?!!r.capture:!!r,s):Tt(t,e,n,!0,r,s)}function xt(t,e,n,r,s){if(Array.isArray(e))for(var i=0;i<e.length;i++)xt(t,e[i],n,r,s);else r=R(r)?!!r.capture:!!r,n=Rt(n),t&&t[lt]?(t=t.i,(e=String(e).toString())in t.g&&-1<(n=bt(i=t.g[e],n,r,s))&&(ft(i[n]),Array.prototype.splice.call(i,n,1),0==i.length&&(delete t.g[e],t.h--))):t&&(t=Nt(t))&&(e=t.g[e.toString()],t=-1,e&&(t=bt(e,n,r,s)),(n=-1<t?e[t]:null)&&Ct(n))}function Ct(t){if("number"!=typeof t&&t&&!t.fa){var e=t.src;if(e&&e[lt])vt(e.i,t);else{var n=t.type,r=t.proxy;e.removeEventListener?e.removeEventListener(n,r,t.capture):e.detachEvent?e.detachEvent(Dt(n),r):e.addListener&&e.removeListener&&e.removeListener(r),(n=Nt(e))?(vt(n,t),0==n.h&&(n.src=null,e[_t]=null)):ft(t)}}}function Dt(t){return t in It?It[t]:It[t]="on"+t}function At(t,e){if(t.fa)t=!0;else{e=new ut(e,this);var n=t.listener,r=t.la||t.src;t.ia&&Ct(t),t=n.call(r,e)}return t}function Nt(t){return(t=t[_t])instanceof wt?t:null}var kt="__closure_events_fn_"+(1e9*Math.random()>>>0);function Rt(t){return"function"==typeof t?t:(t[kt]||(t[kt]=function(e){return t.handleEvent(e)}),t[kt])}function Mt(){V.call(this),this.i=new wt(this),this.S=this,this.J=null}function Lt(t,e){var n,r=t.J;if(r)for(n=[];r;r=r.J)n.push(r);if(t=t.S,r=e.type||e,"string"==typeof e)e=new z(e,t);else if(e instanceof z)e.target=e.target||t;else{var s=e;yt(e=new z(r,t),s)}if(s=!0,n)for(var i=n.length-1;0<=i;i--){var o=e.g=n[i];s=Ot(o,r,!0,e)&&s}if(s=Ot(o=e.g=t,r,!0,e)&&s,s=Ot(o,r,!1,e)&&s,n)for(i=0;i<n.length;i++)s=Ot(o=e.g=n[i],r,!1,e)&&s}function Ot(t,e,n,r){if(!(e=t.i.g[String(e)]))return!0;e=e.concat();for(var s=!0,i=0;i<e.length;++i){var o=e[i];if(o&&!o.fa&&o.capture==n){var a=o.listener,u=o.la||o.src;o.ia&&vt(t.i,o),s=!1!==a.call(u,r)&&s}}return s&&!r.defaultPrevented}F(Mt,V),Mt.prototype[lt]=!0,Mt.prototype.removeEventListener=function(t,e,n,r){xt(this,t,e,n,r)},Mt.prototype.N=function(){if(Mt.$.N.call(this),this.i){var t,e=this.i;for(t in e.g){for(var n=e.g[t],r=0;r<n.length;r++)ft(n[r]);delete e.g[t],e.h--}}this.J=null},Mt.prototype.O=function(t,e,n,r){return this.i.add(String(t),e,!1,n,r)},Mt.prototype.P=function(t,e,n,r){return this.i.add(String(t),e,!0,n,r)};var Pt=N.JSON.stringify;function Ft(){var t=jt;let e=null;return t.g&&(e=t.g,t.g=t.g.next,t.g||(t.h=null),e.next=null),e}var Vt=new class{constructor(t,e){this.i=t,this.j=e,this.h=0,this.g=null}get(){let t;return 0<this.h?(this.h--,t=this.g,this.g=t.next,t.next=null):t=this.i(),t}}((()=>new qt),(t=>t.reset()));class qt{constructor(){this.next=this.g=this.h=null}set(t,e){this.h=t,this.g=e,this.next=null}reset(){this.next=this.g=this.h=null}}function Bt(t){var e=1;t=t.split(":");const n=[];for(;0<e&&t.length;)n.push(t.shift()),e--;return t.length&&n.push(t.join(":")),n}function Ut(t){N.setTimeout((()=>{throw t}),0)}let zt,Gt=!1,jt=new class{constructor(){this.h=this.g=null}add(t,e){const n=Vt.get();n.set(t,e),this.h?this.h.next=n:this.g=n,this.h=n}},Kt=()=>{const t=N.Promise.resolve(void 0);zt=()=>{t.then($t)}};var $t=()=>{for(var t;t=Ft();){try{t.h.call(t.g)}catch(t){Ut(t)}var e=Vt;e.j(t),100>e.h&&(e.h++,t.next=e.g,e.g=t)}Gt=!1};function Qt(t,e){Mt.call(this),this.h=t||1,this.g=e||N,this.j=O(this.qb,this),this.l=Date.now()}function Ht(t){t.ga=!1,t.T&&(t.g.clearTimeout(t.T),t.T=null)}function Wt(t,e,n){if("function"==typeof t)n&&(t=O(t,n));else{if(!t||"function"!=typeof t.handleEvent)throw Error("Invalid listener argument");t=O(t.handleEvent,t)}return 2147483647<Number(e)?-1:N.setTimeout(t,e||0)}function Yt(t){t.g=Wt((()=>{t.g=null,t.i&&(t.i=!1,Yt(t))}),t.j);const e=t.h;t.h=null,t.m.apply(null,e)}F(Qt,Mt),(C=Qt.prototype).ga=!1,C.T=null,C.qb=function(){if(this.ga){var t=Date.now()-this.l;0<t&&t<.8*this.h?this.T=this.g.setTimeout(this.j,this.h-t):(this.T&&(this.g.clearTimeout(this.T),this.T=null),Lt(this,"tick"),this.ga&&(Ht(this),this.start()))}},C.start=function(){this.ga=!0,this.T||(this.T=this.g.setTimeout(this.j,this.h),this.l=Date.now())},C.N=function(){Qt.$.N.call(this),Ht(this),delete this.g};class Xt extends V{constructor(t,e){super(),this.m=t,this.j=e,this.h=null,this.i=!1,this.g=null}l(t){this.h=arguments,this.g?this.i=!0:Yt(this)}N(){super.N(),this.g&&(N.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Jt(t){V.call(this),this.h=t,this.g={}}F(Jt,V);var Zt=[];function te(t,e,n,r){Array.isArray(n)||(n&&(Zt[0]=n.toString()),n=Zt);for(var s=0;s<n.length;s++){var i=Et(e,n[s],r||t.handleEvent,!1,t.h||t);if(!i)break;t.g[i.key]=i}}function ee(t){gt(t.g,(function(t,e){this.g.hasOwnProperty(e)&&Ct(t)}),t),t.g={}}function ne(){this.g=!0}function re(t,e,n,r){t.info((function(){return"XMLHTTP TEXT ("+e+"): "+function(t,e){if(!t.g)return e;if(!e)return null;try{var n=JSON.parse(e);if(n)for(t=0;t<n.length;t++)if(Array.isArray(n[t])){var r=n[t];if(!(2>r.length)){var s=r[1];if(Array.isArray(s)&&!(1>s.length)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var o=1;o<s.length;o++)s[o]=""}}}return Pt(n)}catch(t){return e}}(t,n)+(r?" "+r:"")}))}Jt.prototype.N=function(){Jt.$.N.call(this),ee(this)},Jt.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},ne.prototype.Ea=function(){this.g=!1},ne.prototype.info=function(){};var se={},ie=null;function oe(){return ie=ie||new Mt}function ae(t){z.call(this,se.Ta,t)}function ue(t){const e=oe();Lt(e,new ae(e))}function ce(t,e){z.call(this,se.STAT_EVENT,t),this.stat=e}function le(t){const e=oe();Lt(e,new ce(e,t))}function he(t,e){z.call(this,se.Ua,t),this.size=e}function de(t,e){if("function"!=typeof t)throw Error("Fn must not be null and must be a function");return N.setTimeout((function(){t()}),e)}se.Ta="serverreachability",F(ae,z),se.STAT_EVENT="statevent",F(ce,z),se.Ua="timingevent",F(he,z);var fe={NO_ERROR:0,rb:1,Eb:2,Db:3,yb:4,Cb:5,Fb:6,Qa:7,TIMEOUT:8,Ib:9},ge={wb:"complete",Sb:"success",Ra:"error",Qa:"abort",Kb:"ready",Lb:"readystatechange",TIMEOUT:"timeout",Gb:"incrementaldata",Jb:"progress",zb:"downloadprogress",$b:"uploadprogress"};function me(){}function pe(t){return t.h||(t.h=t.i())}function ye(){}me.prototype.h=null;var we,ve={OPEN:"a",vb:"b",Ra:"c",Hb:"d"};function be(){z.call(this,"d")}function _e(){z.call(this,"c")}function Ie(){}function Ee(t,e,n,r){this.l=t,this.j=e,this.m=n,this.W=r||1,this.U=new Jt(this),this.P=Se,t=tt?125:void 0,this.V=new Qt(t),this.I=null,this.i=!1,this.u=this.B=this.A=this.L=this.G=this.Y=this.C=null,this.F=[],this.g=null,this.o=0,this.s=this.v=null,this.ca=-1,this.J=!1,this.O=0,this.M=null,this.ba=this.K=this.aa=this.S=!1,this.h=new Te}function Te(){this.i=null,this.g="",this.h=!1}F(be,z),F(_e,z),F(Ie,me),Ie.prototype.g=function(){return new XMLHttpRequest},Ie.prototype.i=function(){return{}},we=new Ie;var Se=45e3,xe={},Ce={};function De(t,e,n){t.L=1,t.A=Qe(ze(e)),t.u=n,t.S=!0,Ae(t,null)}function Ae(t,e){t.G=Date.now(),Me(t),t.B=ze(t.A);var n=t.B,r=t.W;Array.isArray(r)||(r=[String(r)]),an(n.i,"t",r),t.o=0,n=t.l.J,t.h=new Te,t.g=ir(t.l,n?e:null,!t.u),0<t.O&&(t.M=new Xt(O(t.Pa,t,t.g),t.O)),te(t.U,t.g,"readystatechange",t.nb),e=t.I?mt(t.I):{},t.u?(t.v||(t.v="POST"),e["Content-Type"]="application/x-www-form-urlencoded",t.g.ha(t.B,t.v,t.u,e)):(t.v="GET",t.g.ha(t.B,t.v,null,e)),ue(),function(t,e,n,r,s,i){t.info((function(){if(t.g)if(i)for(var o="",a=i.split("&"),u=0;u<a.length;u++){var c=a[u].split("=");if(1<c.length){var l=c[0];c=c[1];var h=l.split("_");o=2<=h.length&&"type"==h[1]?o+(l+"=")+c+"&":o+(l+"=redacted&")}}else o=null;else o=i;return"XMLHTTP REQ ("+r+") [attempt "+s+"]: "+e+"\n"+n+"\n"+o}))}(t.j,t.v,t.B,t.m,t.W,t.u)}function Ne(t){return!!t.g&&"GET"==t.v&&2!=t.L&&t.l.Ha}function ke(t,e,n){let r,s=!0;for(;!t.J&&t.o<n.length;){if(r=Re(t,n),r==Ce){4==e&&(t.s=4,le(14),s=!1),re(t.j,t.m,null,"[Incomplete Response]");break}if(r==xe){t.s=4,le(15),re(t.j,t.m,n,"[Invalid Chunk]"),s=!1;break}re(t.j,t.m,r,null),Ve(t,r)}Ne(t)&&0!=t.o&&(t.h.g=t.h.g.slice(t.o),t.o=0),4!=e||0!=n.length||t.h.h||(t.s=1,le(16),s=!1),t.i=t.i&&s,s?0<n.length&&!t.ba&&(t.ba=!0,(e=t.l).g==t&&e.ca&&!e.M&&(e.l.info("Great, no buffering proxy detected. Bytes received: "+n.length),Xn(e),e.M=!0,le(11))):(re(t.j,t.m,n,"[Invalid Chunked Response]"),Fe(t),Pe(t))}function Re(t,e){var n=t.o,r=e.indexOf("\n",n);return-1==r?Ce:(n=Number(e.substring(n,r)),isNaN(n)?xe:(r+=1)+n>e.length?Ce:(e=e.slice(r,r+n),t.o=r+n,e))}function Me(t){t.Y=Date.now()+t.P,Le(t,t.P)}function Le(t,e){if(null!=t.C)throw Error("WatchDog timer not null");t.C=de(O(t.lb,t),e)}function Oe(t){t.C&&(N.clearTimeout(t.C),t.C=null)}function Pe(t){0==t.l.H||t.J||tr(t.l,t)}function Fe(t){Oe(t);var e=t.M;e&&"function"==typeof e.sa&&e.sa(),t.M=null,Ht(t.V),ee(t.U),t.g&&(e=t.g,t.g=null,e.abort(),e.sa())}function Ve(t,e){try{var n=t.l;if(0!=n.H&&(n.g==t||fn(n.i,t)))if(!t.K&&fn(n.i,t)&&3==n.H){try{var r=n.Ja.g.parse(e)}catch(t){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){t:if(!n.u){if(n.g){if(!(n.g.G+3e3<t.G))break t;Zn(n),Gn(n)}Yn(n),le(18)}}else n.Fa=s[1],0<n.Fa-n.V&&37500>s[2]&&n.G&&0==n.A&&!n.v&&(n.v=de(O(n.ib,n),6e3));if(1>=dn(n.i)&&n.oa){try{n.oa()}catch(t){}n.oa=void 0}}else nr(n,11)}else if((t.K||n.g==t)&&Zn(n),!j(e))for(s=n.Ja.g.parse(e),e=0;e<s.length;e++){let c=s[e];if(n.V=c[0],c=c[1],2==n.H)if("c"==c[0]){n.K=c[1],n.pa=c[2];const e=c[3];null!=e&&(n.ra=e,n.l.info("VER="+n.ra));const s=c[4];null!=s&&(n.Ga=s,n.l.info("SVER="+n.Ga));const l=c[5];null!=l&&"number"==typeof l&&0<l&&(r=1.5*l,n.L=r,n.l.info("backChannelRequestTimeoutMs_="+r)),r=n;const h=t.g;if(h){const t=h.g?h.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(t){var i=r.i;i.g||-1==t.indexOf("spdy")&&-1==t.indexOf("quic")&&-1==t.indexOf("h2")||(i.j=i.l,i.g=new Set,i.h&&(gn(i,i.h),i.h=null))}if(r.F){const t=h.g?h.g.getResponseHeader("X-HTTP-Session-Id"):null;t&&(r.Da=t,$e(r.I,r.F,t))}}n.H=3,n.h&&n.h.Ba(),n.ca&&(n.S=Date.now()-t.G,n.l.info("Handshake RTT: "+n.S+"ms"));var o=t;if((r=n).wa=sr(r,r.J?r.pa:null,r.Y),o.K){mn(r.i,o);var a=o,u=r.L;u&&a.setTimeout(u),a.C&&(Oe(a),Me(a)),r.g=o}else Wn(r);0<n.j.length&&Kn(n)}else"stop"!=c[0]&&"close"!=c[0]||nr(n,7);else 3==n.H&&("stop"==c[0]||"close"==c[0]?"stop"==c[0]?nr(n,7):zn(n):"noop"!=c[0]&&n.h&&n.h.Aa(c),n.A=0)}ue()}catch(t){}}function qe(t,e){if(t.forEach&&"function"==typeof t.forEach)t.forEach(e,void 0);else if(k(t)||"string"==typeof t)Array.prototype.forEach.call(t,e,void 0);else for(var n=function(t){if(t.ta&&"function"==typeof t.ta)return t.ta();if(!t.Z||"function"!=typeof t.Z){if("undefined"!=typeof Map&&t instanceof Map)return Array.from(t.keys());if(!("undefined"!=typeof Set&&t instanceof Set)){if(k(t)||"string"==typeof t){var e=[];t=t.length;for(var n=0;n<t;n++)e.push(n);return e}e=[],n=0;for(const r in t)e[n++]=r;return e}}}(t),r=function(t){if(t.Z&&"function"==typeof t.Z)return t.Z();if("undefined"!=typeof Map&&t instanceof Map||"undefined"!=typeof Set&&t instanceof Set)return Array.from(t.values());if("string"==typeof t)return t.split("");if(k(t)){for(var e=[],n=t.length,r=0;r<n;r++)e.push(t[r]);return e}for(r in e=[],n=0,t)e[n++]=t[r];return e}(t),s=r.length,i=0;i<s;i++)e.call(void 0,r[i],n&&n[i],t)}(C=Ee.prototype).setTimeout=function(t){this.P=t},C.nb=function(t){t=t.target;const e=this.M;e&&3==Pn(t)?e.l():this.Pa(t)},C.Pa=function(t){try{if(t==this.g)t:{const l=Pn(this.g);var e=this.g.Ia();if(this.g.da(),!(3>l)&&(3!=l||tt||this.g&&(this.h.h||this.g.ja()||Fn(this.g)))){this.J||4!=l||7==e||ue(),Oe(this);var n=this.g.da();this.ca=n;e:if(Ne(this)){var r=Fn(this.g);t="";var s=r.length,i=4==Pn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){Fe(this),Pe(this);var o="";break e}this.h.i=new N.TextDecoder}for(e=0;e<s;e++)this.h.h=!0,t+=this.h.i.decode(r[e],{stream:i&&e==s-1});r.length=0,this.h.g+=t,this.o=0,o=this.h.g}else o=this.g.ja();if(this.i=200==n,function(t,e,n,r,s,i,o){t.info((function(){return"XMLHTTP RESP ("+r+") [ attempt "+s+"]: "+e+"\n"+n+"\n"+i+" "+o}))}(this.j,this.v,this.B,this.m,this.W,l,n),this.i){if(this.aa&&!this.K){e:{if(this.g){var a,u=this.g;if((a=u.g?u.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!j(a)){var c=a;break e}}c=null}if(!(n=c)){this.i=!1,this.s=3,le(12),Fe(this),Pe(this);break t}re(this.j,this.m,n,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,Ve(this,n)}this.S?(ke(this,l,o),tt&&this.i&&3==l&&(te(this.U,this.V,"tick",this.mb),this.V.start())):(re(this.j,this.m,o,null),Ve(this,o)),4==l&&Fe(this),this.i&&!this.J&&(4==l?tr(this.l,this):(this.i=!1,Me(this)))}else(function(t){const e={};t=(t.g&&2<=Pn(t)&&t.g.getAllResponseHeaders()||"").split("\r\n");for(let r=0;r<t.length;r++){if(j(t[r]))continue;var n=Bt(t[r]);const s=n[0];if("string"!=typeof(n=n[1]))continue;n=n.trim();const i=e[s]||[];e[s]=i,i.push(n)}!function(t,e){for(const n in t)e.call(void 0,t[n],n,t)}(e,(function(t){return t.join(", ")}))})(this.g),400==n&&0<o.indexOf("Unknown SID")?(this.s=3,le(12)):(this.s=0,le(13)),Fe(this),Pe(this)}}}catch(t){}},C.mb=function(){if(this.g){var t=Pn(this.g),e=this.g.ja();this.o<e.length&&(Oe(this),ke(this,t,e),this.i&&4!=t&&Me(this))}},C.cancel=function(){this.J=!0,Fe(this)},C.lb=function(){this.C=null;const t=Date.now();0<=t-this.Y?(function(t,e){t.info((function(){return"TIMEOUT: "+e}))}(this.j,this.B),2!=this.L&&(ue(),le(17)),Fe(this),this.s=2,Pe(this)):Le(this,this.Y-t)};var Be=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Ue(t){if(this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,t instanceof Ue){this.h=t.h,Ge(this,t.j),this.s=t.s,this.g=t.g,je(this,t.m),this.l=t.l;var e=t.i,n=new nn;n.i=e.i,e.g&&(n.g=new Map(e.g),n.h=e.h),Ke(this,n),this.o=t.o}else t&&(e=String(t).match(Be))?(this.h=!1,Ge(this,e[1]||"",!0),this.s=He(e[2]||""),this.g=He(e[3]||"",!0),je(this,e[4]),this.l=He(e[5]||"",!0),Ke(this,e[6]||"",!0),this.o=He(e[7]||"")):(this.h=!1,this.i=new nn(null,this.h))}function ze(t){return new Ue(t)}function Ge(t,e,n){t.j=n?He(e,!0):e,t.j&&(t.j=t.j.replace(/:$/,""))}function je(t,e){if(e){if(e=Number(e),isNaN(e)||0>e)throw Error("Bad port number "+e);t.m=e}else t.m=null}function Ke(t,e,n){e instanceof nn?(t.i=e,function(t,e){e&&!t.j&&(rn(t),t.i=null,t.g.forEach((function(t,e){var n=e.toLowerCase();e!=n&&(sn(this,e),an(this,n,t))}),t)),t.j=e}(t.i,t.h)):(n||(e=We(e,tn)),t.i=new nn(e,t.h))}function $e(t,e,n){t.i.set(e,n)}function Qe(t){return $e(t,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),t}function He(t,e){return t?e?decodeURI(t.replace(/%25/g,"%2525")):decodeURIComponent(t):""}function We(t,e,n){return"string"==typeof t?(t=encodeURI(t).replace(e,Ye),n&&(t=t.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),t):null}function Ye(t){return"%"+((t=t.charCodeAt(0))>>4&15).toString(16)+(15&t).toString(16)}Ue.prototype.toString=function(){var t=[],e=this.j;e&&t.push(We(e,Xe,!0),":");var n=this.g;return(n||"file"==e)&&(t.push("//"),(e=this.s)&&t.push(We(e,Xe,!0),"@"),t.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&t.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&t.push("/"),t.push(We(n,"/"==n.charAt(0)?Ze:Je,!0))),(n=this.i.toString())&&t.push("?",n),(n=this.o)&&t.push("#",We(n,en)),t.join("")};var Xe=/[#\/\?@]/g,Je=/[#\?:]/g,Ze=/[#\?]/g,tn=/[#\?@]/g,en=/#/g;function nn(t,e){this.h=this.g=null,this.i=t||null,this.j=!!e}function rn(t){t.g||(t.g=new Map,t.h=0,t.i&&function(t,e){if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r=t[n].indexOf("="),s=null;if(0<=r){var i=t[n].substring(0,r);s=t[n].substring(r+1)}else i=t[n];e(i,s?decodeURIComponent(s.replace(/\+/g," ")):"")}}}(t.i,(function(e,n){t.add(decodeURIComponent(e.replace(/\+/g," ")),n)})))}function sn(t,e){rn(t),e=un(t,e),t.g.has(e)&&(t.i=null,t.h-=t.g.get(e).length,t.g.delete(e))}function on(t,e){return rn(t),e=un(t,e),t.g.has(e)}function an(t,e,n){sn(t,e),0<n.length&&(t.i=null,t.g.set(un(t,e),B(n)),t.h+=n.length)}function un(t,e){return e=String(e),t.j&&(e=e.toLowerCase()),e}function cn(t){this.l=t||ln,t=N.PerformanceNavigationTiming?0<(t=N.performance.getEntriesByType("navigation")).length&&("hq"==t[0].nextHopProtocol||"h2"==t[0].nextHopProtocol):!!(N.g&&N.g.Ka&&N.g.Ka()&&N.g.Ka().dc),this.j=t?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}(C=nn.prototype).add=function(t,e){rn(this),this.i=null,t=un(this,t);var n=this.g.get(t);return n||this.g.set(t,n=[]),n.push(e),this.h+=1,this},C.forEach=function(t,e){rn(this),this.g.forEach((function(n,r){n.forEach((function(n){t.call(e,n,r,this)}),this)}),this)},C.ta=function(){rn(this);const t=Array.from(this.g.values()),e=Array.from(this.g.keys()),n=[];for(let r=0;r<e.length;r++){const s=t[r];for(let t=0;t<s.length;t++)n.push(e[r])}return n},C.Z=function(t){rn(this);let e=[];if("string"==typeof t)on(this,t)&&(e=e.concat(this.g.get(un(this,t))));else{t=Array.from(this.g.values());for(let n=0;n<t.length;n++)e=e.concat(t[n])}return e},C.set=function(t,e){return rn(this),this.i=null,on(this,t=un(this,t))&&(this.h-=this.g.get(t).length),this.g.set(t,[e]),this.h+=1,this},C.get=function(t,e){return t&&0<(t=this.Z(t)).length?String(t[0]):e},C.toString=function(){if(this.i)return this.i;if(!this.g)return"";const t=[],e=Array.from(this.g.keys());for(var n=0;n<e.length;n++){var r=e[n];const i=encodeURIComponent(String(r)),o=this.Z(r);for(r=0;r<o.length;r++){var s=i;""!==o[r]&&(s+="="+encodeURIComponent(String(o[r]))),t.push(s)}}return this.i=t.join("&")};var ln=10;function hn(t){return!!t.h||!!t.g&&t.g.size>=t.j}function dn(t){return t.h?1:t.g?t.g.size:0}function fn(t,e){return t.h?t.h==e:!!t.g&&t.g.has(e)}function gn(t,e){t.g?t.g.add(e):t.h=e}function mn(t,e){t.h&&t.h==e?t.h=null:t.g&&t.g.has(e)&&t.g.delete(e)}function pn(t){if(null!=t.h)return t.i.concat(t.h.F);if(null!=t.g&&0!==t.g.size){let e=t.i;for(const n of t.g.values())e=e.concat(n.F);return e}return B(t.i)}function yn(){this.g=new class{stringify(t){return N.JSON.stringify(t,void 0)}parse(t){return N.JSON.parse(t,void 0)}}}function wn(t,e,n){const r=n||"";try{qe(t,(function(t,n){let s=t;R(t)&&(s=Pt(t)),e.push(r+n+"="+encodeURIComponent(s))}))}catch(t){throw e.push(r+"type="+encodeURIComponent("_badmap")),t}}function vn(t,e,n,r,s){try{e.onload=null,e.onerror=null,e.onabort=null,e.ontimeout=null,s(r)}catch(t){}}function bn(t){this.l=t.ec||null,this.j=t.ob||!1}function _n(t,e){Mt.call(this),this.F=t,this.u=e,this.m=void 0,this.readyState=In,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}cn.prototype.cancel=function(){if(this.i=pn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const t of this.g.values())t.cancel();this.g.clear()}},F(bn,me),bn.prototype.g=function(){return new _n(this.l,this.j)},bn.prototype.i=function(t){return function(){return t}}({}),F(_n,Mt);var In=0;function En(t){t.j.read().then(t.Xa.bind(t)).catch(t.ka.bind(t))}function Tn(t){t.readyState=4,t.l=null,t.j=null,t.A=null,Sn(t)}function Sn(t){t.onreadystatechange&&t.onreadystatechange.call(t)}(C=_n.prototype).open=function(t,e){if(this.readyState!=In)throw this.abort(),Error("Error reopening a connection");this.C=t,this.B=e,this.readyState=1,Sn(this)},C.send=function(t){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const e={headers:this.v,method:this.C,credentials:this.m,cache:void 0};t&&(e.body=t),(this.F||N).fetch(new Request(this.B,e)).then(this.$a.bind(this),this.ka.bind(this))},C.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch((()=>{})),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,Tn(this)),this.readyState=In},C.$a=function(t){if(this.g&&(this.l=t,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=t.headers,this.readyState=2,Sn(this)),this.g&&(this.readyState=3,Sn(this),this.g)))if("arraybuffer"===this.responseType)t.arrayBuffer().then(this.Ya.bind(this),this.ka.bind(this));else if(void 0!==N.ReadableStream&&"body"in t){if(this.j=t.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;En(this)}else t.text().then(this.Za.bind(this),this.ka.bind(this))},C.Xa=function(t){if(this.g){if(this.u&&t.value)this.response.push(t.value);else if(!this.u){var e=t.value?t.value:new Uint8Array(0);(e=this.A.decode(e,{stream:!t.done}))&&(this.response=this.responseText+=e)}t.done?Tn(this):Sn(this),3==this.readyState&&En(this)}},C.Za=function(t){this.g&&(this.response=this.responseText=t,Tn(this))},C.Ya=function(t){this.g&&(this.response=t,Tn(this))},C.ka=function(){this.g&&Tn(this)},C.setRequestHeader=function(t,e){this.v.append(t,e)},C.getResponseHeader=function(t){return this.h&&this.h.get(t.toLowerCase())||""},C.getAllResponseHeaders=function(){if(!this.h)return"";const t=[],e=this.h.entries();for(var n=e.next();!n.done;)n=n.value,t.push(n[0]+": "+n[1]),n=e.next();return t.join("\r\n")},Object.defineProperty(_n.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(t){this.m=t?"include":"same-origin"}});var xn=N.JSON.parse;function Cn(t){Mt.call(this),this.headers=new Map,this.u=t||null,this.h=!1,this.C=this.g=null,this.I="",this.m=0,this.j="",this.l=this.G=this.v=this.F=!1,this.B=0,this.A=null,this.K=Dn,this.L=this.M=!1}F(Cn,Mt);var Dn="",An=/^https?$/i,Nn=["POST","PUT"];function kn(t,e){t.h=!1,t.g&&(t.l=!0,t.g.abort(),t.l=!1),t.j=e,t.m=5,Rn(t),Ln(t)}function Rn(t){t.F||(t.F=!0,Lt(t,"complete"),Lt(t,"error"))}function Mn(t){if(t.h&&void 0!==A&&(!t.C[1]||4!=Pn(t)||2!=t.da()))if(t.v&&4==Pn(t))Wt(t.La,0,t);else if(Lt(t,"readystatechange"),4==Pn(t)){t.h=!1;try{const o=t.da();t:switch(o){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var e=!0;break t;default:e=!1}var n;if(!(n=e)){var r;if(r=0===o){var s=String(t.I).match(Be)[1]||null;!s&&N.self&&N.self.location&&(s=N.self.location.protocol.slice(0,-1)),r=!An.test(s?s.toLowerCase():"")}n=r}if(n)Lt(t,"complete"),Lt(t,"success");else{t.m=6;try{var i=2<Pn(t)?t.g.statusText:""}catch(t){i=""}t.j=i+" ["+t.da()+"]",Rn(t)}}finally{Ln(t)}}}function Ln(t,e){if(t.g){On(t);const n=t.g,r=t.C[0]?()=>{}:null;t.g=null,t.C=null,e||Lt(t,"ready");try{n.onreadystatechange=r}catch(t){}}}function On(t){t.g&&t.L&&(t.g.ontimeout=null),t.A&&(N.clearTimeout(t.A),t.A=null)}function Pn(t){return t.g?t.g.readyState:0}function Fn(t){try{if(!t.g)return null;if("response"in t.g)return t.g.response;switch(t.K){case Dn:case"text":return t.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in t.g)return t.g.mozResponseArrayBuffer}return null}catch(t){return null}}function Vn(t){let e="";return gt(t,(function(t,n){e+=n,e+=":",e+=t,e+="\r\n"})),e}function qn(t,e,n){t:{for(r in n){var r=!1;break t}r=!0}r||(n=Vn(n),"string"==typeof t?null!=n&&encodeURIComponent(String(n)):$e(t,e,n))}function Bn(t,e,n){return n&&n.internalChannelParams&&n.internalChannelParams[t]||e}function Un(t){this.Ga=0,this.j=[],this.l=new ne,this.pa=this.wa=this.I=this.Y=this.g=this.Da=this.F=this.na=this.o=this.U=this.s=null,this.fb=this.W=0,this.cb=Bn("failFast",!1,t),this.G=this.v=this.u=this.m=this.h=null,this.aa=!0,this.Fa=this.V=-1,this.ba=this.A=this.C=0,this.ab=Bn("baseRetryDelayMs",5e3,t),this.hb=Bn("retryDelaySeedMs",1e4,t),this.eb=Bn("forwardChannelMaxRetries",2,t),this.xa=Bn("forwardChannelRequestTimeoutMs",2e4,t),this.va=t&&t.xmlHttpFactory||void 0,this.Ha=t&&t.useFetchStreams||!1,this.L=void 0,this.J=t&&t.supportsCrossDomainXhr||!1,this.K="",this.i=new cn(t&&t.concurrentRequestLimit),this.Ja=new yn,this.P=t&&t.fastHandshake||!1,this.O=t&&t.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.bb=t&&t.bc||!1,t&&t.Ea&&this.l.Ea(),t&&t.forceLongPolling&&(this.aa=!1),this.ca=!this.P&&this.aa&&t&&t.detectBufferingProxy||!1,this.qa=void 0,t&&t.longPollingTimeout&&0<t.longPollingTimeout&&(this.qa=t.longPollingTimeout),this.oa=void 0,this.S=0,this.M=!1,this.ma=this.B=null}function zn(t){if(jn(t),3==t.H){var e=t.W++,n=ze(t.I);if($e(n,"SID",t.K),$e(n,"RID",e),$e(n,"TYPE","terminate"),Qn(t,n),(e=new Ee(t,t.l,e)).L=2,e.A=Qe(ze(n)),n=!1,N.navigator&&N.navigator.sendBeacon)try{n=N.navigator.sendBeacon(e.A.toString(),"")}catch(t){}!n&&N.Image&&((new Image).src=e.A,n=!0),n||(e.g=ir(e.l,null),e.g.ha(e.A)),e.G=Date.now(),Me(e)}rr(t)}function Gn(t){t.g&&(Xn(t),t.g.cancel(),t.g=null)}function jn(t){Gn(t),t.u&&(N.clearTimeout(t.u),t.u=null),Zn(t),t.i.cancel(),t.m&&("number"==typeof t.m&&N.clearTimeout(t.m),t.m=null)}function Kn(t){if(!hn(t.i)&&!t.m){t.m=!0;var e=t.Na;zt||Kt(),Gt||(zt(),Gt=!0),jt.add(e,t),t.C=0}}function $n(t,e){var n;n=e?e.m:t.W++;const r=ze(t.I);$e(r,"SID",t.K),$e(r,"RID",n),$e(r,"AID",t.V),Qn(t,r),t.o&&t.s&&qn(r,t.o,t.s),n=new Ee(t,t.l,n,t.C+1),null===t.o&&(n.I=t.s),e&&(t.j=e.F.concat(t.j)),e=Hn(t,n,1e3),n.setTimeout(Math.round(.5*t.xa)+Math.round(.5*t.xa*Math.random())),gn(t.i,n),De(n,r,e)}function Qn(t,e){t.na&&gt(t.na,(function(t,n){$e(e,n,t)})),t.h&&qe({},(function(t,n){$e(e,n,t)}))}function Hn(t,e,n){n=Math.min(t.j.length,n);var r=t.h?O(t.h.Va,t.h,t):null;t:{var s=t.j;let e=-1;for(;;){const t=["count="+n];-1==e?0<n?(e=s[0].g,t.push("ofs="+e)):e=0:t.push("ofs="+e);let i=!0;for(let o=0;o<n;o++){let n=s[o].g;const a=s[o].map;if(n-=e,0>n)e=Math.max(0,s[o].g-100),i=!1;else try{wn(a,t,"req"+n+"_")}catch(t){r&&r(a)}}if(i){r=t.join("&");break t}}}return t=t.j.splice(0,n),e.F=t,r}function Wn(t){if(!t.g&&!t.u){t.ba=1;var e=t.Ma;zt||Kt(),Gt||(zt(),Gt=!0),jt.add(e,t),t.A=0}}function Yn(t){return!(t.g||t.u||3<=t.A||(t.ba++,t.u=de(O(t.Ma,t),er(t,t.A)),t.A++,0))}function Xn(t){null!=t.B&&(N.clearTimeout(t.B),t.B=null)}function Jn(t){t.g=new Ee(t,t.l,"rpc",t.ba),null===t.o&&(t.g.I=t.s),t.g.O=0;var e=ze(t.wa);$e(e,"RID","rpc"),$e(e,"SID",t.K),$e(e,"AID",t.V),$e(e,"CI",t.G?"0":"1"),!t.G&&t.qa&&$e(e,"TO",t.qa),$e(e,"TYPE","xmlhttp"),Qn(t,e),t.o&&t.s&&qn(e,t.o,t.s),t.L&&t.g.setTimeout(t.L);var n=t.g;t=t.pa,n.L=1,n.A=Qe(ze(e)),n.u=null,n.S=!0,Ae(n,t)}function Zn(t){null!=t.v&&(N.clearTimeout(t.v),t.v=null)}function tr(t,e){var n=null;if(t.g==e){Zn(t),Xn(t),t.g=null;var r=2}else{if(!fn(t.i,e))return;n=e.F,mn(t.i,e),r=1}if(0!=t.H)if(e.i)if(1==r){n=e.u?e.u.length:0,e=Date.now()-e.G;var s=t.C;Lt(r=oe(),new he(r,n)),Kn(t)}else Wn(t);else if(3==(s=e.s)||0==s&&0<e.ca||!(1==r&&function(t,e){return!(dn(t.i)>=t.i.j-(t.m?1:0)||(t.m?(t.j=e.F.concat(t.j),0):1==t.H||2==t.H||t.C>=(t.cb?0:t.eb)||(t.m=de(O(t.Na,t,e),er(t,t.C)),t.C++,0)))}(t,e)||2==r&&Yn(t)))switch(n&&0<n.length&&(e=t.i,e.i=e.i.concat(n)),s){case 1:nr(t,5);break;case 4:nr(t,10);break;case 3:nr(t,6);break;default:nr(t,2)}}function er(t,e){let n=t.ab+Math.floor(Math.random()*t.hb);return t.isActive()||(n*=2),n*e}function nr(t,e){if(t.l.info("Error code "+e),2==e){var n=null;t.h&&(n=null);var r=O(t.pb,t);n||(n=new Ue("//www.google.com/images/cleardot.gif"),N.location&&"http"==N.location.protocol||Ge(n,"https"),Qe(n)),function(t,e){const n=new ne;if(N.Image){const r=new Image;r.onload=P(vn,n,r,"TestLoadImage: loaded",!0,e),r.onerror=P(vn,n,r,"TestLoadImage: error",!1,e),r.onabort=P(vn,n,r,"TestLoadImage: abort",!1,e),r.ontimeout=P(vn,n,r,"TestLoadImage: timeout",!1,e),N.setTimeout((function(){r.ontimeout&&r.ontimeout()}),1e4),r.src=t}else e(!1)}(n.toString(),r)}else le(2);t.H=0,t.h&&t.h.za(e),rr(t),jn(t)}function rr(t){if(t.H=0,t.ma=[],t.h){const e=pn(t.i);0==e.length&&0==t.j.length||(U(t.ma,e),U(t.ma,t.j),t.i.i.length=0,B(t.j),t.j.length=0),t.h.ya()}}function sr(t,e,n){var r=n instanceof Ue?ze(n):new Ue(n);if(""!=r.g)e&&(r.g=e+"."+r.g),je(r,r.m);else{var s=N.location;r=s.protocol,e=e?e+"."+s.hostname:s.hostname,s=+s.port;var i=new Ue(null);r&&Ge(i,r),e&&(i.g=e),s&&je(i,s),n&&(i.l=n),r=i}return n=t.F,e=t.Da,n&&e&&$e(r,n,e),$e(r,"VER",t.ra),Qn(t,r),r}function ir(t,e,n){if(e&&!t.J)throw Error("Can't create secondary domain capable XhrIo object.");return(e=t.Ha&&!t.va?new Cn(new bn({ob:n})):new Cn(t.va)).Oa(t.J),e}function or(){}function ar(){if(J&&!(10<=Number(at)))throw Error("Environmental error: no available transport.")}function ur(t,e){Mt.call(this),this.g=new Un(e),this.l=t,this.h=e&&e.messageUrlParams||null,t=e&&e.messageHeaders||null,e&&e.clientProtocolHeaderRequired&&(t?t["X-Client-Protocol"]="webchannel":t={"X-Client-Protocol":"webchannel"}),this.g.s=t,t=e&&e.initMessageHeaders||null,e&&e.messageContentType&&(t?t["X-WebChannel-Content-Type"]=e.messageContentType:t={"X-WebChannel-Content-Type":e.messageContentType}),e&&e.Ca&&(t?t["X-WebChannel-Client-Profile"]=e.Ca:t={"X-WebChannel-Client-Profile":e.Ca}),this.g.U=t,(t=e&&e.cc)&&!j(t)&&(this.g.o=t),this.A=e&&e.supportsCrossDomainXhr||!1,this.v=e&&e.sendRawJson||!1,(e=e&&e.httpSessionIdParam)&&!j(e)&&(this.g.F=e,null!==(t=this.h)&&e in t&&e in(t=this.h)&&delete t[e]),this.j=new hr(this)}function cr(t){be.call(this),t.__headers__&&(this.headers=t.__headers__,this.statusCode=t.__status__,delete t.__headers__,delete t.__status__);var e=t.__sm__;if(e){t:{for(const n in e){t=n;break t}t=void 0}(this.i=t)&&(t=this.i,e=null!==e&&t in e?e[t]:void 0),this.data=e}else this.data=t}function lr(){_e.call(this),this.status=1}function hr(t){this.g=t}function dr(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.m=Array(this.blockSize),this.i=this.h=0,this.reset()}function fr(t,e,n){n||(n=0);var r=Array(16);if("string"==typeof e)for(var s=0;16>s;++s)r[s]=e.charCodeAt(n++)|e.charCodeAt(n++)<<8|e.charCodeAt(n++)<<16|e.charCodeAt(n++)<<24;else for(s=0;16>s;++s)r[s]=e[n++]|e[n++]<<8|e[n++]<<16|e[n++]<<24;e=t.g[0],n=t.g[1],s=t.g[2];var i=t.g[3],o=e+(i^n&(s^i))+r[0]+3614090360&4294967295;o=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=(n=(s=(i=(e=n+(o<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[1]+3905402710&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[2]+606105819&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[3]+3250441966&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(s^i))+r[4]+4118548399&4294967295)<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[5]+1200080426&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[6]+2821735955&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[7]+4249261313&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(s^i))+r[8]+1770035416&4294967295)<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[9]+2336552879&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[10]+4294925233&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[11]+2304563134&4294967295)<<22&4294967295|o>>>10))+((o=e+(i^n&(s^i))+r[12]+1804603682&4294967295)<<7&4294967295|o>>>25))+((o=i+(s^e&(n^s))+r[13]+4254626195&4294967295)<<12&4294967295|o>>>20))+((o=s+(n^i&(e^n))+r[14]+2792965006&4294967295)<<17&4294967295|o>>>15))+((o=n+(e^s&(i^e))+r[15]+1236535329&4294967295)<<22&4294967295|o>>>10))+((o=e+(s^i&(n^s))+r[1]+4129170786&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[6]+3225465664&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[11]+643717713&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[0]+3921069994&4294967295)<<20&4294967295|o>>>12))+((o=e+(s^i&(n^s))+r[5]+3593408605&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[10]+38016083&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[15]+3634488961&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[4]+3889429448&4294967295)<<20&4294967295|o>>>12))+((o=e+(s^i&(n^s))+r[9]+568446438&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[14]+3275163606&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[3]+4107603335&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[8]+1163531501&4294967295)<<20&4294967295|o>>>12))+((o=e+(s^i&(n^s))+r[13]+2850285829&4294967295)<<5&4294967295|o>>>27))+((o=i+(n^s&(e^n))+r[2]+4243563512&4294967295)<<9&4294967295|o>>>23))+((o=s+(e^n&(i^e))+r[7]+1735328473&4294967295)<<14&4294967295|o>>>18))+((o=n+(i^e&(s^i))+r[12]+2368359562&4294967295)<<20&4294967295|o>>>12))+((o=e+(n^s^i)+r[5]+4294588738&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[8]+2272392833&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[11]+1839030562&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[14]+4259657740&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^s^i)+r[1]+2763975236&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[4]+1272893353&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[7]+4139469664&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[10]+3200236656&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^s^i)+r[13]+681279174&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[0]+3936430074&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[3]+3572445317&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[6]+76029189&4294967295)<<23&4294967295|o>>>9))+((o=e+(n^s^i)+r[9]+3654602809&4294967295)<<4&4294967295|o>>>28))+((o=i+(e^n^s)+r[12]+3873151461&4294967295)<<11&4294967295|o>>>21))+((o=s+(i^e^n)+r[15]+530742520&4294967295)<<16&4294967295|o>>>16))+((o=n+(s^i^e)+r[2]+3299628645&4294967295)<<23&4294967295|o>>>9))+((o=e+(s^(n|~i))+r[0]+4096336452&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[7]+1126891415&4294967295)<<10&4294967295|o>>>22))+((o=s+(e^(i|~n))+r[14]+2878612391&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(s|~e))+r[5]+4237533241&4294967295)<<21&4294967295|o>>>11))+((o=e+(s^(n|~i))+r[12]+1700485571&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[3]+2399980690&4294967295)<<10&4294967295|o>>>22))+((o=s+(e^(i|~n))+r[10]+4293915773&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(s|~e))+r[1]+2240044497&4294967295)<<21&4294967295|o>>>11))+((o=e+(s^(n|~i))+r[8]+1873313359&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[15]+4264355552&4294967295)<<10&4294967295|o>>>22))+((o=s+(e^(i|~n))+r[6]+2734768916&4294967295)<<15&4294967295|o>>>17))+((o=n+(i^(s|~e))+r[13]+1309151649&4294967295)<<21&4294967295|o>>>11))+((i=(e=n+((o=e+(s^(n|~i))+r[4]+4149444226&4294967295)<<6&4294967295|o>>>26))+((o=i+(n^(e|~s))+r[11]+3174756917&4294967295)<<10&4294967295|o>>>22))^((s=i+((o=s+(e^(i|~n))+r[2]+718787259&4294967295)<<15&4294967295|o>>>17))|~e))+r[9]+3951481745&4294967295,t.g[0]=t.g[0]+e&4294967295,t.g[1]=t.g[1]+(s+(o<<21&4294967295|o>>>11))&4294967295,t.g[2]=t.g[2]+s&4294967295,t.g[3]=t.g[3]+i&4294967295}function gr(t,e){this.h=e;for(var n=[],r=!0,s=t.length-1;0<=s;s--){var i=0|t[s];r&&i==e||(n[s]=i,r=!1)}this.g=n}(C=Cn.prototype).Oa=function(t){this.M=t},C.ha=function(t,e,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.I+"; newUri="+t);e=e?e.toUpperCase():"GET",this.I=t,this.j="",this.m=0,this.F=!1,this.h=!0,this.g=this.u?this.u.g():we.g(),this.C=this.u?pe(this.u):pe(we),this.g.onreadystatechange=O(this.La,this);try{this.G=!0,this.g.open(e,String(t),!0),this.G=!1}catch(t){return void kn(this,t)}if(t=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const t of r.keys())n.set(t,r.get(t))}r=Array.from(n.keys()).find((t=>"content-type"==t.toLowerCase())),s=N.FormData&&t instanceof N.FormData,!(0<=q(Nn,e))||r||s||n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[t,e]of n)this.g.setRequestHeader(t,e);this.K&&(this.g.responseType=this.K),"withCredentials"in this.g&&this.g.withCredentials!==this.M&&(this.g.withCredentials=this.M);try{On(this),0<this.B&&((this.L=function(t){return J&&"number"==typeof t.timeout&&void 0!==t.ontimeout}(this.g))?(this.g.timeout=this.B,this.g.ontimeout=O(this.ua,this)):this.A=Wt(this.ua,this.B,this)),this.v=!0,this.g.send(t),this.v=!1}catch(t){kn(this,t)}},C.ua=function(){void 0!==A&&this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,Lt(this,"timeout"),this.abort(8))},C.abort=function(t){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=t||7,Lt(this,"complete"),Lt(this,"abort"),Ln(this))},C.N=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Ln(this,!0)),Cn.$.N.call(this)},C.La=function(){this.s||(this.G||this.v||this.l?Mn(this):this.kb())},C.kb=function(){Mn(this)},C.isActive=function(){return!!this.g},C.da=function(){try{return 2<Pn(this)?this.g.status:-1}catch(t){return-1}},C.ja=function(){try{return this.g?this.g.responseText:""}catch(t){return""}},C.Wa=function(t){if(this.g){var e=this.g.responseText;return t&&0==e.indexOf(t)&&(e=e.substring(t.length)),xn(e)}},C.Ia=function(){return this.m},C.Sa=function(){return"string"==typeof this.j?this.j:String(this.j)},(C=Un.prototype).ra=8,C.H=1,C.Na=function(t){if(this.m)if(this.m=null,1==this.H){if(!t){this.W=Math.floor(1e5*Math.random()),t=this.W++;const s=new Ee(this,this.l,t);let i=this.s;if(this.U&&(i?(i=mt(i),yt(i,this.U)):i=this.U),null!==this.o||this.O||(s.I=i,i=null),this.P)t:{for(var e=0,n=0;n<this.j.length;n++){var r=this.j[n];if(void 0===(r="__data__"in r.map&&"string"==typeof(r=r.map.__data__)?r.length:void 0))break;if(4096<(e+=r)){e=n;break t}if(4096===e||n===this.j.length-1){e=n+1;break t}}e=1e3}else e=1e3;e=Hn(this,s,e),$e(n=ze(this.I),"RID",t),$e(n,"CVER",22),this.F&&$e(n,"X-HTTP-Session-Id",this.F),Qn(this,n),i&&(this.O?e="headers="+encodeURIComponent(String(Vn(i)))+"&"+e:this.o&&qn(n,this.o,i)),gn(this.i,s),this.bb&&$e(n,"TYPE","init"),this.P?($e(n,"$req",e),$e(n,"SID","null"),s.aa=!0,De(s,n,null)):De(s,n,e),this.H=2}}else 3==this.H&&(t?$n(this,t):0==this.j.length||hn(this.i)||$n(this))},C.Ma=function(){if(this.u=null,Jn(this),this.ca&&!(this.M||null==this.g||0>=this.S)){var t=2*this.S;this.l.info("BP detection timer enabled: "+t),this.B=de(O(this.jb,this),t)}},C.jb=function(){this.B&&(this.B=null,this.l.info("BP detection timeout reached."),this.l.info("Buffering proxy detected and switch to long-polling!"),this.G=!1,this.M=!0,le(10),Gn(this),Jn(this))},C.ib=function(){null!=this.v&&(this.v=null,Gn(this),Yn(this),le(19))},C.pb=function(t){t?(this.l.info("Successfully pinged google.com"),le(2)):(this.l.info("Failed to ping google.com"),le(1))},C.isActive=function(){return!!this.h&&this.h.isActive(this)},(C=or.prototype).Ba=function(){},C.Aa=function(){},C.za=function(){},C.ya=function(){},C.isActive=function(){return!0},C.Va=function(){},ar.prototype.g=function(t,e){return new ur(t,e)},F(ur,Mt),ur.prototype.m=function(){this.g.h=this.j,this.A&&(this.g.J=!0);var t=this.g,e=this.l,n=this.h||void 0;le(0),t.Y=e,t.na=n||{},t.G=t.aa,t.I=sr(t,null,t.Y),Kn(t)},ur.prototype.close=function(){zn(this.g)},ur.prototype.u=function(t){var e=this.g;if("string"==typeof t){var n={};n.__data__=t,t=n}else this.v&&((n={}).__data__=Pt(t),t=n);e.j.push(new class{constructor(t,e){this.g=t,this.map=e}}(e.fb++,t)),3==e.H&&Kn(e)},ur.prototype.N=function(){this.g.h=null,delete this.j,zn(this.g),delete this.g,ur.$.N.call(this)},F(cr,be),F(lr,_e),F(hr,or),hr.prototype.Ba=function(){Lt(this.g,"a")},hr.prototype.Aa=function(t){Lt(this.g,new cr(t))},hr.prototype.za=function(t){Lt(this.g,new lr)},hr.prototype.ya=function(){Lt(this.g,"b")},F(dr,(function(){this.blockSize=-1})),dr.prototype.reset=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.i=this.h=0},dr.prototype.j=function(t,e){void 0===e&&(e=t.length);for(var n=e-this.blockSize,r=this.m,s=this.h,i=0;i<e;){if(0==s)for(;i<=n;)fr(this,t,i),i+=this.blockSize;if("string"==typeof t){for(;i<e;)if(r[s++]=t.charCodeAt(i++),s==this.blockSize){fr(this,r),s=0;break}}else for(;i<e;)if(r[s++]=t[i++],s==this.blockSize){fr(this,r),s=0;break}}this.h=s,this.i+=e},dr.prototype.l=function(){var t=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);t[0]=128;for(var e=1;e<t.length-8;++e)t[e]=0;var n=8*this.i;for(e=t.length-8;e<t.length;++e)t[e]=255&n,n/=256;for(this.j(t),t=Array(16),e=n=0;4>e;++e)for(var r=0;32>r;r+=8)t[n++]=this.g[e]>>>r&255;return t};var mr={};function pr(t){return-128<=t&&128>t?function(t,e){var n=mr;return Object.prototype.hasOwnProperty.call(n,t)?n[t]:n[t]=e(t)}(t,(function(t){return new gr([0|t],0>t?-1:0)})):new gr([0|t],0>t?-1:0)}function yr(t){if(isNaN(t)||!isFinite(t))return vr;if(0>t)return Tr(yr(-t));for(var e=[],n=1,r=0;t>=n;r++)e[r]=t/n|0,n*=wr;return new gr(e,0)}var wr=4294967296,vr=pr(0),br=pr(1),_r=pr(16777216);function Ir(t){if(0!=t.h)return!1;for(var e=0;e<t.g.length;e++)if(0!=t.g[e])return!1;return!0}function Er(t){return-1==t.h}function Tr(t){for(var e=t.g.length,n=[],r=0;r<e;r++)n[r]=~t.g[r];return new gr(n,~t.h).add(br)}function Sr(t,e){return t.add(Tr(e))}function xr(t,e){for(;(65535&t[e])!=t[e];)t[e+1]+=t[e]>>>16,t[e]&=65535,e++}function Cr(t,e){this.g=t,this.h=e}function Dr(t,e){if(Ir(e))throw Error("division by zero");if(Ir(t))return new Cr(vr,vr);if(Er(t))return e=Dr(Tr(t),e),new Cr(Tr(e.g),Tr(e.h));if(Er(e))return e=Dr(t,Tr(e)),new Cr(Tr(e.g),e.h);if(30<t.g.length){if(Er(t)||Er(e))throw Error("slowDivide_ only works with positive integers.");for(var n=br,r=e;0>=r.X(t);)n=Ar(n),r=Ar(r);var s=Nr(n,1),i=Nr(r,1);for(r=Nr(r,2),n=Nr(n,2);!Ir(r);){var o=i.add(r);0>=o.X(t)&&(s=s.add(n),i=o),r=Nr(r,1),n=Nr(n,1)}return e=Sr(t,s.R(e)),new Cr(s,e)}for(s=vr;0<=t.X(e);){for(n=Math.max(1,Math.floor(t.ea()/e.ea())),r=48>=(r=Math.ceil(Math.log(n)/Math.LN2))?1:Math.pow(2,r-48),o=(i=yr(n)).R(e);Er(o)||0<o.X(t);)o=(i=yr(n-=r)).R(e);Ir(i)&&(i=br),s=s.add(i),t=Sr(t,o)}return new Cr(s,t)}function Ar(t){for(var e=t.g.length+1,n=[],r=0;r<e;r++)n[r]=t.D(r)<<1|t.D(r-1)>>>31;return new gr(n,t.h)}function Nr(t,e){var n=e>>5;e%=32;for(var r=t.g.length-n,s=[],i=0;i<r;i++)s[i]=0<e?t.D(i+n)>>>e|t.D(i+n+1)<<32-e:t.D(i+n);return new gr(s,t.h)}(C=gr.prototype).ea=function(){if(Er(this))return-Tr(this).ea();for(var t=0,e=1,n=0;n<this.g.length;n++){var r=this.D(n);t+=(0<=r?r:wr+r)*e,e*=wr}return t},C.toString=function(t){if(2>(t=t||10)||36<t)throw Error("radix out of range: "+t);if(Ir(this))return"0";if(Er(this))return"-"+Tr(this).toString(t);for(var e=yr(Math.pow(t,6)),n=this,r="";;){var s=Dr(n,e).g,i=((0<(n=Sr(n,s.R(e))).g.length?n.g[0]:n.h)>>>0).toString(t);if(Ir(n=s))return i+r;for(;6>i.length;)i="0"+i;r=i+r}},C.D=function(t){return 0>t?0:t<this.g.length?this.g[t]:this.h},C.X=function(t){return Er(t=Sr(this,t))?-1:Ir(t)?0:1},C.abs=function(){return Er(this)?Tr(this):this},C.add=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0,s=0;s<=e;s++){var i=r+(65535&this.D(s))+(65535&t.D(s)),o=(i>>>16)+(this.D(s)>>>16)+(t.D(s)>>>16);r=o>>>16,i&=65535,o&=65535,n[s]=o<<16|i}return new gr(n,-2147483648&n[n.length-1]?-1:0)},C.R=function(t){if(Ir(this)||Ir(t))return vr;if(Er(this))return Er(t)?Tr(this).R(Tr(t)):Tr(Tr(this).R(t));if(Er(t))return Tr(this.R(Tr(t)));if(0>this.X(_r)&&0>t.X(_r))return yr(this.ea()*t.ea());for(var e=this.g.length+t.g.length,n=[],r=0;r<2*e;r++)n[r]=0;for(r=0;r<this.g.length;r++)for(var s=0;s<t.g.length;s++){var i=this.D(r)>>>16,o=65535&this.D(r),a=t.D(s)>>>16,u=65535&t.D(s);n[2*r+2*s]+=o*u,xr(n,2*r+2*s),n[2*r+2*s+1]+=i*u,xr(n,2*r+2*s+1),n[2*r+2*s+1]+=o*a,xr(n,2*r+2*s+1),n[2*r+2*s+2]+=i*a,xr(n,2*r+2*s+2)}for(r=0;r<e;r++)n[r]=n[2*r+1]<<16|n[2*r];for(r=e;r<2*e;r++)n[r]=0;return new gr(n,0)},C.gb=function(t){return Dr(this,t).h},C.and=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0;r<e;r++)n[r]=this.D(r)&t.D(r);return new gr(n,this.h&t.h)},C.or=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0;r<e;r++)n[r]=this.D(r)|t.D(r);return new gr(n,this.h|t.h)},C.xor=function(t){for(var e=Math.max(this.g.length,t.g.length),n=[],r=0;r<e;r++)n[r]=this.D(r)^t.D(r);return new gr(n,this.h^t.h)},ar.prototype.createWebChannel=ar.prototype.g,ur.prototype.send=ur.prototype.u,ur.prototype.open=ur.prototype.m,ur.prototype.close=ur.prototype.close,fe.NO_ERROR=0,fe.TIMEOUT=8,fe.HTTP_ERROR=6,ge.COMPLETE="complete",ye.EventType=ve,ve.OPEN="a",ve.CLOSE="b",ve.ERROR="c",ve.MESSAGE="d",Mt.prototype.listen=Mt.prototype.O,Cn.prototype.listenOnce=Cn.prototype.P,Cn.prototype.getLastError=Cn.prototype.Sa,Cn.prototype.getLastErrorCode=Cn.prototype.Ia,Cn.prototype.getStatus=Cn.prototype.da,Cn.prototype.getResponseJson=Cn.prototype.Wa,Cn.prototype.getResponseText=Cn.prototype.ja,Cn.prototype.send=Cn.prototype.ha,Cn.prototype.setWithCredentials=Cn.prototype.Oa,dr.prototype.digest=dr.prototype.l,dr.prototype.reset=dr.prototype.reset,dr.prototype.update=dr.prototype.j,gr.prototype.add=gr.prototype.add,gr.prototype.multiply=gr.prototype.R,gr.prototype.modulo=gr.prototype.gb,gr.prototype.compare=gr.prototype.X,gr.prototype.toNumber=gr.prototype.ea,gr.prototype.toString=gr.prototype.toString,gr.prototype.getBits=gr.prototype.D,gr.fromNumber=yr,gr.fromString=function t(e,n){if(0==e.length)throw Error("number format error: empty string");if(2>(n=n||10)||36<n)throw Error("radix out of range: "+n);if("-"==e.charAt(0))return Tr(t(e.substring(1),n));if(0<=e.indexOf("-"))throw Error('number format error: interior "-" character');for(var r=yr(Math.pow(n,8)),s=vr,i=0;i<e.length;i+=8){var o=Math.min(8,e.length-i),a=parseInt(e.substring(i,i+o),n);8>o?(o=yr(Math.pow(n,o)),s=s.R(o).add(yr(a))):s=(s=s.R(r)).add(yr(a))}return s};var kr=fe,Rr=ge,Mr=se,Lr=ye,Or=Cn,Pr=dr,Fr=gr;const Vr="@firebase/firestore";class qr{constructor(t){this.uid=t}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(t){return t.uid===this.uid}}qr.UNAUTHENTICATED=new qr(null),qr.GOOGLE_CREDENTIALS=new qr("google-credentials-uid"),qr.FIRST_PARTY=new qr("first-party-uid"),qr.MOCK_USER=new qr("mock-user");let Br="10.8.0";const Ur=new class{constructor(t){this.name=t,this._logLevel=T,this._logHandler=x,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(t){if(!(t in _))throw new TypeError(`Invalid value "${t}" assigned to \`logLevel\``);this._logLevel=t}setLogLevel(t){this._logLevel="string"==typeof t?E[t]:t}get logHandler(){return this._logHandler}set logHandler(t){if("function"!=typeof t)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=t}get userLogHandler(){return this._userLogHandler}set userLogHandler(t){this._userLogHandler=t}debug(...t){this._userLogHandler&&this._userLogHandler(this,_.DEBUG,...t),this._logHandler(this,_.DEBUG,...t)}log(...t){this._userLogHandler&&this._userLogHandler(this,_.VERBOSE,...t),this._logHandler(this,_.VERBOSE,...t)}info(...t){this._userLogHandler&&this._userLogHandler(this,_.INFO,...t),this._logHandler(this,_.INFO,...t)}warn(...t){this._userLogHandler&&this._userLogHandler(this,_.WARN,...t),this._logHandler(this,_.WARN,...t)}error(...t){this._userLogHandler&&this._userLogHandler(this,_.ERROR,...t),this._logHandler(this,_.ERROR,...t)}}("@firebase/firestore");function zr(){return Ur.logLevel}function Gr(t){Ur.setLogLevel(t)}function jr(t,...e){if(Ur.logLevel<=_.DEBUG){const n=e.map(Qr);Ur.debug(`Firestore (${Br}): ${t}`,...n)}}function Kr(t,...e){if(Ur.logLevel<=_.ERROR){const n=e.map(Qr);Ur.error(`Firestore (${Br}): ${t}`,...n)}}function $r(t,...e){if(Ur.logLevel<=_.WARN){const n=e.map(Qr);Ur.warn(`Firestore (${Br}): ${t}`,...n)}}function Qr(t){if("string"==typeof t)return t;try{return function(t){return JSON.stringify(t)}(t)}catch(e){return t}}function Hr(t="Unexpected state"){const e=`FIRESTORE (${Br}) INTERNAL ASSERTION FAILED: `+t;throw Kr(e),new Error(e)}function Wr(t,e){t||Hr()}function Yr(t,e){t||Hr()}function Xr(t,e){return t}const Jr={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class Zr extends g{constructor(t,e){super(t,e),this.code=t,this.message=e,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class ts{constructor(){this.promise=new Promise(((t,e)=>{this.resolve=t,this.reject=e}))}}class es{constructor(t,e){this.user=e,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${t}`)}}class ns{getToken(){return Promise.resolve(null)}invalidateToken(){}start(t,e){t.enqueueRetryable((()=>e(qr.UNAUTHENTICATED)))}shutdown(){}}class rs{constructor(t){this.token=t,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(t,e){this.changeListener=e,t.enqueueRetryable((()=>e(this.token.user)))}shutdown(){this.changeListener=null}}class ss{constructor(t){this.t=t,this.currentUser=qr.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,e){let n=this.i;const r=t=>this.i!==n?(n=this.i,e(t)):Promise.resolve();let s=new ts;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new ts,t.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const e=s;t.enqueueRetryable((async()=>{await e.promise,await r(this.currentUser)}))},o=t=>{jr("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=t,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((t=>o(t))),setTimeout((()=>{if(!this.auth){const t=this.t.getImmediate({optional:!0});t?o(t):(jr("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new ts)}}),0),i()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then((e=>this.i!==t?(jr("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(Wr("string"==typeof e.accessToken),new es(e.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const t=this.auth&&this.auth.getUid();return Wr(null===t||"string"==typeof t),new qr(t)}}class is{constructor(t,e,n){this.l=t,this.h=e,this.P=n,this.type="FirstParty",this.user=qr.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const t=this.T();return t&&this.I.set("Authorization",t),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class os{constructor(t,e,n){this.l=t,this.h=e,this.P=n}getToken(){return Promise.resolve(new is(this.l,this.h,this.P))}start(t,e){t.enqueueRetryable((()=>e(qr.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class as{constructor(t){this.value=t,this.type="AppCheck",this.headers=new Map,t&&t.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class us{constructor(t){this.A=t,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(t,e){const n=t=>{null!=t.error&&jr("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${t.error.message}`);const n=t.token!==this.R;return this.R=t.token,jr("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?e(t.token):Promise.resolve()};this.o=e=>{t.enqueueRetryable((()=>n(e)))};const r=t=>{jr("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=t,this.appCheck.addTokenListener(this.o)};this.A.onInit((t=>r(t))),setTimeout((()=>{if(!this.appCheck){const t=this.A.getImmediate({optional:!0});t?r(t):jr("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const t=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(t).then((t=>t?(Wr("string"==typeof t.token),this.R=t.token,new as(t.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class cs{getToken(){return Promise.resolve(new as(""))}invalidateToken(){}start(t,e){}shutdown(){}}function ls(t){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(t);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(n);else for(let e=0;e<t;e++)n[e]=Math.floor(256*Math.random());return n}class hs{static newId(){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",e=Math.floor(256/t.length)*t.length;let n="";for(;n.length<20;){const r=ls(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<e&&(n+=t.charAt(r[s]%t.length))}return n}}function ds(t,e){return t<e?-1:t>e?1:0}function fs(t,e,n){return t.length===e.length&&t.every(((t,r)=>n(t,e[r])))}function gs(t){return t+"\0"}class ms{constructor(t,e){if(this.seconds=t,this.nanoseconds=e,e<0)throw new Zr(Jr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(e>=1e9)throw new Zr(Jr.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+e);if(t<-62135596800)throw new Zr(Jr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t);if(t>=253402300800)throw new Zr(Jr.INVALID_ARGUMENT,"Timestamp seconds out of range: "+t)}static now(){return ms.fromMillis(Date.now())}static fromDate(t){return ms.fromMillis(t.getTime())}static fromMillis(t){const e=Math.floor(t/1e3),n=Math.floor(1e6*(t-1e3*e));return new ms(e,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(t){return this.seconds===t.seconds?ds(this.nanoseconds,t.nanoseconds):ds(this.seconds,t.seconds)}isEqual(t){return t.seconds===this.seconds&&t.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const t=this.seconds- -62135596800;return String(t).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class ps{constructor(t){this.timestamp=t}static fromTimestamp(t){return new ps(t)}static min(){return new ps(new ms(0,0))}static max(){return new ps(new ms(253402300799,999999999))}compareTo(t){return this.timestamp._compareTo(t.timestamp)}isEqual(t){return this.timestamp.isEqual(t.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class ys{constructor(t,e,n){void 0===e?e=0:e>t.length&&Hr(),void 0===n?n=t.length-e:n>t.length-e&&Hr(),this.segments=t,this.offset=e,this.len=n}get length(){return this.len}isEqual(t){return 0===ys.comparator(this,t)}child(t){const e=this.segments.slice(this.offset,this.limit());return t instanceof ys?t.forEach((t=>{e.push(t)})):e.push(t),this.construct(e)}limit(){return this.offset+this.length}popFirst(t){return t=void 0===t?1:t,this.construct(this.segments,this.offset+t,this.length-t)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(t){return this.segments[this.offset+t]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(t){for(let e=this.offset,n=this.limit();e<n;e++)t(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,e){const n=Math.min(t.length,e.length);for(let r=0;r<n;r++){const n=t.get(r),s=e.get(r);if(n<s)return-1;if(n>s)return 1}return t.length<e.length?-1:t.length>e.length?1:0}}class ws extends ys{construct(t,e,n){return new ws(t,e,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...t){const e=[];for(const n of t){if(n.indexOf("//")>=0)throw new Zr(Jr.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);e.push(...n.split("/").filter((t=>t.length>0)))}return new ws(e)}static emptyPath(){return new ws([])}}const vs=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class bs extends ys{construct(t,e,n){return new bs(t,e,n)}static isValidIdentifier(t){return vs.test(t)}canonicalString(){return this.toArray().map((t=>(t=t.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),bs.isValidIdentifier(t)||(t="`"+t+"`"),t))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new bs(["__name__"])}static fromServerFormat(t){const e=[];let n="",r=0;const s=()=>{if(0===n.length)throw new Zr(Jr.INVALID_ARGUMENT,`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);e.push(n),n=""};let i=!1;for(;r<t.length;){const e=t[r];if("\\"===e){if(r+1===t.length)throw new Zr(Jr.INVALID_ARGUMENT,"Path has trailing escape character: "+t);const e=t[r+1];if("\\"!==e&&"."!==e&&"`"!==e)throw new Zr(Jr.INVALID_ARGUMENT,"Path has invalid escape sequence: "+t);n+=e,r+=2}else"`"===e?(i=!i,r++):"."!==e||i?(n+=e,r++):(s(),r++)}if(s(),i)throw new Zr(Jr.INVALID_ARGUMENT,"Unterminated ` in path: "+t);return new bs(e)}static emptyPath(){return new bs([])}}class _s{constructor(t){this.path=t}static fromPath(t){return new _s(ws.fromString(t))}static fromName(t){return new _s(ws.fromString(t).popFirst(5))}static empty(){return new _s(ws.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(t){return this.path.length>=2&&this.path.get(this.path.length-2)===t}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(t){return null!==t&&0===ws.comparator(this.path,t.path)}toString(){return this.path.toString()}static comparator(t,e){return ws.comparator(t.path,e.path)}static isDocumentKey(t){return t.length%2==0}static fromSegments(t){return new _s(new ws(t.slice()))}}class Is{constructor(t,e,n,r){this.indexId=t,this.collectionGroup=e,this.fields=n,this.indexState=r}}function Es(t){return t.fields.find((t=>2===t.kind))}function Ts(t){return t.fields.filter((t=>2!==t.kind))}function Ss(t,e){let n=ds(t.collectionGroup,e.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(t.fields.length,e.fields.length);++r)if(n=Cs(t.fields[r],e.fields[r]),0!==n)return n;return ds(t.fields.length,e.fields.length)}Is.UNKNOWN_ID=-1;class xs{constructor(t,e){this.fieldPath=t,this.kind=e}}function Cs(t,e){const n=bs.comparator(t.fieldPath,e.fieldPath);return 0!==n?n:ds(t.kind,e.kind)}class Ds{constructor(t,e){this.sequenceNumber=t,this.offset=e}static empty(){return new Ds(0,ks.min())}}function As(t,e){const n=t.toTimestamp().seconds,r=t.toTimestamp().nanoseconds+1,s=ps.fromTimestamp(1e9===r?new ms(n+1,0):new ms(n,r));return new ks(s,_s.empty(),e)}function Ns(t){return new ks(t.readTime,t.key,-1)}class ks{constructor(t,e,n){this.readTime=t,this.documentKey=e,this.largestBatchId=n}static min(){return new ks(ps.min(),_s.empty(),-1)}static max(){return new ks(ps.max(),_s.empty(),-1)}}function Rs(t,e){let n=t.readTime.compareTo(e.readTime);return 0!==n?n:(n=_s.comparator(t.documentKey,e.documentKey),0!==n?n:ds(t.largestBatchId,e.largestBatchId))}const Ms="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class Ls{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(t){this.onCommittedListeners.push(t)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((t=>t()))}}async function Os(t){if(t.code!==Jr.FAILED_PRECONDITION||t.message!==Ms)throw t;jr("LocalStore","Unexpectedly lost primary lease")}class Ps{constructor(t){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,t((t=>{this.isDone=!0,this.result=t,this.nextCallback&&this.nextCallback(t)}),(t=>{this.isDone=!0,this.error=t,this.catchCallback&&this.catchCallback(t)}))}catch(t){return this.next(void 0,t)}next(t,e){return this.callbackAttached&&Hr(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(e,this.error):this.wrapSuccess(t,this.result):new Ps(((n,r)=>{this.nextCallback=e=>{this.wrapSuccess(t,e).next(n,r)},this.catchCallback=t=>{this.wrapFailure(e,t).next(n,r)}}))}toPromise(){return new Promise(((t,e)=>{this.next(t,e)}))}wrapUserFunction(t){try{const e=t();return e instanceof Ps?e:Ps.resolve(e)}catch(t){return Ps.reject(t)}}wrapSuccess(t,e){return t?this.wrapUserFunction((()=>t(e))):Ps.resolve(e)}wrapFailure(t,e){return t?this.wrapUserFunction((()=>t(e))):Ps.reject(e)}static resolve(t){return new Ps(((e,n)=>{e(t)}))}static reject(t){return new Ps(((e,n)=>{n(t)}))}static waitFor(t){return new Ps(((e,n)=>{let r=0,s=0,i=!1;t.forEach((t=>{++r,t.next((()=>{++s,i&&s===r&&e()}),(t=>n(t)))})),i=!0,s===r&&e()}))}static or(t){let e=Ps.resolve(!1);for(const n of t)e=e.next((t=>t?Ps.resolve(t):n()));return e}static forEach(t,e){const n=[];return t.forEach(((t,r)=>{n.push(e.call(this,t,r))})),this.waitFor(n)}static mapArray(t,e){return new Ps(((n,r)=>{const s=t.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const u=a;e(t[u]).next((t=>{i[u]=t,++o,o===s&&n(i)}),(t=>r(t)))}}))}static doWhile(t,e){return new Ps(((n,r)=>{const s=()=>{!0===t()?e().next((()=>{s()}),r):n()};s()}))}}class Fs{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.V=new ts,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{e.error?this.V.reject(new Bs(t,e.error)):this.V.resolve()},this.transaction.onerror=e=>{const n=Ks(e.target.error);this.V.reject(new Bs(t,n))}}static open(t,e,n,r){try{return new Fs(e,t.transaction(r,n))}catch(t){throw new Bs(e,t)}}get m(){return this.V.promise}abort(t){t&&this.V.reject(t),this.aborted||(jr("SimpleDb","Aborting transaction:",t?t.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const t=this.transaction;this.aborted||"function"!=typeof t.commit||t.commit()}store(t){const e=this.transaction.objectStore(t);return new zs(e)}}class Vs{constructor(t,e,n){this.name=t,this.version=e,this.p=n,12.2===Vs.S(d())&&Kr("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(t){return jr("SimpleDb","Removing database:",t),Gs(window.indexedDB.deleteDatabase(t)).toPromise()}static D(){if(!function(){try{return"object"==typeof indexedDB}catch(t){return!1}}())return!1;if(Vs.C())return!0;const t=d(),e=Vs.S(t),n=0<e&&e<10,r=Vs.v(t),s=0<r&&r<4.5;return!(t.indexOf("MSIE ")>0||t.indexOf("Trident/")>0||t.indexOf("Edge/")>0||n||s)}static C(){var t;return void 0!==o&&"YES"===(null===(t=o.__PRIVATE_env)||void 0===t?void 0:t.F)}static M(t,e){return t.store(e)}static S(t){const e=t.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=e?e[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static v(t){const e=t.match(/Android ([\d.]+)/i),n=e?e[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async O(t){return this.db||(jr("SimpleDb","Opening database:",this.name),this.db=await new Promise(((e,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=t=>{const n=t.target.result;e(n)},r.onblocked=()=>{n(new Bs(t,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{const r=e.target.error;"VersionError"===r.name?n(new Zr(Jr.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new Zr(Jr.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new Bs(t,r))},r.onupgradeneeded=t=>{jr("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',t.oldVersion);const e=t.target.result;this.p.N(e,r.transaction,t.oldVersion,this.version).next((()=>{jr("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.B&&(this.db.onversionchange=t=>this.B(t)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(t,e,n,r){const s="readonly"===e;let i=0;for(;;){++i;try{this.db=await this.O(t);const e=Fs.open(this.db,t,s?"readonly":"readwrite",n),i=r(e).next((t=>(e.g(),t))).catch((t=>(e.abort(t),Ps.reject(t)))).toPromise();return i.catch((()=>{})),await e.m,i}catch(t){const e=t,n="FirebaseError"!==e.name&&i<3;if(jr("SimpleDb","Transaction failed with error:",e.message,"Retrying:",n),this.close(),!n)return Promise.reject(e)}}}close(){this.db&&this.db.close(),this.db=void 0}}class qs{constructor(t){this.k=t,this.q=!1,this.K=null}get isDone(){return this.q}get $(){return this.K}set cursor(t){this.k=t}done(){this.q=!0}U(t){this.K=t}delete(){return Gs(this.k.delete())}}class Bs extends Zr{constructor(t,e){super(Jr.UNAVAILABLE,`IndexedDB transaction '${t}' failed: ${e}`),this.name="IndexedDbTransactionError"}}function Us(t){return"IndexedDbTransactionError"===t.name}class zs{constructor(t){this.store=t}put(t,e){let n;return void 0!==e?(jr("SimpleDb","PUT",this.store.name,t,e),n=this.store.put(e,t)):(jr("SimpleDb","PUT",this.store.name,"<auto-key>",t),n=this.store.put(t)),Gs(n)}add(t){return jr("SimpleDb","ADD",this.store.name,t,t),Gs(this.store.add(t))}get(t){return Gs(this.store.get(t)).next((e=>(void 0===e&&(e=null),jr("SimpleDb","GET",this.store.name,t,e),e)))}delete(t){return jr("SimpleDb","DELETE",this.store.name,t),Gs(this.store.delete(t))}count(){return jr("SimpleDb","COUNT",this.store.name),Gs(this.store.count())}W(t,e){const n=this.options(t,e),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const t=r.getAll(n.range);return new Ps(((e,n)=>{t.onerror=t=>{n(t.target.error)},t.onsuccess=t=>{e(t.target.result)}}))}{const t=this.cursor(n),e=[];return this.G(t,((t,n)=>{e.push(n)})).next((()=>e))}}j(t,e){const n=this.store.getAll(t,null===e?void 0:e);return new Ps(((t,e)=>{n.onerror=t=>{e(t.target.error)},n.onsuccess=e=>{t(e.target.result)}}))}H(t,e){jr("SimpleDb","DELETE ALL",this.store.name);const n=this.options(t,e);n.J=!1;const r=this.cursor(n);return this.G(r,((t,e,n)=>n.delete()))}Y(t,e){let n;e?n=t:(n={},e=t);const r=this.cursor(n);return this.G(r,e)}Z(t){const e=this.cursor({});return new Ps(((n,r)=>{e.onerror=t=>{const e=Ks(t.target.error);r(e)},e.onsuccess=e=>{const r=e.target.result;r?t(r.primaryKey,r.value).next((t=>{t?r.continue():n()})):n()}}))}G(t,e){const n=[];return new Ps(((r,s)=>{t.onerror=t=>{s(t.target.error)},t.onsuccess=t=>{const s=t.target.result;if(!s)return void r();const i=new qs(s),o=e(s.primaryKey,s.value,i);if(o instanceof Ps){const t=o.catch((t=>(i.done(),Ps.reject(t))));n.push(t)}i.isDone?r():null===i.$?s.continue():s.continue(i.$)}})).next((()=>Ps.waitFor(n)))}options(t,e){let n;return void 0!==t&&("string"==typeof t?n=t:e=t),{index:n,range:e}}cursor(t){let e="next";if(t.reverse&&(e="prev"),t.index){const n=this.store.index(t.index);return t.J?n.openKeyCursor(t.range,e):n.openCursor(t.range,e)}return this.store.openCursor(t.range,e)}}function Gs(t){return new Ps(((e,n)=>{t.onsuccess=t=>{const n=t.target.result;e(n)},t.onerror=t=>{const e=Ks(t.target.error);n(e)}}))}let js=!1;function Ks(t){const e=Vs.S(d());if(e>=12.2&&e<13){const e="An internal error was encountered in the Indexed Database server";if(t.message.indexOf(e)>=0){const t=new Zr("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${e}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return js||(js=!0,setTimeout((()=>{throw t}),0)),t}}return t}class $s{constructor(t,e){this.asyncQueue=t,this.X=e,this.task=null}start(){this.ee(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}ee(t){jr("IndexBackfiller",`Scheduled in ${t}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",t,(async()=>{this.task=null;try{jr("IndexBackfiller",`Documents written: ${await this.X.te()}`)}catch(t){Us(t)?jr("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",t):await Os(t)}await this.ee(6e4)}))}}class Qs{constructor(t,e){this.localStore=t,this.persistence=e}async te(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(e=>this.ne(e,t)))}ne(t,e){const n=new Set;let r=e,s=!0;return Ps.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(t).next((e=>{if(null!==e&&!n.has(e))return jr("IndexBackfiller",`Processing collection: ${e}`),this.re(t,e,r).next((t=>{r-=t,n.add(e)}));s=!1})))).next((()=>e-r))}re(t,e,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(t,e).next((r=>this.localStore.localDocuments.getNextDocuments(t,e,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(t,s).next((()=>this.ie(r,n))).next((n=>(jr("IndexBackfiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(t,e,n)))).next((()=>s.size))}))))}ie(t,e){let n=t;return e.changes.forEach(((t,e)=>{const r=Ns(e);Rs(r,n)>0&&(n=r)})),new ks(n.readTime,n.documentKey,Math.max(e.batchId,t.largestBatchId))}}class Hs{constructor(t,e){this.previousValue=t,e&&(e.sequenceNumberHandler=t=>this.se(t),this.oe=t=>e.writeSequenceNumber(t))}se(t){return this.previousValue=Math.max(t,this.previousValue),this.previousValue}next(){const t=++this.previousValue;return this.oe&&this.oe(t),t}}function Ws(t){return null==t}function Ys(t){return 0===t&&1/t==-1/0}function Xs(t){return"number"==typeof t&&Number.isInteger(t)&&!Ys(t)&&t<=Number.MAX_SAFE_INTEGER&&t>=Number.MIN_SAFE_INTEGER}function Js(t){let e="";for(let n=0;n<t.length;n++)e.length>0&&(e=ti(e)),e=Zs(t.get(n),e);return ti(e)}function Zs(t,e){let n=e;const r=t.length;for(let e=0;e<r;e++){const r=t.charAt(e);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}function ti(t){return t+""}function ei(t){const e=t.length;if(Wr(e>=2),2===e)return Wr(""===t.charAt(0)&&""===t.charAt(1)),ws.emptyPath();const n=e-2,r=[];let s="";for(let i=0;i<e;){const e=t.indexOf("",i);switch((e<0||e>n)&&Hr(),t.charAt(e+1)){case"":const n=t.substring(i,e);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"":s+=t.substring(i,e),s+="\0";break;case"":s+=t.substring(i,e+1);break;default:Hr()}i=e+2}return new ws(r)}Hs._e=-1;const ni=["userId","batchId"];function ri(t,e){return[t,Js(e)]}function si(t,e,n){return[t,Js(e),n]}const ii={},oi=["prefixPath","collectionGroup","readTime","documentId"],ai=["prefixPath","collectionGroup","documentId"],ui=["collectionGroup","readTime","prefixPath","documentId"],ci=["canonicalId","targetId"],li=["targetId","path"],hi=["path","targetId"],di=["collectionId","parent"],fi=["indexId","uid"],gi=["uid","sequenceNumber"],mi=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],pi=["indexId","uid","orderedDocumentKey"],yi=["userId","collectionPath","documentId"],wi=["userId","collectionPath","largestBatchId"],vi=["userId","collectionGroup","largestBatchId"],bi=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],_i=[...bi,"documentOverlays"],Ii=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Ei=Ii,Ti=[...Ei,"indexConfiguration","indexState","indexEntries"];class Si extends Ls{constructor(t,e){super(),this.ae=t,this.currentSequenceNumber=e}}function xi(t,e){const n=Xr(t);return Vs.M(n.ae,e)}function Ci(t){let e=0;for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e++;return e}function Di(t,e){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e(n,t[n])}function Ai(t){for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e))return!1;return!0}class Ni{constructor(t,e){this.comparator=t,this.root=e||Ri.EMPTY}insert(t,e){return new Ni(this.comparator,this.root.insert(t,e,this.comparator).copy(null,null,Ri.BLACK,null,null))}remove(t){return new Ni(this.comparator,this.root.remove(t,this.comparator).copy(null,null,Ri.BLACK,null,null))}get(t){let e=this.root;for(;!e.isEmpty();){const n=this.comparator(t,e.key);if(0===n)return e.value;n<0?e=e.left:n>0&&(e=e.right)}return null}indexOf(t){let e=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(t,n.key);if(0===r)return e+n.left.size;r<0?n=n.left:(e+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(t){return this.root.inorderTraversal(t)}forEach(t){this.inorderTraversal(((e,n)=>(t(e,n),!1)))}toString(){const t=[];return this.inorderTraversal(((e,n)=>(t.push(`${e}:${n}`),!1))),`{${t.join(", ")}}`}reverseTraversal(t){return this.root.reverseTraversal(t)}getIterator(){return new ki(this.root,null,this.comparator,!1)}getIteratorFrom(t){return new ki(this.root,t,this.comparator,!1)}getReverseIterator(){return new ki(this.root,null,this.comparator,!0)}getReverseIteratorFrom(t){return new ki(this.root,t,this.comparator,!0)}}class ki{constructor(t,e,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!t.isEmpty();)if(s=e?n(t.key,e):1,e&&r&&(s*=-1),s<0)t=this.isReverse?t.left:t.right;else{if(0===s){this.nodeStack.push(t);break}this.nodeStack.push(t),t=this.isReverse?t.right:t.left}}getNext(){let t=this.nodeStack.pop();const e={key:t.key,value:t.value};if(this.isReverse)for(t=t.left;!t.isEmpty();)this.nodeStack.push(t),t=t.right;else for(t=t.right;!t.isEmpty();)this.nodeStack.push(t),t=t.left;return e}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const t=this.nodeStack[this.nodeStack.length-1];return{key:t.key,value:t.value}}}class Ri{constructor(t,e,n,r,s){this.key=t,this.value=e,this.color=null!=n?n:Ri.RED,this.left=null!=r?r:Ri.EMPTY,this.right=null!=s?s:Ri.EMPTY,this.size=this.left.size+1+this.right.size}copy(t,e,n,r,s){return new Ri(null!=t?t:this.key,null!=e?e:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(t){return this.left.inorderTraversal(t)||t(this.key,this.value)||this.right.inorderTraversal(t)}reverseTraversal(t){return this.right.reverseTraversal(t)||t(this.key,this.value)||this.left.reverseTraversal(t)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(t,e,n){let r=this;const s=n(t,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(t,e,n),null):0===s?r.copy(null,e,null,null,null):r.copy(null,null,null,null,r.right.insert(t,e,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Ri.EMPTY;let t=this;return t.left.isRed()||t.left.left.isRed()||(t=t.moveRedLeft()),t=t.copy(null,null,null,t.left.removeMin(),null),t.fixUp()}remove(t,e){let n,r=this;if(e(t,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(t,e),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===e(t,r.key)){if(r.right.isEmpty())return Ri.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(t,e))}return r.fixUp()}isRed(){return this.color}fixUp(){let t=this;return t.right.isRed()&&!t.left.isRed()&&(t=t.rotateLeft()),t.left.isRed()&&t.left.left.isRed()&&(t=t.rotateRight()),t.left.isRed()&&t.right.isRed()&&(t=t.colorFlip()),t}moveRedLeft(){let t=this.colorFlip();return t.right.left.isRed()&&(t=t.copy(null,null,null,null,t.right.rotateRight()),t=t.rotateLeft(),t=t.colorFlip()),t}moveRedRight(){let t=this.colorFlip();return t.left.left.isRed()&&(t=t.rotateRight(),t=t.colorFlip()),t}rotateLeft(){const t=this.copy(null,null,Ri.RED,null,this.right.left);return this.right.copy(null,null,this.color,t,null)}rotateRight(){const t=this.copy(null,null,Ri.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,t)}colorFlip(){const t=this.left.copy(null,null,!this.left.color,null,null),e=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,t,e)}checkMaxDepth(){const t=this.check();return Math.pow(2,t)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw Hr();if(this.right.isRed())throw Hr();const t=this.left.check();if(t!==this.right.check())throw Hr();return t+(this.isRed()?0:1)}}Ri.EMPTY=null,Ri.RED=!0,Ri.BLACK=!1,Ri.EMPTY=new class{constructor(){this.size=0}get key(){throw Hr()}get value(){throw Hr()}get color(){throw Hr()}get left(){throw Hr()}get right(){throw Hr()}copy(t,e,n,r,s){return this}insert(t,e,n){return new Ri(t,e)}remove(t,e){return this}isEmpty(){return!0}inorderTraversal(t){return!1}reverseTraversal(t){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Mi{constructor(t){this.comparator=t,this.data=new Ni(this.comparator)}has(t){return null!==this.data.get(t)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(t){return this.data.indexOf(t)}forEach(t){this.data.inorderTraversal(((e,n)=>(t(e),!1)))}forEachInRange(t,e){const n=this.data.getIteratorFrom(t[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,t[1])>=0)return;e(r.key)}}forEachWhile(t,e){let n;for(n=void 0!==e?this.data.getIteratorFrom(e):this.data.getIterator();n.hasNext();)if(!t(n.getNext().key))return}firstAfterOrEqual(t){const e=this.data.getIteratorFrom(t);return e.hasNext()?e.getNext().key:null}getIterator(){return new Li(this.data.getIterator())}getIteratorFrom(t){return new Li(this.data.getIteratorFrom(t))}add(t){return this.copy(this.data.remove(t).insert(t,!0))}delete(t){return this.has(t)?this.copy(this.data.remove(t)):this}isEmpty(){return this.data.isEmpty()}unionWith(t){let e=this;return e.size<t.size&&(e=t,t=this),t.forEach((t=>{e=e.add(t)})),e}isEqual(t){if(!(t instanceof Mi))return!1;if(this.size!==t.size)return!1;const e=this.data.getIterator(),n=t.data.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(0!==this.comparator(t,r))return!1}return!0}toArray(){const t=[];return this.forEach((e=>{t.push(e)})),t}toString(){const t=[];return this.forEach((e=>t.push(e))),"SortedSet("+t.toString()+")"}copy(t){const e=new Mi(this.comparator);return e.data=t,e}}class Li{constructor(t){this.iter=t}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Oi(t){return t.hasNext()?t.getNext():void 0}class Pi{constructor(t){this.fields=t,t.sort(bs.comparator)}static empty(){return new Pi([])}unionWith(t){let e=new Mi(bs.comparator);for(const t of this.fields)e=e.add(t);for(const n of t)e=e.add(n);return new Pi(e.toArray())}covers(t){for(const e of this.fields)if(e.isPrefixOf(t))return!0;return!1}isEqual(t){return fs(this.fields,t.fields,((t,e)=>t.isEqual(e)))}}class Fi extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function Vi(){return"undefined"!=typeof atob}class qi{constructor(t){this.binaryString=t}static fromBase64String(t){const e=function(t){try{return atob(t)}catch(t){throw"undefined"!=typeof DOMException&&t instanceof DOMException?new Fi("Invalid base64 string: "+t):t}}(t);return new qi(e)}static fromUint8Array(t){const e=function(t){let e="";for(let n=0;n<t.length;++n)e+=String.fromCharCode(t[n]);return e}(t);return new qi(e)}[Symbol.iterator](){let t=0;return{next:()=>t<this.binaryString.length?{value:this.binaryString.charCodeAt(t++),done:!1}:{value:void 0,done:!0}}}toBase64(){return function(t){return btoa(t)}(this.binaryString)}toUint8Array(){return function(t){const e=new Uint8Array(t.length);for(let n=0;n<t.length;n++)e[n]=t.charCodeAt(n);return e}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(t){return ds(this.binaryString,t.binaryString)}isEqual(t){return this.binaryString===t.binaryString}}qi.EMPTY_BYTE_STRING=new qi("");const Bi=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Ui(t){if(Wr(!!t),"string"==typeof t){let e=0;const n=Bi.exec(t);if(Wr(!!n),n[1]){let t=n[1];t=(t+"000000000").substr(0,9),e=Number(t)}const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}return{seconds:zi(t.seconds),nanos:zi(t.nanos)}}function zi(t){return"number"==typeof t?t:"string"==typeof t?Number(t):0}function Gi(t){return"string"==typeof t?qi.fromBase64String(t):qi.fromUint8Array(t)}function ji(t){var e,n;return"server_timestamp"===(null===(n=((null===(e=null==t?void 0:t.mapValue)||void 0===e?void 0:e.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Ki(t){const e=t.mapValue.fields.__previous_value__;return ji(e)?Ki(e):e}function $i(t){const e=Ui(t.mapValue.fields.__local_write_time__.timestampValue);return new ms(e.seconds,e.nanos)}class Qi{constructor(t,e,n,r,s,i,o,a,u){this.databaseId=t,this.appId=e,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=u}}class Hi{constructor(t,e){this.projectId=t,this.database=e||"(default)"}static empty(){return new Hi("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(t){return t instanceof Hi&&t.projectId===this.projectId&&t.database===this.database}}const Wi={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Yi={nullValue:"NULL_VALUE"};function Xi(t){return"nullValue"in t?0:"booleanValue"in t?1:"integerValue"in t||"doubleValue"in t?2:"timestampValue"in t?3:"stringValue"in t?5:"bytesValue"in t?6:"referenceValue"in t?7:"geoPointValue"in t?8:"arrayValue"in t?9:"mapValue"in t?ji(t)?4:fo(t)?9007199254740991:10:Hr()}function Ji(t,e){if(t===e)return!0;const n=Xi(t);if(n!==Xi(e))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return t.booleanValue===e.booleanValue;case 4:return $i(t).isEqual($i(e));case 3:return function(t,e){if("string"==typeof t.timestampValue&&"string"==typeof e.timestampValue&&t.timestampValue.length===e.timestampValue.length)return t.timestampValue===e.timestampValue;const n=Ui(t.timestampValue),r=Ui(e.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(t,e);case 5:return t.stringValue===e.stringValue;case 6:return function(t,e){return Gi(t.bytesValue).isEqual(Gi(e.bytesValue))}(t,e);case 7:return t.referenceValue===e.referenceValue;case 8:return function(t,e){return zi(t.geoPointValue.latitude)===zi(e.geoPointValue.latitude)&&zi(t.geoPointValue.longitude)===zi(e.geoPointValue.longitude)}(t,e);case 2:return function(t,e){if("integerValue"in t&&"integerValue"in e)return zi(t.integerValue)===zi(e.integerValue);if("doubleValue"in t&&"doubleValue"in e){const n=zi(t.doubleValue),r=zi(e.doubleValue);return n===r?Ys(n)===Ys(r):isNaN(n)&&isNaN(r)}return!1}(t,e);case 9:return fs(t.arrayValue.values||[],e.arrayValue.values||[],Ji);case 10:return function(t,e){const n=t.mapValue.fields||{},r=e.mapValue.fields||{};if(Ci(n)!==Ci(r))return!1;for(const t in n)if(n.hasOwnProperty(t)&&(void 0===r[t]||!Ji(n[t],r[t])))return!1;return!0}(t,e);default:return Hr()}}function Zi(t,e){return void 0!==(t.values||[]).find((t=>Ji(t,e)))}function to(t,e){if(t===e)return 0;const n=Xi(t),r=Xi(e);if(n!==r)return ds(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return ds(t.booleanValue,e.booleanValue);case 2:return function(t,e){const n=zi(t.integerValue||t.doubleValue),r=zi(e.integerValue||e.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(t,e);case 3:return eo(t.timestampValue,e.timestampValue);case 4:return eo($i(t),$i(e));case 5:return ds(t.stringValue,e.stringValue);case 6:return function(t,e){const n=Gi(t),r=Gi(e);return n.compareTo(r)}(t.bytesValue,e.bytesValue);case 7:return function(t,e){const n=t.split("/"),r=e.split("/");for(let t=0;t<n.length&&t<r.length;t++){const e=ds(n[t],r[t]);if(0!==e)return e}return ds(n.length,r.length)}(t.referenceValue,e.referenceValue);case 8:return function(t,e){const n=ds(zi(t.latitude),zi(e.latitude));return 0!==n?n:ds(zi(t.longitude),zi(e.longitude))}(t.geoPointValue,e.geoPointValue);case 9:return function(t,e){const n=t.values||[],r=e.values||[];for(let t=0;t<n.length&&t<r.length;++t){const e=to(n[t],r[t]);if(e)return e}return ds(n.length,r.length)}(t.arrayValue,e.arrayValue);case 10:return function(t,e){if(t===Wi.mapValue&&e===Wi.mapValue)return 0;if(t===Wi.mapValue)return 1;if(e===Wi.mapValue)return-1;const n=t.fields||{},r=Object.keys(n),s=e.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let t=0;t<r.length&&t<i.length;++t){const e=ds(r[t],i[t]);if(0!==e)return e;const o=to(n[r[t]],s[i[t]]);if(0!==o)return o}return ds(r.length,i.length)}(t.mapValue,e.mapValue);default:throw Hr()}}function eo(t,e){if("string"==typeof t&&"string"==typeof e&&t.length===e.length)return ds(t,e);const n=Ui(t),r=Ui(e),s=ds(n.seconds,r.seconds);return 0!==s?s:ds(n.nanos,r.nanos)}function no(t){return ro(t)}function ro(t){return"nullValue"in t?"null":"booleanValue"in t?""+t.booleanValue:"integerValue"in t?""+t.integerValue:"doubleValue"in t?""+t.doubleValue:"timestampValue"in t?function(t){const e=Ui(t);return`time(${e.seconds},${e.nanos})`}(t.timestampValue):"stringValue"in t?t.stringValue:"bytesValue"in t?function(t){return Gi(t).toBase64()}(t.bytesValue):"referenceValue"in t?function(t){return _s.fromName(t).toString()}(t.referenceValue):"geoPointValue"in t?function(t){return`geo(${t.latitude},${t.longitude})`}(t.geoPointValue):"arrayValue"in t?function(t){let e="[",n=!0;for(const r of t.values||[])n?n=!1:e+=",",e+=ro(r);return e+"]"}(t.arrayValue):"mapValue"in t?function(t){const e=Object.keys(t.fields||{}).sort();let n="{",r=!0;for(const s of e)r?r=!1:n+=",",n+=`${s}:${ro(t.fields[s])}`;return n+"}"}(t.mapValue):Hr()}function so(t){switch(Xi(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const e=Ki(t);return e?16+so(e):16;case 5:return 2*t.stringValue.length;case 6:return Gi(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return function(t){return(t.values||[]).reduce(((t,e)=>t+so(e)),0)}(t.arrayValue);case 10:return function(t){let e=0;return Di(t.fields,((t,n)=>{e+=t.length+so(n)})),e}(t.mapValue);default:throw Hr()}}function io(t,e){return{referenceValue:`projects/${t.projectId}/databases/${t.database}/documents/${e.path.canonicalString()}`}}function oo(t){return!!t&&"integerValue"in t}function ao(t){return!!t&&"arrayValue"in t}function uo(t){return!!t&&"nullValue"in t}function co(t){return!!t&&"doubleValue"in t&&isNaN(Number(t.doubleValue))}function lo(t){return!!t&&"mapValue"in t}function ho(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const e={mapValue:{fields:{}}};return Di(t.mapValue.fields,((t,n)=>e.mapValue.fields[t]=ho(n))),e}if(t.arrayValue){const e={arrayValue:{values:[]}};for(let n=0;n<(t.arrayValue.values||[]).length;++n)e.arrayValue.values[n]=ho(t.arrayValue.values[n]);return e}return Object.assign({},t)}function fo(t){return"__max__"===(((t.mapValue||{}).fields||{}).__type__||{}).stringValue}function go(t){return"nullValue"in t?Yi:"booleanValue"in t?{booleanValue:!1}:"integerValue"in t||"doubleValue"in t?{doubleValue:NaN}:"timestampValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in t?{stringValue:""}:"bytesValue"in t?{bytesValue:""}:"referenceValue"in t?io(Hi.empty(),_s.empty()):"geoPointValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in t?{arrayValue:{}}:"mapValue"in t?{mapValue:{}}:Hr()}function mo(t){return"nullValue"in t?{booleanValue:!1}:"booleanValue"in t?{doubleValue:NaN}:"integerValue"in t||"doubleValue"in t?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in t?{stringValue:""}:"stringValue"in t?{bytesValue:""}:"bytesValue"in t?io(Hi.empty(),_s.empty()):"referenceValue"in t?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in t?{arrayValue:{}}:"arrayValue"in t?{mapValue:{}}:"mapValue"in t?Wi:Hr()}function po(t,e){const n=to(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?-1:!t.inclusive&&e.inclusive?1:0}function yo(t,e){const n=to(t.value,e.value);return 0!==n?n:t.inclusive&&!e.inclusive?1:!t.inclusive&&e.inclusive?-1:0}class wo{constructor(t){this.value=t}static empty(){return new wo({mapValue:{}})}field(t){if(t.isEmpty())return this.value;{let e=this.value;for(let n=0;n<t.length-1;++n)if(e=(e.mapValue.fields||{})[t.get(n)],!lo(e))return null;return e=(e.mapValue.fields||{})[t.lastSegment()],e||null}}set(t,e){this.getFieldsMap(t.popLast())[t.lastSegment()]=ho(e)}setAll(t){let e=bs.emptyPath(),n={},r=[];t.forEach(((t,s)=>{if(!e.isImmediateParentOf(s)){const t=this.getFieldsMap(e);this.applyChanges(t,n,r),n={},r=[],e=s.popLast()}t?n[s.lastSegment()]=ho(t):r.push(s.lastSegment())}));const s=this.getFieldsMap(e);this.applyChanges(s,n,r)}delete(t){const e=this.field(t.popLast());lo(e)&&e.mapValue.fields&&delete e.mapValue.fields[t.lastSegment()]}isEqual(t){return Ji(this.value,t.value)}getFieldsMap(t){let e=this.value;e.mapValue.fields||(e.mapValue={fields:{}});for(let n=0;n<t.length;++n){let r=e.mapValue.fields[t.get(n)];lo(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},e.mapValue.fields[t.get(n)]=r),e=r}return e.mapValue.fields}applyChanges(t,e,n){Di(e,((e,n)=>t[e]=n));for(const e of n)delete t[e]}clone(){return new wo(ho(this.value))}}function vo(t){const e=[];return Di(t.fields,((t,n)=>{const r=new bs([t]);if(lo(n)){const t=vo(n.mapValue).fields;if(0===t.length)e.push(r);else for(const n of t)e.push(r.child(n))}else e.push(r)})),new Pi(e)}class bo{constructor(t,e,n,r,s,i,o){this.key=t,this.documentType=e,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(t){return new bo(t,0,ps.min(),ps.min(),ps.min(),wo.empty(),0)}static newFoundDocument(t,e,n,r){return new bo(t,1,e,ps.min(),n,r,0)}static newNoDocument(t,e){return new bo(t,2,e,ps.min(),ps.min(),wo.empty(),0)}static newUnknownDocument(t,e){return new bo(t,3,e,ps.min(),ps.min(),wo.empty(),2)}convertToFoundDocument(t,e){return!this.createTime.isEqual(ps.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=t),this.version=t,this.documentType=1,this.data=e,this.documentState=0,this}convertToNoDocument(t){return this.version=t,this.documentType=2,this.data=wo.empty(),this.documentState=0,this}convertToUnknownDocument(t){return this.version=t,this.documentType=3,this.data=wo.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=ps.min(),this}setReadTime(t){return this.readTime=t,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(t){return t instanceof bo&&this.key.isEqual(t.key)&&this.version.isEqual(t.version)&&this.documentType===t.documentType&&this.documentState===t.documentState&&this.data.isEqual(t.data)}mutableCopy(){return new bo(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class _o{constructor(t,e){this.position=t,this.inclusive=e}}function Io(t,e,n){let r=0;for(let s=0;s<t.position.length;s++){const i=e[s],o=t.position[s];if(r=i.field.isKeyField()?_s.comparator(_s.fromName(o.referenceValue),n.key):to(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Eo(t,e){if(null===t)return null===e;if(null===e)return!1;if(t.inclusive!==e.inclusive||t.position.length!==e.position.length)return!1;for(let n=0;n<t.position.length;n++)if(!Ji(t.position[n],e.position[n]))return!1;return!0}class To{constructor(t,e="asc"){this.field=t,this.dir=e}}function So(t,e){return t.dir===e.dir&&t.field.isEqual(e.field)}class xo{}class Co extends xo{constructor(t,e,n){super(),this.field=t,this.op=e,this.value=n}static create(t,e,n){return t.isKeyField()?"in"===e||"not-in"===e?this.createKeyFieldInFilter(t,e,n):new Fo(t,e,n):"array-contains"===e?new Uo(t,n):"in"===e?new zo(t,n):"not-in"===e?new Go(t,n):"array-contains-any"===e?new jo(t,n):new Co(t,e,n)}static createKeyFieldInFilter(t,e,n){return"in"===e?new Vo(t,n):new qo(t,n)}matches(t){const e=t.data.field(this.field);return"!="===this.op?null!==e&&this.matchesComparison(to(e,this.value)):null!==e&&Xi(this.value)===Xi(e)&&this.matchesComparison(to(e,this.value))}matchesComparison(t){switch(this.op){case"<":return t<0;case"<=":return t<=0;case"==":return 0===t;case"!=":return 0!==t;case">":return t>0;case">=":return t>=0;default:return Hr()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class Do extends xo{constructor(t,e){super(),this.filters=t,this.op=e,this.ue=null}static create(t,e){return new Do(t,e)}matches(t){return Ao(this)?void 0===this.filters.find((e=>!e.matches(t))):void 0!==this.filters.find((e=>e.matches(t)))}getFlattenedFilters(){return null!==this.ue||(this.ue=this.filters.reduce(((t,e)=>t.concat(e.getFlattenedFilters())),[])),this.ue}getFilters(){return Object.assign([],this.filters)}}function Ao(t){return"and"===t.op}function No(t){return"or"===t.op}function ko(t){return Ro(t)&&Ao(t)}function Ro(t){for(const e of t.filters)if(e instanceof Do)return!1;return!0}function Mo(t){if(t instanceof Co)return t.field.canonicalString()+t.op.toString()+no(t.value);if(ko(t))return t.filters.map((t=>Mo(t))).join(",");{const e=t.filters.map((t=>Mo(t))).join(",");return`${t.op}(${e})`}}function Lo(t,e){return t instanceof Co?function(t,e){return e instanceof Co&&t.op===e.op&&t.field.isEqual(e.field)&&Ji(t.value,e.value)}(t,e):t instanceof Do?function(t,e){return e instanceof Do&&t.op===e.op&&t.filters.length===e.filters.length&&t.filters.reduce(((t,n,r)=>t&&Lo(n,e.filters[r])),!0)}(t,e):void Hr()}function Oo(t,e){const n=t.filters.concat(e);return Do.create(n,t.op)}function Po(t){return t instanceof Co?function(t){return`${t.field.canonicalString()} ${t.op} ${no(t.value)}`}(t):t instanceof Do?function(t){return t.op.toString()+" {"+t.getFilters().map(Po).join(" ,")+"}"}(t):"Filter"}class Fo extends Co{constructor(t,e,n){super(t,e,n),this.key=_s.fromName(n.referenceValue)}matches(t){const e=_s.comparator(t.key,this.key);return this.matchesComparison(e)}}class Vo extends Co{constructor(t,e){super(t,"in",e),this.keys=Bo("in",e)}matches(t){return this.keys.some((e=>e.isEqual(t.key)))}}class qo extends Co{constructor(t,e){super(t,"not-in",e),this.keys=Bo("not-in",e)}matches(t){return!this.keys.some((e=>e.isEqual(t.key)))}}function Bo(t,e){var n;return((null===(n=e.arrayValue)||void 0===n?void 0:n.values)||[]).map((t=>_s.fromName(t.referenceValue)))}class Uo extends Co{constructor(t,e){super(t,"array-contains",e)}matches(t){const e=t.data.field(this.field);return ao(e)&&Zi(e.arrayValue,this.value)}}class zo extends Co{constructor(t,e){super(t,"in",e)}matches(t){const e=t.data.field(this.field);return null!==e&&Zi(this.value.arrayValue,e)}}class Go extends Co{constructor(t,e){super(t,"not-in",e)}matches(t){if(Zi(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const e=t.data.field(this.field);return null!==e&&!Zi(this.value.arrayValue,e)}}class jo extends Co{constructor(t,e){super(t,"array-contains-any",e)}matches(t){const e=t.data.field(this.field);return!(!ao(e)||!e.arrayValue.values)&&e.arrayValue.values.some((t=>Zi(this.value.arrayValue,t)))}}class Ko{constructor(t,e=null,n=[],r=[],s=null,i=null,o=null){this.path=t,this.collectionGroup=e,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.ce=null}}function $o(t,e=null,n=[],r=[],s=null,i=null,o=null){return new Ko(t,e,n,r,s,i,o)}function Qo(t){const e=Xr(t);if(null===e.ce){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map((t=>Mo(t))).join(","),t+="|ob:",t+=e.orderBy.map((t=>function(t){return t.field.canonicalString()+t.dir}(t))).join(","),Ws(e.limit)||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((t=>no(t))).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((t=>no(t))).join(",")),e.ce=t}return e.ce}function Ho(t,e){if(t.limit!==e.limit)return!1;if(t.orderBy.length!==e.orderBy.length)return!1;for(let n=0;n<t.orderBy.length;n++)if(!So(t.orderBy[n],e.orderBy[n]))return!1;if(t.filters.length!==e.filters.length)return!1;for(let n=0;n<t.filters.length;n++)if(!Lo(t.filters[n],e.filters[n]))return!1;return t.collectionGroup===e.collectionGroup&&!!t.path.isEqual(e.path)&&!!Eo(t.startAt,e.startAt)&&Eo(t.endAt,e.endAt)}function Wo(t){return _s.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}function Yo(t,e){return t.filters.filter((t=>t instanceof Co&&t.field.isEqual(e)))}function Xo(t,e,n){let r=Yi,s=!0;for(const n of Yo(t,e)){let t=Yi,e=!0;switch(n.op){case"<":case"<=":t=go(n.value);break;case"==":case"in":case">=":t=n.value;break;case">":t=n.value,e=!1;break;case"!=":case"not-in":t=Yi}po({value:r,inclusive:s},{value:t,inclusive:e})<0&&(r=t,s=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];po({value:r,inclusive:s},{value:t,inclusive:n.inclusive})<0&&(r=t,s=n.inclusive);break}return{value:r,inclusive:s}}function Jo(t,e,n){let r=Wi,s=!0;for(const n of Yo(t,e)){let t=Wi,e=!0;switch(n.op){case">=":case">":t=mo(n.value),e=!1;break;case"==":case"in":case"<=":t=n.value;break;case"<":t=n.value,e=!1;break;case"!=":case"not-in":t=Wi}yo({value:r,inclusive:s},{value:t,inclusive:e})>0&&(r=t,s=e)}if(null!==n)for(let i=0;i<t.orderBy.length;++i)if(t.orderBy[i].field.isEqual(e)){const t=n.position[i];yo({value:r,inclusive:s},{value:t,inclusive:n.inclusive})>0&&(r=t,s=n.inclusive);break}return{value:r,inclusive:s}}class Zo{constructor(t,e=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=t,this.collectionGroup=e,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.le=null,this.he=null,this.Pe=null,this.startAt,this.endAt}}function ta(t,e,n,r,s,i,o,a){return new Zo(t,e,n,r,s,i,o,a)}function ea(t){return new Zo(t)}function na(t){return 0===t.filters.length&&null===t.limit&&null==t.startAt&&null==t.endAt&&(0===t.explicitOrderBy.length||1===t.explicitOrderBy.length&&t.explicitOrderBy[0].field.isKeyField())}function ra(t){return null!==t.collectionGroup}function sa(t){const e=Xr(t);if(null===e.le){e.le=[];const t=new Set;for(const n of e.explicitOrderBy)e.le.push(n),t.add(n.field.canonicalString());const n=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc",r=function(t){let e=new Mi(bs.comparator);return t.filters.forEach((t=>{t.getFlattenedFilters().forEach((t=>{t.isInequality()&&(e=e.add(t.field))}))})),e}(e);r.forEach((r=>{t.has(r.canonicalString())||r.isKeyField()||e.le.push(new To(r,n))})),t.has(bs.keyField().canonicalString())||e.le.push(new To(bs.keyField(),n))}return e.le}function ia(t){const e=Xr(t);return e.he||(e.he=oa(e,sa(t))),e.he}function oa(t,e){if("F"===t.limitType)return $o(t.path,t.collectionGroup,e,t.filters,t.limit,t.startAt,t.endAt);{e=e.map((t=>{const e="desc"===t.dir?"asc":"desc";return new To(t.field,e)}));const n=t.endAt?new _o(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new _o(t.startAt.position,t.startAt.inclusive):null;return $o(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}}function aa(t,e){const n=t.filters.concat([e]);return new Zo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),n,t.limit,t.limitType,t.startAt,t.endAt)}function ua(t,e,n){return new Zo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),e,n,t.startAt,t.endAt)}function ca(t,e){return Ho(ia(t),ia(e))&&t.limitType===e.limitType}function la(t){return`${Qo(ia(t))}|lt:${t.limitType}`}function ha(t){return`Query(target=${function(t){let e=t.path.canonicalString();return null!==t.collectionGroup&&(e+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(e+=`, filters: [${t.filters.map((t=>Po(t))).join(", ")}]`),Ws(t.limit)||(e+=", limit: "+t.limit),t.orderBy.length>0&&(e+=`, orderBy: [${t.orderBy.map((t=>function(t){return`${t.field.canonicalString()} (${t.dir})`}(t))).join(", ")}]`),t.startAt&&(e+=", startAt: ",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((t=>no(t))).join(",")),t.endAt&&(e+=", endAt: ",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((t=>no(t))).join(",")),`Target(${e})`}(ia(t))}; limitType=${t.limitType})`}function da(t,e){return e.isFoundDocument()&&function(t,e){const n=e.key.path;return null!==t.collectionGroup?e.key.hasCollectionId(t.collectionGroup)&&t.path.isPrefixOf(n):_s.isDocumentKey(t.path)?t.path.isEqual(n):t.path.isImmediateParentOf(n)}(t,e)&&function(t,e){for(const n of sa(t))if(!n.field.isKeyField()&&null===e.data.field(n.field))return!1;return!0}(t,e)&&function(t,e){for(const n of t.filters)if(!n.matches(e))return!1;return!0}(t,e)&&function(t,e){return!(t.startAt&&!function(t,e,n){const r=Io(t,e,n);return t.inclusive?r<=0:r<0}(t.startAt,sa(t),e)||t.endAt&&!function(t,e,n){const r=Io(t,e,n);return t.inclusive?r>=0:r>0}(t.endAt,sa(t),e))}(t,e)}function fa(t){return t.collectionGroup||(t.path.length%2==1?t.path.lastSegment():t.path.get(t.path.length-2))}function ga(t){return(e,n)=>{let r=!1;for(const s of sa(t)){const t=ma(s,e,n);if(0!==t)return t;r=r||s.field.isKeyField()}return 0}}function ma(t,e,n){const r=t.field.isKeyField()?_s.comparator(e.key,n.key):function(t,e,n){const r=e.data.field(t),s=n.data.field(t);return null!==r&&null!==s?to(r,s):Hr()}(t.field,e,n);switch(t.dir){case"asc":return r;case"desc":return-1*r;default:return Hr()}}class pa{constructor(t,e){this.mapKeyFn=t,this.equalsFn=e,this.inner={},this.innerSize=0}get(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0!==n)for(const[e,r]of n)if(this.equalsFn(e,t))return r}has(t){return void 0!==this.get(t)}set(t,e){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0===r)return this.inner[n]=[[t,e]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],t))return void(r[n]=[t,e]);r.push([t,e]),this.innerSize++}delete(t){const e=this.mapKeyFn(t),n=this.inner[e];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],t))return 1===n.length?delete this.inner[e]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(t){Di(this.inner,((e,n)=>{for(const[e,r]of n)t(e,r)}))}isEmpty(){return Ai(this.inner)}size(){return this.innerSize}}const ya=new Ni(_s.comparator);function wa(){return ya}const va=new Ni(_s.comparator);function ba(...t){let e=va;for(const n of t)e=e.insert(n.key,n);return e}function _a(t){let e=va;return t.forEach(((t,n)=>e=e.insert(t,n.overlayedDocument))),e}function Ia(){return Ta()}function Ea(){return Ta()}function Ta(){return new pa((t=>t.toString()),((t,e)=>t.isEqual(e)))}const Sa=new Ni(_s.comparator),xa=new Mi(_s.comparator);function Ca(...t){let e=xa;for(const n of t)e=e.add(n);return e}const Da=new Mi(ds);function Aa(){return Da}function Na(t,e){if(t.useProto3Json){if(isNaN(e))return{doubleValue:"NaN"};if(e===1/0)return{doubleValue:"Infinity"};if(e===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Ys(e)?"-0":e}}function ka(t){return{integerValue:""+t}}function Ra(t,e){return Xs(e)?ka(e):Na(t,e)}class Ma{constructor(){this._=void 0}}function La(t,e,n){return t instanceof Fa?function(t,e){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:t.seconds,nanos:t.nanoseconds}}}};return e&&ji(e)&&(e=Ki(e)),e&&(n.fields.__previous_value__=e),{mapValue:n}}(n,e):t instanceof Va?qa(t,e):t instanceof Ba?Ua(t,e):function(t,e){const n=Pa(t,e),r=Ga(n)+Ga(t.Ie);return oo(n)&&oo(t.Ie)?ka(r):Na(t.serializer,r)}(t,e)}function Oa(t,e,n){return t instanceof Va?qa(t,e):t instanceof Ba?Ua(t,e):n}function Pa(t,e){return t instanceof za?function(t){return oo(t)||function(t){return!!t&&"doubleValue"in t}(t)}(e)?e:{integerValue:0}:null}class Fa extends Ma{}class Va extends Ma{constructor(t){super(),this.elements=t}}function qa(t,e){const n=ja(e);for(const e of t.elements)n.some((t=>Ji(t,e)))||n.push(e);return{arrayValue:{values:n}}}class Ba extends Ma{constructor(t){super(),this.elements=t}}function Ua(t,e){let n=ja(e);for(const e of t.elements)n=n.filter((t=>!Ji(t,e)));return{arrayValue:{values:n}}}class za extends Ma{constructor(t,e){super(),this.serializer=t,this.Ie=e}}function Ga(t){return zi(t.integerValue||t.doubleValue)}function ja(t){return ao(t)&&t.arrayValue.values?t.arrayValue.values.slice():[]}class Ka{constructor(t,e){this.field=t,this.transform=e}}class $a{constructor(t,e){this.version=t,this.transformResults=e}}class Qa{constructor(t,e){this.updateTime=t,this.exists=e}static none(){return new Qa}static exists(t){return new Qa(void 0,t)}static updateTime(t){return new Qa(t)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(t){return this.exists===t.exists&&(this.updateTime?!!t.updateTime&&this.updateTime.isEqual(t.updateTime):!t.updateTime)}}function Ha(t,e){return void 0!==t.updateTime?e.isFoundDocument()&&e.version.isEqual(t.updateTime):void 0===t.exists||t.exists===e.isFoundDocument()}class Wa{}function Ya(t,e){if(!t.hasLocalMutations||e&&0===e.fields.length)return null;if(null===e)return t.isNoDocument()?new ou(t.key,Qa.none()):new eu(t.key,t.data,Qa.none());{const n=t.data,r=wo.empty();let s=new Mi(bs.comparator);for(let t of e.fields)if(!s.has(t)){let e=n.field(t);null===e&&t.length>1&&(t=t.popLast(),e=n.field(t)),null===e?r.delete(t):r.set(t,e),s=s.add(t)}return new nu(t.key,r,new Pi(s.toArray()),Qa.none())}}function Xa(t,e,n){t instanceof eu?function(t,e,n){const r=t.value.clone(),s=su(t.fieldTransforms,e,n.transformResults);r.setAll(s),e.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(t,e,n):t instanceof nu?function(t,e,n){if(!Ha(t.precondition,e))return void e.convertToUnknownDocument(n.version);const r=su(t.fieldTransforms,e,n.transformResults),s=e.data;s.setAll(ru(t)),s.setAll(r),e.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(t,e,n):function(t,e,n){e.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,n)}function Ja(t,e,n,r){return t instanceof eu?function(t,e,n,r){if(!Ha(t.precondition,e))return n;const s=t.value.clone(),i=iu(t.fieldTransforms,r,e);return s.setAll(i),e.convertToFoundDocument(e.version,s).setHasLocalMutations(),null}(t,e,n,r):t instanceof nu?function(t,e,n,r){if(!Ha(t.precondition,e))return n;const s=iu(t.fieldTransforms,r,e),i=e.data;return i.setAll(ru(t)),i.setAll(s),e.convertToFoundDocument(e.version,i).setHasLocalMutations(),null===n?null:n.unionWith(t.fieldMask.fields).unionWith(t.fieldTransforms.map((t=>t.field)))}(t,e,n,r):function(t,e,n){return Ha(t.precondition,e)?(e.convertToNoDocument(e.version).setHasLocalMutations(),null):n}(t,e,n)}function Za(t,e){let n=null;for(const r of t.fieldTransforms){const t=e.data.field(r.field),s=Pa(r.transform,t||null);null!=s&&(null===n&&(n=wo.empty()),n.set(r.field,s))}return n||null}function tu(t,e){return t.type===e.type&&!!t.key.isEqual(e.key)&&!!t.precondition.isEqual(e.precondition)&&!!function(t,e){return void 0===t&&void 0===e||!(!t||!e)&&fs(t,e,((t,e)=>function(t,e){return t.field.isEqual(e.field)&&function(t,e){return t instanceof Va&&e instanceof Va||t instanceof Ba&&e instanceof Ba?fs(t.elements,e.elements,Ji):t instanceof za&&e instanceof za?Ji(t.Ie,e.Ie):t instanceof Fa&&e instanceof Fa}(t.transform,e.transform)}(t,e)))}(t.fieldTransforms,e.fieldTransforms)&&(0===t.type?t.value.isEqual(e.value):1!==t.type||t.data.isEqual(e.data)&&t.fieldMask.isEqual(e.fieldMask))}class eu extends Wa{constructor(t,e,n,r=[]){super(),this.key=t,this.value=e,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class nu extends Wa{constructor(t,e,n,r,s=[]){super(),this.key=t,this.data=e,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function ru(t){const e=new Map;return t.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=t.data.field(n);e.set(n,r)}})),e}function su(t,e,n){const r=new Map;Wr(t.length===n.length);for(let s=0;s<n.length;s++){const i=t[s],o=i.transform,a=e.data.field(i.field);r.set(i.field,Oa(o,a,n[s]))}return r}function iu(t,e,n){const r=new Map;for(const s of t){const t=s.transform,i=n.data.field(s.field);r.set(s.field,La(t,i,e))}return r}class ou extends Wa{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class au extends Wa{constructor(t,e){super(),this.key=t,this.precondition=e,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class uu{constructor(t,e,n,r){this.batchId=t,this.localWriteTime=e,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){const n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const r=this.mutations[e];r.key.isEqual(t.key)&&Xa(r,t,n[e])}}applyToLocalView(t,e){for(const n of this.baseMutations)n.key.isEqual(t.key)&&(e=Ja(n,t,e,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(t.key)&&(e=Ja(n,t,e,this.localWriteTime));return e}applyToLocalDocumentSet(t,e){const n=Ea();return this.mutations.forEach((r=>{const s=t.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=e.has(r.key)?null:o;const a=Ya(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(ps.min())})),n}keys(){return this.mutations.reduce(((t,e)=>t.add(e.key)),Ca())}isEqual(t){return this.batchId===t.batchId&&fs(this.mutations,t.mutations,((t,e)=>tu(t,e)))&&fs(this.baseMutations,t.baseMutations,((t,e)=>tu(t,e)))}}class cu{constructor(t,e,n,r){this.batch=t,this.commitVersion=e,this.mutationResults=n,this.docVersions=r}static from(t,e,n){Wr(t.mutations.length===n.length);let r=Sa;const s=t.mutations;for(let t=0;t<s.length;t++)r=r.insert(s[t].key,n[t].version);return new cu(t,e,n,r)}}class lu{constructor(t,e){this.largestBatchId=t,this.mutation=e}getKey(){return this.mutation.key}isEqual(t){return null!==t&&this.mutation===t.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class hu{constructor(t,e,n){this.alias=t,this.aggregateType=e,this.fieldPath=n}}class du{constructor(t,e){this.count=t,this.unchangedNames=e}}var fu,gu;function mu(t){switch(t){default:return Hr();case Jr.CANCELLED:case Jr.UNKNOWN:case Jr.DEADLINE_EXCEEDED:case Jr.RESOURCE_EXHAUSTED:case Jr.INTERNAL:case Jr.UNAVAILABLE:case Jr.UNAUTHENTICATED:return!1;case Jr.INVALID_ARGUMENT:case Jr.NOT_FOUND:case Jr.ALREADY_EXISTS:case Jr.PERMISSION_DENIED:case Jr.FAILED_PRECONDITION:case Jr.ABORTED:case Jr.OUT_OF_RANGE:case Jr.UNIMPLEMENTED:case Jr.DATA_LOSS:return!0}}function pu(t){if(void 0===t)return Kr("GRPC error has no .code"),Jr.UNKNOWN;switch(t){case fu.OK:return Jr.OK;case fu.CANCELLED:return Jr.CANCELLED;case fu.UNKNOWN:return Jr.UNKNOWN;case fu.DEADLINE_EXCEEDED:return Jr.DEADLINE_EXCEEDED;case fu.RESOURCE_EXHAUSTED:return Jr.RESOURCE_EXHAUSTED;case fu.INTERNAL:return Jr.INTERNAL;case fu.UNAVAILABLE:return Jr.UNAVAILABLE;case fu.UNAUTHENTICATED:return Jr.UNAUTHENTICATED;case fu.INVALID_ARGUMENT:return Jr.INVALID_ARGUMENT;case fu.NOT_FOUND:return Jr.NOT_FOUND;case fu.ALREADY_EXISTS:return Jr.ALREADY_EXISTS;case fu.PERMISSION_DENIED:return Jr.PERMISSION_DENIED;case fu.FAILED_PRECONDITION:return Jr.FAILED_PRECONDITION;case fu.ABORTED:return Jr.ABORTED;case fu.OUT_OF_RANGE:return Jr.OUT_OF_RANGE;case fu.UNIMPLEMENTED:return Jr.UNIMPLEMENTED;case fu.DATA_LOSS:return Jr.DATA_LOSS;default:return Hr()}}(gu=fu||(fu={}))[gu.OK=0]="OK",gu[gu.CANCELLED=1]="CANCELLED",gu[gu.UNKNOWN=2]="UNKNOWN",gu[gu.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",gu[gu.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",gu[gu.NOT_FOUND=5]="NOT_FOUND",gu[gu.ALREADY_EXISTS=6]="ALREADY_EXISTS",gu[gu.PERMISSION_DENIED=7]="PERMISSION_DENIED",gu[gu.UNAUTHENTICATED=16]="UNAUTHENTICATED",gu[gu.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",gu[gu.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",gu[gu.ABORTED=10]="ABORTED",gu[gu.OUT_OF_RANGE=11]="OUT_OF_RANGE",gu[gu.UNIMPLEMENTED=12]="UNIMPLEMENTED",gu[gu.INTERNAL=13]="INTERNAL",gu[gu.UNAVAILABLE=14]="UNAVAILABLE",gu[gu.DATA_LOSS=15]="DATA_LOSS";let yu=null;function wu(){return new TextEncoder}const vu=new Fr([4294967295,4294967295],0);function bu(t){const e=wu().encode(t),n=new Pr;return n.update(e),new Uint8Array(n.digest())}function _u(t){const e=new DataView(t.buffer),n=e.getUint32(0,!0),r=e.getUint32(4,!0),s=e.getUint32(8,!0),i=e.getUint32(12,!0);return[new Fr([n,r],0),new Fr([s,i],0)]}class Iu{constructor(t,e,n){if(this.bitmap=t,this.padding=e,this.hashCount=n,e<0||e>=8)throw new Eu(`Invalid padding: ${e}`);if(n<0)throw new Eu(`Invalid hash count: ${n}`);if(t.length>0&&0===this.hashCount)throw new Eu(`Invalid hash count: ${n}`);if(0===t.length&&0!==e)throw new Eu(`Invalid padding when bitmap length is 0: ${e}`);this.Te=8*t.length-e,this.Ee=Fr.fromNumber(this.Te)}de(t,e,n){let r=t.add(e.multiply(Fr.fromNumber(n)));return 1===r.compare(vu)&&(r=new Fr([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Ee).toNumber()}Ae(t){return 0!=(this.bitmap[Math.floor(t/8)]&1<<t%8)}mightContain(t){if(0===this.Te)return!1;const e=bu(t),[n,r]=_u(e);for(let t=0;t<this.hashCount;t++){const e=this.de(n,r,t);if(!this.Ae(e))return!1}return!0}static create(t,e,n){const r=t%8==0?0:8-t%8,s=new Uint8Array(Math.ceil(t/8)),i=new Iu(s,r,e);return n.forEach((t=>i.insert(t))),i}insert(t){if(0===this.Te)return;const e=bu(t),[n,r]=_u(e);for(let t=0;t<this.hashCount;t++){const e=this.de(n,r,t);this.Re(e)}}Re(t){const e=Math.floor(t/8),n=t%8;this.bitmap[e]|=1<<n}}class Eu extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Tu{constructor(t,e,n,r,s){this.snapshotVersion=t,this.targetChanges=e,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(t,e,n){const r=new Map;return r.set(t,Su.createSynthesizedTargetChangeForCurrentChange(t,e,n)),new Tu(ps.min(),r,new Ni(ds),wa(),Ca())}}class Su{constructor(t,e,n,r,s){this.resumeToken=t,this.current=e,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(t,e,n){return new Su(n,e,Ca(),Ca(),Ca())}}class xu{constructor(t,e,n,r){this.Ve=t,this.removedTargetIds=e,this.key=n,this.me=r}}class Cu{constructor(t,e){this.targetId=t,this.fe=e}}class Du{constructor(t,e,n=qi.EMPTY_BYTE_STRING,r=null){this.state=t,this.targetIds=e,this.resumeToken=n,this.cause=r}}class Au{constructor(){this.ge=0,this.pe=Ru(),this.ye=qi.EMPTY_BYTE_STRING,this.we=!1,this.Se=!0}get current(){return this.we}get resumeToken(){return this.ye}get be(){return 0!==this.ge}get De(){return this.Se}Ce(t){t.approximateByteSize()>0&&(this.Se=!0,this.ye=t)}ve(){let t=Ca(),e=Ca(),n=Ca();return this.pe.forEach(((r,s)=>{switch(s){case 0:t=t.add(r);break;case 2:e=e.add(r);break;case 1:n=n.add(r);break;default:Hr()}})),new Su(this.ye,this.we,t,e,n)}Fe(){this.Se=!1,this.pe=Ru()}Me(t,e){this.Se=!0,this.pe=this.pe.insert(t,e)}xe(t){this.Se=!0,this.pe=this.pe.remove(t)}Oe(){this.ge+=1}Ne(){this.ge-=1,Wr(this.ge>=0)}Be(){this.Se=!0,this.we=!0}}class Nu{constructor(t){this.Le=t,this.ke=new Map,this.qe=wa(),this.Qe=ku(),this.Ke=new Ni(ds)}$e(t){for(const e of t.Ve)t.me&&t.me.isFoundDocument()?this.Ue(e,t.me):this.We(e,t.key,t.me);for(const e of t.removedTargetIds)this.We(e,t.key,t.me)}Ge(t){this.forEachTarget(t,(e=>{const n=this.ze(e);switch(t.state){case 0:this.je(e)&&n.Ce(t.resumeToken);break;case 1:n.Ne(),n.be||n.Fe(),n.Ce(t.resumeToken);break;case 2:n.Ne(),n.be||this.removeTarget(e);break;case 3:this.je(e)&&(n.Be(),n.Ce(t.resumeToken));break;case 4:this.je(e)&&(this.He(e),n.Ce(t.resumeToken));break;default:Hr()}}))}forEachTarget(t,e){t.targetIds.length>0?t.targetIds.forEach(e):this.ke.forEach(((t,n)=>{this.je(n)&&e(n)}))}Je(t){const e=t.targetId,n=t.fe.count,r=this.Ye(e);if(r){const s=r.target;if(Wo(s))if(0===n){const t=new _s(s.path);this.We(e,t,bo.newNoDocument(t,ps.min()))}else Wr(1===n);else{const r=this.Ze(e);if(r!==n){const n=this.Xe(t),s=n?this.et(n,t,r):1;if(0!==s){this.He(e);const t=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ke=this.Ke.insert(e,t)}null==yu||yu.tt(function(t,e,n,r,s){var i,o,a,u,c,l;const h={localCacheCount:t,existenceFilterCount:e.count,databaseId:n.database,projectId:n.projectId},d=e.unchangedNames;return d&&(h.bloomFilter={applied:0===s,hashCount:null!==(i=null==d?void 0:d.hashCount)&&void 0!==i?i:0,bitmapLength:null!==(u=null===(a=null===(o=null==d?void 0:d.bits)||void 0===o?void 0:o.bitmap)||void 0===a?void 0:a.length)&&void 0!==u?u:0,padding:null!==(l=null===(c=null==d?void 0:d.bits)||void 0===c?void 0:c.padding)&&void 0!==l?l:0,mightContain:t=>{var e;return null!==(e=null==r?void 0:r.mightContain(t))&&void 0!==e&&e}}),h}(r,t.fe,this.Le.nt(),n,s))}}}}Xe(t){const e=t.fe.unchangedNames;if(!e||!e.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:s=0}=e;let i,o;try{i=Gi(n).toUint8Array()}catch(t){if(t instanceof Fi)return $r("Decoding the base64 bloom filter in existence filter failed ("+t.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw t}try{o=new Iu(i,r,s)}catch(t){return $r(t instanceof Eu?"BloomFilter error: ":"Applying bloom filter failed: ",t),null}return 0===o.Te?null:o}et(t,e,n){return e.fe.count===n-this.rt(t,e.targetId)?0:2}rt(t,e){const n=this.Le.getRemoteKeysForTarget(e);let r=0;return n.forEach((n=>{const s=this.Le.nt(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;t.mightContain(i)||(this.We(e,n,null),r++)})),r}it(t){const e=new Map;this.ke.forEach(((n,r)=>{const s=this.Ye(r);if(s){if(n.current&&Wo(s.target)){const e=new _s(s.target.path);null!==this.qe.get(e)||this.st(r,e)||this.We(r,e,bo.newNoDocument(e,t))}n.De&&(e.set(r,n.ve()),n.Fe())}}));let n=Ca();this.Qe.forEach(((t,e)=>{let r=!0;e.forEachWhile((t=>{const e=this.Ye(t);return!e||"TargetPurposeLimboResolution"===e.purpose||(r=!1,!1)})),r&&(n=n.add(t))})),this.qe.forEach(((e,n)=>n.setReadTime(t)));const r=new Tu(t,e,this.Ke,this.qe,n);return this.qe=wa(),this.Qe=ku(),this.Ke=new Ni(ds),r}Ue(t,e){if(!this.je(t))return;const n=this.st(t,e.key)?2:0;this.ze(t).Me(e.key,n),this.qe=this.qe.insert(e.key,e),this.Qe=this.Qe.insert(e.key,this.ot(e.key).add(t))}We(t,e,n){if(!this.je(t))return;const r=this.ze(t);this.st(t,e)?r.Me(e,1):r.xe(e),this.Qe=this.Qe.insert(e,this.ot(e).delete(t)),n&&(this.qe=this.qe.insert(e,n))}removeTarget(t){this.ke.delete(t)}Ze(t){const e=this.ze(t).ve();return this.Le.getRemoteKeysForTarget(t).size+e.addedDocuments.size-e.removedDocuments.size}Oe(t){this.ze(t).Oe()}ze(t){let e=this.ke.get(t);return e||(e=new Au,this.ke.set(t,e)),e}ot(t){let e=this.Qe.get(t);return e||(e=new Mi(ds),this.Qe=this.Qe.insert(t,e)),e}je(t){const e=null!==this.Ye(t);return e||jr("WatchChangeAggregator","Detected inactive target",t),e}Ye(t){const e=this.ke.get(t);return e&&e.be?null:this.Le._t(t)}He(t){this.ke.set(t,new Au),this.Le.getRemoteKeysForTarget(t).forEach((e=>{this.We(t,e,null)}))}st(t,e){return this.Le.getRemoteKeysForTarget(t).has(e)}}function ku(){return new Ni(_s.comparator)}function Ru(){return new Ni(_s.comparator)}const Mu={asc:"ASCENDING",desc:"DESCENDING"},Lu={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},Ou={and:"AND",or:"OR"};class Pu{constructor(t,e){this.databaseId=t,this.useProto3Json=e}}function Fu(t,e){return t.useProto3Json||Ws(e)?e:{value:e}}function Vu(t,e){return t.useProto3Json?`${new Date(1e3*e.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+e.nanoseconds).slice(-9)}Z`:{seconds:""+e.seconds,nanos:e.nanoseconds}}function qu(t,e){return t.useProto3Json?e.toBase64():e.toUint8Array()}function Bu(t,e){return Vu(t,e.toTimestamp())}function Uu(t){return Wr(!!t),ps.fromTimestamp(function(t){const e=Ui(t);return new ms(e.seconds,e.nanos)}(t))}function zu(t,e){return Gu(t,e).canonicalString()}function Gu(t,e){const n=function(t){return new ws(["projects",t.projectId,"databases",t.database])}(t).child("documents");return void 0===e?n:n.child(e)}function ju(t){const e=ws.fromString(t);return Wr(dc(e)),e}function Ku(t,e){return zu(t.databaseId,e.path)}function $u(t,e){const n=ju(e);if(n.get(1)!==t.databaseId.projectId)throw new Zr(Jr.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+t.databaseId.projectId);if(n.get(3)!==t.databaseId.database)throw new Zr(Jr.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+t.databaseId.database);return new _s(Yu(n))}function Qu(t,e){return zu(t.databaseId,e)}function Hu(t){const e=ju(t);return 4===e.length?ws.emptyPath():Yu(e)}function Wu(t){return new ws(["projects",t.databaseId.projectId,"databases",t.databaseId.database]).canonicalString()}function Yu(t){return Wr(t.length>4&&"documents"===t.get(4)),t.popFirst(5)}function Xu(t,e,n){return{name:Ku(t,e),fields:n.value.mapValue.fields}}function Ju(t,e,n){const r=$u(t,e.name),s=Uu(e.updateTime),i=e.createTime?Uu(e.createTime):ps.min(),o=new wo({mapValue:{fields:e.fields}}),a=bo.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function Zu(t,e){let n;if(e instanceof eu)n={update:Xu(t,e.key,e.value)};else if(e instanceof ou)n={delete:Ku(t,e.key)};else if(e instanceof nu)n={update:Xu(t,e.key,e.data),updateMask:hc(e.fieldMask)};else{if(!(e instanceof au))return Hr();n={verify:Ku(t,e.key)}}return e.fieldTransforms.length>0&&(n.updateTransforms=e.fieldTransforms.map((t=>function(t,e){const n=e.transform;if(n instanceof Fa)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof Va)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof Ba)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof za)return{fieldPath:e.field.canonicalString(),increment:n.Ie};throw Hr()}(0,t)))),e.precondition.isNone||(n.currentDocument=function(t,e){return void 0!==e.updateTime?{updateTime:Bu(t,e.updateTime)}:void 0!==e.exists?{exists:e.exists}:Hr()}(t,e.precondition)),n}function tc(t,e){const n=e.currentDocument?function(t){return void 0!==t.updateTime?Qa.updateTime(Uu(t.updateTime)):void 0!==t.exists?Qa.exists(t.exists):Qa.none()}(e.currentDocument):Qa.none(),r=e.updateTransforms?e.updateTransforms.map((e=>function(t,e){let n=null;if("setToServerValue"in e)Wr("REQUEST_TIME"===e.setToServerValue),n=new Fa;else if("appendMissingElements"in e){const t=e.appendMissingElements.values||[];n=new Va(t)}else if("removeAllFromArray"in e){const t=e.removeAllFromArray.values||[];n=new Ba(t)}else"increment"in e?n=new za(t,e.increment):Hr();const r=bs.fromServerFormat(e.fieldPath);return new Ka(r,n)}(t,e))):[];if(e.update){e.update.name;const s=$u(t,e.update.name),i=new wo({mapValue:{fields:e.update.fields}});if(e.updateMask){const t=function(t){const e=t.fieldPaths||[];return new Pi(e.map((t=>bs.fromServerFormat(t))))}(e.updateMask);return new nu(s,i,t,n,r)}return new eu(s,i,n,r)}if(e.delete){const r=$u(t,e.delete);return new ou(r,n)}if(e.verify){const r=$u(t,e.verify);return new au(r,n)}return Hr()}function ec(t,e){return{documents:[Qu(t,e.path)]}}function nc(t,e){const n={structuredQuery:{}},r=e.path;let s;null!==e.collectionGroup?(s=r,n.structuredQuery.from=[{collectionId:e.collectionGroup,allDescendants:!0}]):(s=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=Qu(t,s);const i=function(t){if(0!==t.length)return lc(Do.create(t,"and"))}(e.filters);i&&(n.structuredQuery.where=i);const o=function(t){if(0!==t.length)return t.map((t=>function(t){return{field:uc(t.field),direction:ic(t.dir)}}(t)))}(e.orderBy);o&&(n.structuredQuery.orderBy=o);const a=Fu(t,e.limit);return null!==a&&(n.structuredQuery.limit=a),e.startAt&&(n.structuredQuery.startAt=function(t){return{before:t.inclusive,values:t.position}}(e.startAt)),e.endAt&&(n.structuredQuery.endAt=function(t){return{before:!t.inclusive,values:t.position}}(e.endAt)),{ut:n,parent:s}}function rc(t){let e=Hu(t.parent);const n=t.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){Wr(1===r);const t=n.from[0];t.allDescendants?s=t.collectionId:e=e.child(t.collectionId)}let i=[];n.where&&(i=function(t){const e=sc(t);return e instanceof Do&&ko(e)?e.getFilters():[e]}(n.where));let o=[];n.orderBy&&(o=function(t){return t.map((t=>function(t){return new To(cc(t.field),function(t){switch(t){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(t.direction))}(t)))}(n.orderBy));let a=null;n.limit&&(a=function(t){let e;return e="object"==typeof t?t.value:t,Ws(e)?null:e}(n.limit));let u=null;n.startAt&&(u=function(t){const e=!!t.before,n=t.values||[];return new _o(n,e)}(n.startAt));let c=null;return n.endAt&&(c=function(t){const e=!t.before,n=t.values||[];return new _o(n,e)}(n.endAt)),ta(e,s,o,i,a,"F",u,c)}function sc(t){return void 0!==t.unaryFilter?function(t){switch(t.unaryFilter.op){case"IS_NAN":const e=cc(t.unaryFilter.field);return Co.create(e,"==",{doubleValue:NaN});case"IS_NULL":const n=cc(t.unaryFilter.field);return Co.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=cc(t.unaryFilter.field);return Co.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=cc(t.unaryFilter.field);return Co.create(s,"!=",{nullValue:"NULL_VALUE"});default:return Hr()}}(t):void 0!==t.fieldFilter?function(t){return Co.create(cc(t.fieldFilter.field),function(t){switch(t){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return Hr()}}(t.fieldFilter.op),t.fieldFilter.value)}(t):void 0!==t.compositeFilter?function(t){return Do.create(t.compositeFilter.filters.map((t=>sc(t))),function(t){switch(t){case"AND":return"and";case"OR":return"or";default:return Hr()}}(t.compositeFilter.op))}(t):Hr()}function ic(t){return Mu[t]}function oc(t){return Lu[t]}function ac(t){return Ou[t]}function uc(t){return{fieldPath:t.canonicalString()}}function cc(t){return bs.fromServerFormat(t.fieldPath)}function lc(t){return t instanceof Co?function(t){if("=="===t.op){if(co(t.value))return{unaryFilter:{field:uc(t.field),op:"IS_NAN"}};if(uo(t.value))return{unaryFilter:{field:uc(t.field),op:"IS_NULL"}}}else if("!="===t.op){if(co(t.value))return{unaryFilter:{field:uc(t.field),op:"IS_NOT_NAN"}};if(uo(t.value))return{unaryFilter:{field:uc(t.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:uc(t.field),op:oc(t.op),value:t.value}}}(t):t instanceof Do?function(t){const e=t.getFilters().map((t=>lc(t)));return 1===e.length?e[0]:{compositeFilter:{op:ac(t.op),filters:e}}}(t):Hr()}function hc(t){const e=[];return t.fields.forEach((t=>e.push(t.canonicalString()))),{fieldPaths:e}}function dc(t){return t.length>=4&&"projects"===t.get(0)&&"databases"===t.get(2)}class fc{constructor(t,e,n,r,s=ps.min(),i=ps.min(),o=qi.EMPTY_BYTE_STRING,a=null){this.target=t,this.targetId=e,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(t){return new fc(this.target,this.targetId,this.purpose,t,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(t,e){return new fc(this.target,this.targetId,this.purpose,this.sequenceNumber,e,this.lastLimboFreeSnapshotVersion,t,null)}withExpectedCount(t){return new fc(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,t)}withLastLimboFreeSnapshotVersion(t){return new fc(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,t,this.resumeToken,this.expectedCount)}}class gc{constructor(t){this.ct=t}}function mc(t,e){const n=e.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:pc(e.readTime),hasCommittedMutations:e.hasCommittedMutations};if(e.isFoundDocument())r.document=function(t,e){return{name:Ku(t,e.key),fields:e.data.value.mapValue.fields,updateTime:Vu(t,e.version.toTimestamp()),createTime:Vu(t,e.createTime.toTimestamp())}}(t.ct,e);else if(e.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:yc(e.version)};else{if(!e.isUnknownDocument())return Hr();r.unknownDocument={path:n.path.toArray(),version:yc(e.version)}}return r}function pc(t){const e=t.toTimestamp();return[e.seconds,e.nanoseconds]}function yc(t){const e=t.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function wc(t){const e=new ms(t.seconds,t.nanoseconds);return ps.fromTimestamp(e)}function vc(t,e){const n=(e.baseMutations||[]).map((e=>tc(t.ct,e)));for(let t=0;t<e.mutations.length-1;++t){const n=e.mutations[t];if(t+1<e.mutations.length&&void 0!==e.mutations[t+1].transform){const r=e.mutations[t+1];n.updateTransforms=r.transform.fieldTransforms,e.mutations.splice(t+1,1),++t}}const r=e.mutations.map((e=>tc(t.ct,e))),s=ms.fromMillis(e.localWriteTimeMs);return new uu(e.batchId,s,n,r)}function bc(t){const e=wc(t.readTime),n=void 0!==t.lastLimboFreeSnapshotVersion?wc(t.lastLimboFreeSnapshotVersion):ps.min();let r;return r=function(t){return void 0!==t.documents}(t.query)?function(t){return Wr(1===t.documents.length),ia(ea(Hu(t.documents[0])))}(t.query):function(t){return ia(rc(t))}(t.query),new fc(r,t.targetId,"TargetPurposeListen",t.lastListenSequenceNumber,e,n,qi.fromBase64String(t.resumeToken))}function _c(t,e){const n=yc(e.snapshotVersion),r=yc(e.lastLimboFreeSnapshotVersion);let s;s=Wo(e.target)?ec(t.ct,e.target):nc(t.ct,e.target).ut;const i=e.resumeToken.toBase64();return{targetId:e.targetId,canonicalId:Qo(e.target),readTime:n,resumeToken:i,lastListenSequenceNumber:e.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function Ic(t){const e=rc({parent:t.parent,structuredQuery:t.structuredQuery});return"LAST"===t.limitType?ua(e,e.limit,"L"):e}function Ec(t,e){return new lu(e.largestBatchId,tc(t.ct,e.overlayMutation))}function Tc(t,e){const n=e.path.lastSegment();return[t,Js(e.path.popLast()),n]}function Sc(t,e,n,r){return{indexId:t,uid:e,sequenceNumber:n,readTime:yc(r.readTime),documentKey:Js(r.documentKey.path),largestBatchId:r.largestBatchId}}class xc{getBundleMetadata(t,e){return Cc(t).get(e).next((t=>{if(t)return function(t){return{id:t.bundleId,createTime:wc(t.createTime),version:t.version}}(t)}))}saveBundleMetadata(t,e){return Cc(t).put(function(t){return{bundleId:t.id,createTime:yc(Uu(t.createTime)),version:t.version}}(e))}getNamedQuery(t,e){return Dc(t).get(e).next((t=>{if(t)return function(t){return{name:t.name,query:Ic(t.bundledQuery),readTime:wc(t.readTime)}}(t)}))}saveNamedQuery(t,e){return Dc(t).put(function(t){return{name:t.name,readTime:yc(Uu(t.readTime)),bundledQuery:t.bundledQuery}}(e))}}function Cc(t){return xi(t,"bundles")}function Dc(t){return xi(t,"namedQueries")}class Ac{constructor(t,e){this.serializer=t,this.userId=e}static lt(t,e){const n=e.uid||"";return new Ac(t,n)}getOverlay(t,e){return Nc(t).get(Tc(this.userId,e)).next((t=>t?Ec(this.serializer,t):null))}getOverlays(t,e){const n=Ia();return Ps.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){const r=[];return n.forEach(((n,s)=>{const i=new lu(e,s);r.push(this.ht(t,i))})),Ps.waitFor(r)}removeOverlaysForBatchId(t,e,n){const r=new Set;e.forEach((t=>r.add(Js(t.getCollectionPath()))));const s=[];return r.forEach((e=>{const r=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);s.push(Nc(t).H("collectionPathOverlayIndex",r))})),Ps.waitFor(s)}getOverlaysForCollection(t,e,n){const r=Ia(),s=Js(e),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Nc(t).W("collectionPathOverlayIndex",i).next((t=>{for(const e of t){const t=Ec(this.serializer,e);r.set(t.getKey(),t)}return r}))}getOverlaysForCollectionGroup(t,e,n,r){const s=Ia();let i;const o=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,Number.POSITIVE_INFINITY],!0);return Nc(t).Y({index:"collectionGroupOverlayIndex",range:o},((t,e,n)=>{const o=Ec(this.serializer,e);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}ht(t,e){return Nc(t).put(function(t,e,n){const[r,s,i]=Tc(e,n.mutation.key);return{userId:e,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Zu(t.ct,n.mutation)}}(this.serializer,this.userId,e))}}function Nc(t){return xi(t,"documentOverlays")}class kc{constructor(){}Pt(t,e){this.It(t,e),e.Tt()}It(t,e){if("nullValue"in t)this.Et(e,5);else if("booleanValue"in t)this.Et(e,10),e.dt(t.booleanValue?1:0);else if("integerValue"in t)this.Et(e,15),e.dt(zi(t.integerValue));else if("doubleValue"in t){const n=zi(t.doubleValue);isNaN(n)?this.Et(e,13):(this.Et(e,15),Ys(n)?e.dt(0):e.dt(n))}else if("timestampValue"in t){const n=t.timestampValue;this.Et(e,20),"string"==typeof n?e.At(n):(e.At(`${n.seconds||""}`),e.dt(n.nanos||0))}else if("stringValue"in t)this.Rt(t.stringValue,e),this.Vt(e);else if("bytesValue"in t)this.Et(e,30),e.ft(Gi(t.bytesValue)),this.Vt(e);else if("referenceValue"in t)this.gt(t.referenceValue,e);else if("geoPointValue"in t){const n=t.geoPointValue;this.Et(e,45),e.dt(n.latitude||0),e.dt(n.longitude||0)}else"mapValue"in t?fo(t)?this.Et(e,Number.MAX_SAFE_INTEGER):(this.yt(t.mapValue,e),this.Vt(e)):"arrayValue"in t?(this.wt(t.arrayValue,e),this.Vt(e)):Hr()}Rt(t,e){this.Et(e,25),this.St(t,e)}St(t,e){e.At(t)}yt(t,e){const n=t.fields||{};this.Et(e,55);for(const t of Object.keys(n))this.Rt(t,e),this.It(n[t],e)}wt(t,e){const n=t.values||[];this.Et(e,50);for(const t of n)this.It(t,e)}gt(t,e){this.Et(e,37),_s.fromName(t).path.forEach((t=>{this.Et(e,60),this.St(t,e)}))}Et(t,e){t.dt(e)}Vt(t){t.dt(2)}}function Rc(t){if(0===t)return 8;let e=0;return t>>4==0&&(e+=4,t<<=4),t>>6==0&&(e+=2,t<<=2),t>>7==0&&(e+=1),e}function Mc(t){const e=64-function(t){let e=0;for(let n=0;n<8;++n){const r=Rc(255&t[n]);if(e+=r,8!==r)break}return e}(t);return Math.ceil(e/8)}kc.bt=new kc;class Lc{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Ct(n.value),n=e.next();this.vt()}Ft(t){const e=t[Symbol.iterator]();let n=e.next();for(;!n.done;)this.Mt(n.value),n=e.next();this.xt()}Ot(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Ct(t);else if(t<2048)this.Ct(960|t>>>6),this.Ct(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Ct(480|t>>>12),this.Ct(128|63&t>>>6),this.Ct(128|63&t);else{const t=e.codePointAt(0);this.Ct(240|t>>>18),this.Ct(128|63&t>>>12),this.Ct(128|63&t>>>6),this.Ct(128|63&t)}}this.vt()}Nt(t){for(const e of t){const t=e.charCodeAt(0);if(t<128)this.Mt(t);else if(t<2048)this.Mt(960|t>>>6),this.Mt(128|63&t);else if(e<"\ud800"||"\udbff"<e)this.Mt(480|t>>>12),this.Mt(128|63&t>>>6),this.Mt(128|63&t);else{const t=e.codePointAt(0);this.Mt(240|t>>>18),this.Mt(128|63&t>>>12),this.Mt(128|63&t>>>6),this.Mt(128|63&t)}}this.xt()}Bt(t){const e=this.Lt(t),n=Mc(e);this.kt(1+n),this.buffer[this.position++]=255&n;for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=255&e[t]}qt(t){const e=this.Lt(t),n=Mc(e);this.kt(1+n),this.buffer[this.position++]=~(255&n);for(let t=e.length-n;t<e.length;++t)this.buffer[this.position++]=~(255&e[t])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(t){this.kt(t.length),this.buffer.set(t,this.position),this.position+=t.length}Wt(){return this.buffer.slice(0,this.position)}Lt(t){const e=function(t){const e=new DataView(new ArrayBuffer(8));return e.setFloat64(0,t,!1),new Uint8Array(e.buffer)}(t),n=0!=(128&e[0]);e[0]^=n?255:128;for(let t=1;t<e.length;++t)e[t]^=n?255:0;return e}Ct(t){const e=255&t;0===e?(this.Kt(0),this.Kt(255)):255===e?(this.Kt(255),this.Kt(0)):this.Kt(e)}Mt(t){const e=255&t;0===e?(this.Ut(0),this.Ut(255)):255===e?(this.Ut(255),this.Ut(0)):this.Ut(t)}vt(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(t){this.kt(1),this.buffer[this.position++]=t}Ut(t){this.kt(1),this.buffer[this.position++]=~t}kt(t){const e=t+this.position;if(e<=this.buffer.length)return;let n=2*this.buffer.length;n<e&&(n=e);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class Oc{constructor(t){this.Gt=t}ft(t){this.Gt.Dt(t)}At(t){this.Gt.Ot(t)}dt(t){this.Gt.Bt(t)}Tt(){this.Gt.Qt()}}class Pc{constructor(t){this.Gt=t}ft(t){this.Gt.Ft(t)}At(t){this.Gt.Nt(t)}dt(t){this.Gt.qt(t)}Tt(){this.Gt.$t()}}class Fc{constructor(){this.Gt=new Lc,this.zt=new Oc(this.Gt),this.jt=new Pc(this.Gt)}seed(t){this.Gt.seed(t)}Ht(t){return 0===t?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}}class Vc{constructor(t,e,n,r){this.indexId=t,this.documentKey=e,this.arrayValue=n,this.directionalValue=r}Jt(){const t=this.directionalValue.length,e=0===t||255===this.directionalValue[t-1]?t+1:t,n=new Uint8Array(e);return n.set(this.directionalValue,0),e!==t?n.set([0],this.directionalValue.length):++n[n.length-1],new Vc(this.indexId,this.documentKey,this.arrayValue,n)}}function qc(t,e){let n=t.indexId-e.indexId;return 0!==n?n:(n=Bc(t.arrayValue,e.arrayValue),0!==n?n:(n=Bc(t.directionalValue,e.directionalValue),0!==n?n:_s.comparator(t.documentKey,e.documentKey)))}function Bc(t,e){for(let n=0;n<t.length&&n<e.length;++n){const r=t[n]-e[n];if(0!==r)return r}return t.length-e.length}class Uc{constructor(t){this.Yt=new Mi(((t,e)=>bs.comparator(t.field,e.field))),this.collectionId=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment(),this.Zt=t.orderBy,this.Xt=[];for(const e of t.filters){const t=e;t.isInequality()?this.Yt=this.Yt.add(t):this.Xt.push(t)}}get en(){return this.Yt.size>1}tn(t){if(Wr(t.collectionGroup===this.collectionId),this.en)return!1;const e=Es(t);if(void 0!==e&&!this.nn(e))return!1;const n=Ts(t);let r=new Set,s=0,i=0;for(;s<n.length&&this.nn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.Yt.size>0){const t=this.Yt.getIterator().getNext();if(!r.has(t.field.canonicalString())){const e=n[s];if(!this.rn(t,e)||!this.sn(this.Zt[i++],e))return!1}++s}for(;s<n.length;++s){const t=n[s];if(i>=this.Zt.length||!this.sn(this.Zt[i++],t))return!1}return!0}on(){if(this.en)return null;let t=new Mi(bs.comparator);const e=[];for(const n of this.Xt)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)e.push(new xs(n.field,2));else{if(t.has(n.field))continue;t=t.add(n.field),e.push(new xs(n.field,0))}for(const n of this.Zt)n.field.isKeyField()||t.has(n.field)||(t=t.add(n.field),e.push(new xs(n.field,"asc"===n.dir?0:1)));return new Is(Is.UNKNOWN_ID,this.collectionId,e,Ds.empty())}nn(t){for(const e of this.Xt)if(this.rn(e,t))return!0;return!1}rn(t,e){if(void 0===t||!t.field.isEqual(e.fieldPath))return!1;const n="array-contains"===t.op||"array-contains-any"===t.op;return 2===e.kind===n}sn(t,e){return!!t.field.isEqual(e.fieldPath)&&(0===e.kind&&"asc"===t.dir||1===e.kind&&"desc"===t.dir)}}function zc(t){var e,n;if(Wr(t instanceof Co||t instanceof Do),t instanceof Co){if(t instanceof zo){const r=(null===(n=null===(e=t.value.arrayValue)||void 0===e?void 0:e.values)||void 0===n?void 0:n.map((e=>Co.create(t.field,"==",e))))||[];return Do.create(r,"or")}return t}const r=t.filters.map((t=>zc(t)));return Do.create(r,t.op)}function Gc(t){if(0===t.getFilters().length)return[];const e=Qc(zc(t));return Wr($c(e)),jc(e)||Kc(e)?[e]:e.getFilters()}function jc(t){return t instanceof Co}function Kc(t){return t instanceof Do&&ko(t)}function $c(t){return jc(t)||Kc(t)||function(t){if(t instanceof Do&&No(t)){for(const e of t.getFilters())if(!jc(e)&&!Kc(e))return!1;return!0}return!1}(t)}function Qc(t){if(Wr(t instanceof Co||t instanceof Do),t instanceof Co)return t;if(1===t.filters.length)return Qc(t.filters[0]);const e=t.filters.map((t=>Qc(t)));let n=Do.create(e,t.op);return n=Yc(n),$c(n)?n:(Wr(n instanceof Do),Wr(Ao(n)),Wr(n.filters.length>1),n.filters.reduce(((t,e)=>Hc(t,e))))}function Hc(t,e){let n;return Wr(t instanceof Co||t instanceof Do),Wr(e instanceof Co||e instanceof Do),n=t instanceof Co?e instanceof Co?function(t,e){return Do.create([t,e],"and")}(t,e):Wc(t,e):e instanceof Co?Wc(e,t):function(t,e){if(Wr(t.filters.length>0&&e.filters.length>0),Ao(t)&&Ao(e))return Oo(t,e.getFilters());const n=No(t)?t:e,r=No(t)?e:t,s=n.filters.map((t=>Hc(t,r)));return Do.create(s,"or")}(t,e),Yc(n)}function Wc(t,e){if(Ao(e))return Oo(e,t.getFilters());{const n=e.filters.map((e=>Hc(t,e)));return Do.create(n,"or")}}function Yc(t){if(Wr(t instanceof Co||t instanceof Do),t instanceof Co)return t;const e=t.getFilters();if(1===e.length)return Yc(e[0]);if(Ro(t))return t;const n=e.map((t=>Yc(t))),r=[];return n.forEach((e=>{e instanceof Co?r.push(e):e instanceof Do&&(e.op===t.op?r.push(...e.filters):r.push(e))})),1===r.length?r[0]:Do.create(r,t.op)}class Xc{constructor(){this._n=new Jc}addToCollectionParentIndex(t,e){return this._n.add(e),Ps.resolve()}getCollectionParents(t,e){return Ps.resolve(this._n.getEntries(e))}addFieldIndex(t,e){return Ps.resolve()}deleteFieldIndex(t,e){return Ps.resolve()}deleteAllFieldIndexes(t){return Ps.resolve()}createTargetIndexes(t,e){return Ps.resolve()}getDocumentsMatchingTarget(t,e){return Ps.resolve(null)}getIndexType(t,e){return Ps.resolve(0)}getFieldIndexes(t,e){return Ps.resolve([])}getNextCollectionGroupToUpdate(t){return Ps.resolve(null)}getMinOffset(t,e){return Ps.resolve(ks.min())}getMinOffsetFromCollectionGroup(t,e){return Ps.resolve(ks.min())}updateCollectionGroup(t,e,n){return Ps.resolve()}updateIndexEntries(t,e){return Ps.resolve()}}class Jc{constructor(){this.index={}}add(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e]||new Mi(ws.comparator),s=!r.has(n);return this.index[e]=r.add(n),s}has(t){const e=t.lastSegment(),n=t.popLast(),r=this.index[e];return r&&r.has(n)}getEntries(t){return(this.index[t]||new Mi(ws.comparator)).toArray()}}const Zc=new Uint8Array(0);class tl{constructor(t,e){this.databaseId=e,this.an=new Jc,this.un=new pa((t=>Qo(t)),((t,e)=>Ho(t,e))),this.uid=t.uid||""}addToCollectionParentIndex(t,e){if(!this.an.has(e)){const n=e.lastSegment(),r=e.popLast();t.addOnCommittedListener((()=>{this.an.add(e)}));const s={collectionId:n,parent:Js(r)};return el(t).put(s)}return Ps.resolve()}getCollectionParents(t,e){const n=[],r=IDBKeyRange.bound([e,""],[gs(e),""],!1,!0);return el(t).W(r).next((t=>{for(const r of t){if(r.collectionId!==e)break;n.push(ei(r.parent))}return n}))}addFieldIndex(t,e){const n=rl(t),r=function(t){return{indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map((t=>[t.fieldPath.canonicalString(),t.kind]))}}(e);delete r.indexId;const s=n.add(r);if(e.indexState){const n=sl(t);return s.next((t=>{n.put(Sc(t,this.uid,e.indexState.sequenceNumber,e.indexState.offset))}))}return s.next()}deleteFieldIndex(t,e){const n=rl(t),r=sl(t),s=nl(t);return n.delete(e.indexId).next((()=>r.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([e.indexId],[e.indexId+1],!1,!0))))}deleteAllFieldIndexes(t){const e=rl(t),n=nl(t),r=sl(t);return e.H().next((()=>n.H())).next((()=>r.H()))}createTargetIndexes(t,e){return Ps.forEach(this.cn(e),(e=>this.getIndexType(t,e).next((n=>{if(0===n||1===n){const n=new Uc(e).on();if(null!=n)return this.addFieldIndex(t,n)}}))))}getDocumentsMatchingTarget(t,e){const n=nl(t);let r=!0;const s=new Map;return Ps.forEach(this.cn(e),(e=>this.ln(t,e).next((t=>{r&&(r=!!t),s.set(e,t)})))).next((()=>{if(r){let t=Ca();const r=[];return Ps.forEach(s,((s,i)=>{jr("IndexedDbIndexManager",`Using index ${function(t){return`id=${t.indexId}|cg=${t.collectionGroup}|f=${t.fields.map((t=>`${t.fieldPath}:${t.kind}`)).join(",")}`}(s)} to execute ${Qo(e)}`);const o=function(t,e){const n=Es(e);if(void 0===n)return null;for(const e of Yo(t,n.fieldPath))switch(e.op){case"array-contains-any":return e.value.arrayValue.values||[];case"array-contains":return[e.value]}return null}(i,s),a=function(t,e){const n=new Map;for(const r of Ts(e))for(const e of Yo(t,r.fieldPath))switch(e.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),e.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),e.value),Array.from(n.values())}return null}(i,s),u=function(t,e){const n=[];let r=!0;for(const s of Ts(e)){const e=0===s.kind?Xo(t,s.fieldPath,t.startAt):Jo(t,s.fieldPath,t.startAt);n.push(e.value),r&&(r=e.inclusive)}return new _o(n,r)}(i,s),c=function(t,e){const n=[];let r=!0;for(const s of Ts(e)){const e=0===s.kind?Jo(t,s.fieldPath,t.endAt):Xo(t,s.fieldPath,t.endAt);n.push(e.value),r&&(r=e.inclusive)}return new _o(n,r)}(i,s),l=this.hn(s,i,u),h=this.hn(s,i,c),d=this.Pn(s,i,a),f=this.In(s.indexId,o,l,u.inclusive,h,c.inclusive,d);return Ps.forEach(f,(s=>n.j(s,e.limit).next((e=>{e.forEach((e=>{const n=_s.fromSegments(e.documentKey);t.has(n)||(t=t.add(n),r.push(n))}))}))))})).next((()=>r))}return Ps.resolve(null)}))}cn(t){let e=this.un.get(t);return e||(e=0===t.filters.length?[t]:Gc(Do.create(t.filters,"and")).map((e=>$o(t.path,t.collectionGroup,t.orderBy,e.getFilters(),t.limit,t.startAt,t.endAt))),this.un.set(t,e),e)}In(t,e,n,r,s,i,o){const a=(null!=e?e.length:1)*Math.max(n.length,s.length),u=a/(null!=e?e.length:1),c=[];for(let l=0;l<a;++l){const a=e?this.Tn(e[l/u]):Zc,h=this.En(t,a,n[l%u],r),d=this.dn(t,a,s[l%u],i),f=o.map((e=>this.En(t,a,e,!0)));c.push(...this.createRange(h,d,f))}return c}En(t,e,n,r){const s=new Vc(t,_s.empty(),e,n);return r?s:s.Jt()}dn(t,e,n,r){const s=new Vc(t,_s.empty(),e,n);return r?s.Jt():s}ln(t,e){const n=new Uc(e),r=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment();return this.getFieldIndexes(t,r).next((t=>{let e=null;for(const r of t)n.tn(r)&&(!e||r.fields.length>e.fields.length)&&(e=r);return e}))}getIndexType(t,e){let n=2;const r=this.cn(e);return Ps.forEach(r,(e=>this.ln(t,e).next((t=>{t?0!==n&&t.fields.length<function(t){let e=new Mi(bs.comparator),n=!1;for(const r of t.filters)for(const t of r.getFlattenedFilters())t.field.isKeyField()||("array-contains"===t.op||"array-contains-any"===t.op?n=!0:e=e.add(t.field));for(const n of t.orderBy)n.field.isKeyField()||(e=e.add(n.field));return e.size+(n?1:0)}(e)&&(n=1):n=0})))).next((()=>function(t){return null!==t.limit}(e)&&r.length>1&&2===n?1:n))}An(t,e){const n=new Fc;for(const r of Ts(t)){const t=e.data.field(r.fieldPath);if(null==t)return null;const s=n.Ht(r.kind);kc.bt.Pt(t,s)}return n.Wt()}Tn(t){const e=new Fc;return kc.bt.Pt(t,e.Ht(0)),e.Wt()}Rn(t,e){const n=new Fc;return kc.bt.Pt(io(this.databaseId,e),n.Ht(function(t){const e=Ts(t);return 0===e.length?0:e[e.length-1].kind}(t))),n.Wt()}Pn(t,e,n){if(null===n)return[];let r=[];r.push(new Fc);let s=0;for(const i of Ts(t)){const t=n[s++];for(const n of r)if(this.Vn(e,i.fieldPath)&&ao(t))r=this.mn(r,i,t);else{const e=n.Ht(i.kind);kc.bt.Pt(t,e)}}return this.fn(r)}hn(t,e,n){return this.Pn(t,e,n.position)}fn(t){const e=[];for(let n=0;n<t.length;++n)e[n]=t[n].Wt();return e}mn(t,e,n){const r=[...t],s=[];for(const t of n.arrayValue.values||[])for(const n of r){const r=new Fc;r.seed(n.Wt()),kc.bt.Pt(t,r.Ht(e.kind)),s.push(r)}return s}Vn(t,e){return!!t.filters.find((t=>t instanceof Co&&t.field.isEqual(e)&&("in"===t.op||"not-in"===t.op)))}getFieldIndexes(t,e){const n=rl(t),r=sl(t);return(e?n.W("collectionGroupIndex",IDBKeyRange.bound(e,e)):n.W()).next((t=>{const e=[];return Ps.forEach(t,(t=>r.get([t.indexId,this.uid]).next((n=>{e.push(function(t,e){const n=e?new Ds(e.sequenceNumber,new ks(wc(e.readTime),new _s(ei(e.documentKey)),e.largestBatchId)):Ds.empty(),r=t.fields.map((([t,e])=>new xs(bs.fromServerFormat(t),e)));return new Is(t.indexId,t.collectionGroup,r,n)}(t,n))})))).next((()=>e))}))}getNextCollectionGroupToUpdate(t){return this.getFieldIndexes(t).next((t=>0===t.length?null:(t.sort(((t,e)=>{const n=t.indexState.sequenceNumber-e.indexState.sequenceNumber;return 0!==n?n:ds(t.collectionGroup,e.collectionGroup)})),t[0].collectionGroup)))}updateCollectionGroup(t,e,n){const r=rl(t),s=sl(t);return this.gn(t).next((t=>r.W("collectionGroupIndex",IDBKeyRange.bound(e,e)).next((e=>Ps.forEach(e,(e=>s.put(Sc(e.indexId,this.uid,t,n))))))))}updateIndexEntries(t,e){const n=new Map;return Ps.forEach(e,((e,r)=>{const s=n.get(e.collectionGroup);return(s?Ps.resolve(s):this.getFieldIndexes(t,e.collectionGroup)).next((s=>(n.set(e.collectionGroup,s),Ps.forEach(s,(n=>this.pn(t,e,n).next((e=>{const s=this.yn(r,n);return e.isEqual(s)?Ps.resolve():this.wn(t,r,n,e,s)})))))))}))}Sn(t,e,n,r){return nl(t).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.Rn(n,e.key),documentKey:e.key.path.toArray()})}bn(t,e,n,r){return nl(t).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.Rn(n,e.key),e.key.path.toArray()])}pn(t,e,n){const r=nl(t);let s=new Mi(qc);return r.Y({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.Rn(n,e)])},((t,r)=>{s=s.add(new Vc(n.indexId,e,r.arrayValue,r.directionalValue))})).next((()=>s))}yn(t,e){let n=new Mi(qc);const r=this.An(e,t);if(null==r)return n;const s=Es(e);if(null!=s){const i=t.data.field(s.fieldPath);if(ao(i))for(const s of i.arrayValue.values||[])n=n.add(new Vc(e.indexId,t.key,this.Tn(s),r))}else n=n.add(new Vc(e.indexId,t.key,Zc,r));return n}wn(t,e,n,r,s){jr("IndexedDbIndexManager","Updating index entries for document '%s'",e.key);const i=[];return function(t,e,n,r,s){const i=t.getIterator(),o=e.getIterator();let a=Oi(i),u=Oi(o);for(;a||u;){let t=!1,e=!1;if(a&&u){const r=n(a,u);r<0?e=!0:r>0&&(t=!0)}else null!=a?e=!0:t=!0;t?(r(u),u=Oi(o)):e?(s(a),a=Oi(i)):(a=Oi(i),u=Oi(o))}}(r,s,qc,(r=>{i.push(this.Sn(t,e,n,r))}),(r=>{i.push(this.bn(t,e,n,r))})),Ps.waitFor(i)}gn(t){let e=1;return sl(t).Y({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((t,n,r)=>{r.done(),e=n.sequenceNumber+1})).next((()=>e))}createRange(t,e,n){n=n.sort(((t,e)=>qc(t,e))).filter(((t,e,n)=>!e||0!==qc(t,n[e-1])));const r=[];r.push(t);for(const s of n){const n=qc(s,t),i=qc(s,e);if(0===n)r[0]=t.Jt();else if(n>0&&i<0)r.push(s),r.push(s.Jt());else if(i>0)break}r.push(e);const s=[];for(let t=0;t<r.length;t+=2){if(this.Dn(r[t],r[t+1]))return[];const e=[r[t].indexId,this.uid,r[t].arrayValue,r[t].directionalValue,Zc,[]],n=[r[t+1].indexId,this.uid,r[t+1].arrayValue,r[t+1].directionalValue,Zc,[]];s.push(IDBKeyRange.bound(e,n))}return s}Dn(t,e){return qc(t,e)>0}getMinOffsetFromCollectionGroup(t,e){return this.getFieldIndexes(t,e).next(il)}getMinOffset(t,e){return Ps.mapArray(this.cn(e),(e=>this.ln(t,e).next((t=>t||Hr())))).next(il)}}function el(t){return xi(t,"collectionParents")}function nl(t){return xi(t,"indexEntries")}function rl(t){return xi(t,"indexConfiguration")}function sl(t){return xi(t,"indexState")}function il(t){Wr(0!==t.length);let e=t[0].indexState.offset,n=e.largestBatchId;for(let r=1;r<t.length;r++){const s=t[r].indexState.offset;Rs(s,e)<0&&(e=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new ks(e.readTime,e.documentKey,n)}const ol={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class al{constructor(t,e,n){this.cacheSizeCollectionThreshold=t,this.percentileToCollect=e,this.maximumSequenceNumbersToCollect=n}static withCacheSize(t){return new al(t,al.DEFAULT_COLLECTION_PERCENTILE,al.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function ul(t,e,n){const r=t.store("mutations"),s=t.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.Y({range:o},((t,e,n)=>(a++,n.delete())));i.push(u.next((()=>{Wr(1===a)})));const c=[];for(const t of n.mutations){const r=si(e,t.key.path,n.batchId);i.push(s.delete(r)),c.push(t.key)}return Ps.waitFor(i).next((()=>c))}function cl(t){if(!t)return 0;let e;if(t.document)e=t.document;else if(t.unknownDocument)e=t.unknownDocument;else{if(!t.noDocument)throw Hr();e=t.noDocument}return JSON.stringify(e).length}al.DEFAULT_COLLECTION_PERCENTILE=10,al.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,al.DEFAULT=new al(41943040,al.DEFAULT_COLLECTION_PERCENTILE,al.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),al.DISABLED=new al(-1,0,0);class ll{constructor(t,e,n,r){this.userId=t,this.serializer=e,this.indexManager=n,this.referenceDelegate=r,this.Cn={}}static lt(t,e,n,r){Wr(""!==t.uid);const s=t.isAuthenticated()?t.uid:"";return new ll(s,e,n,r)}checkEmpty(t){let e=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return dl(t).Y({index:"userMutationsIndex",range:n},((t,n,r)=>{e=!1,r.done()})).next((()=>e))}addMutationBatch(t,e,n,r){const s=fl(t),i=dl(t);return i.add({}).next((o=>{Wr("number"==typeof o);const a=new uu(o,e,n,r),u=function(t,e,n){const r=n.baseMutations.map((e=>Zu(t.ct,e))),s=n.mutations.map((e=>Zu(t.ct,e)));return{userId:e,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),c=[];let l=new Mi(((t,e)=>ds(t.canonicalString(),e.canonicalString())));for(const t of r){const e=si(this.userId,t.key.path,o);l=l.add(t.key.path.popLast()),c.push(i.put(u)),c.push(s.put(e,ii))}return l.forEach((e=>{c.push(this.indexManager.addToCollectionParentIndex(t,e))})),t.addOnCommittedListener((()=>{this.Cn[o]=a.keys()})),Ps.waitFor(c).next((()=>a))}))}lookupMutationBatch(t,e){return dl(t).get(e).next((t=>t?(Wr(t.userId===this.userId),vc(this.serializer,t)):null))}vn(t,e){return this.Cn[e]?Ps.resolve(this.Cn[e]):this.lookupMutationBatch(t,e).next((t=>{if(t){const n=t.keys();return this.Cn[e]=n,n}return null}))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return dl(t).Y({index:"userMutationsIndex",range:r},((t,e,r)=>{e.userId===this.userId&&(Wr(e.batchId>=n),s=vc(this.serializer,e)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(t){const e=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return dl(t).Y({index:"userMutationsIndex",range:e,reverse:!0},((t,e,r)=>{n=e.batchId,r.done()})).next((()=>n))}getAllMutationBatches(t){const e=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return dl(t).W("userMutationsIndex",e).next((t=>t.map((t=>vc(this.serializer,t)))))}getAllMutationBatchesAffectingDocumentKey(t,e){const n=ri(this.userId,e.path),r=IDBKeyRange.lowerBound(n),s=[];return fl(t).Y({range:r},((n,r,i)=>{const[o,a,u]=n,c=ei(a);if(o===this.userId&&e.path.isEqual(c))return dl(t).get(u).next((t=>{if(!t)throw Hr();Wr(t.userId===this.userId),s.push(vc(this.serializer,t))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Mi(ds);const r=[];return e.forEach((e=>{const s=ri(this.userId,e.path),i=IDBKeyRange.lowerBound(s),o=fl(t).Y({range:i},((t,r,s)=>{const[i,o,a]=t,u=ei(o);i===this.userId&&e.path.isEqual(u)?n=n.add(a):s.done()}));r.push(o)})),Ps.waitFor(r).next((()=>this.Fn(t,n)))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1,s=ri(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new Mi(ds);return fl(t).Y({range:i},((t,e,s)=>{const[i,a,u]=t,c=ei(a);i===this.userId&&n.isPrefixOf(c)?c.length===r&&(o=o.add(u)):s.done()})).next((()=>this.Fn(t,o)))}Fn(t,e){const n=[],r=[];return e.forEach((e=>{r.push(dl(t).get(e).next((t=>{if(null===t)throw Hr();Wr(t.userId===this.userId),n.push(vc(this.serializer,t))})))})),Ps.waitFor(r).next((()=>n))}removeMutationBatch(t,e){return ul(t.ae,this.userId,e).next((n=>(t.addOnCommittedListener((()=>{this.Mn(e.batchId)})),Ps.forEach(n,(e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))))}Mn(t){delete this.Cn[t]}performConsistencyCheck(t){return this.checkEmpty(t).next((e=>{if(!e)return Ps.resolve();const n=IDBKeyRange.lowerBound(function(t){return[t]}(this.userId)),r=[];return fl(t).Y({range:n},((t,e,n)=>{if(t[0]===this.userId){const e=ei(t[1]);r.push(e)}else n.done()})).next((()=>{Wr(0===r.length)}))}))}containsKey(t,e){return hl(t,this.userId,e)}xn(t){return gl(t).get(this.userId).next((t=>t||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function hl(t,e,n){const r=ri(e,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return fl(t).Y({range:i,J:!0},((t,n,r)=>{const[i,a,u]=t;i===e&&a===s&&(o=!0),r.done()})).next((()=>o))}function dl(t){return xi(t,"mutations")}function fl(t){return xi(t,"documentMutations")}function gl(t){return xi(t,"mutationQueues")}class ml{constructor(t){this.On=t}next(){return this.On+=2,this.On}static Nn(){return new ml(0)}static Bn(){return new ml(-1)}}class pl{constructor(t,e){this.referenceDelegate=t,this.serializer=e}allocateTargetId(t){return this.Ln(t).next((e=>{const n=new ml(e.highestTargetId);return e.highestTargetId=n.next(),this.kn(t,e).next((()=>e.highestTargetId))}))}getLastRemoteSnapshotVersion(t){return this.Ln(t).next((t=>ps.fromTimestamp(new ms(t.lastRemoteSnapshotVersion.seconds,t.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(t){return this.Ln(t).next((t=>t.highestListenSequenceNumber))}setTargetsMetadata(t,e,n){return this.Ln(t).next((r=>(r.highestListenSequenceNumber=e,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),e>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=e),this.kn(t,r))))}addTargetData(t,e){return this.qn(t,e).next((()=>this.Ln(t).next((n=>(n.targetCount+=1,this.Qn(e,n),this.kn(t,n))))))}updateTargetData(t,e){return this.qn(t,e)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next((()=>yl(t).delete(e.targetId))).next((()=>this.Ln(t))).next((e=>(Wr(e.targetCount>0),e.targetCount-=1,this.kn(t,e))))}removeTargets(t,e,n){let r=0;const s=[];return yl(t).Y(((i,o)=>{const a=bc(o);a.sequenceNumber<=e&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(t,a)))})).next((()=>Ps.waitFor(s))).next((()=>r))}forEachTarget(t,e){return yl(t).Y(((t,n)=>{const r=bc(n);e(r)}))}Ln(t){return wl(t).get("targetGlobalKey").next((t=>(Wr(null!==t),t)))}kn(t,e){return wl(t).put("targetGlobalKey",e)}qn(t,e){return yl(t).put(_c(this.serializer,e))}Qn(t,e){let n=!1;return t.targetId>e.highestTargetId&&(e.highestTargetId=t.targetId,n=!0),t.sequenceNumber>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=t.sequenceNumber,n=!0),n}getTargetCount(t){return this.Ln(t).next((t=>t.targetCount))}getTargetData(t,e){const n=Qo(e),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return yl(t).Y({range:r,index:"queryTargetsIndex"},((t,n,r)=>{const i=bc(n);Ho(e,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(t,e,n){const r=[],s=vl(t);return e.forEach((e=>{const i=Js(e.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(t,n,e))})),Ps.waitFor(r)}removeMatchingKeys(t,e,n){const r=vl(t);return Ps.forEach(e,(e=>{const s=Js(e.path);return Ps.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(t,n,e)])}))}removeMatchingKeysForTargetId(t,e){const n=vl(t),r=IDBKeyRange.bound([e],[e+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(t,e){const n=IDBKeyRange.bound([e],[e+1],!1,!0),r=vl(t);let s=Ca();return r.Y({range:n,J:!0},((t,e,n)=>{const r=ei(t[1]),i=new _s(r);s=s.add(i)})).next((()=>s))}containsKey(t,e){const n=Js(e.path),r=IDBKeyRange.bound([n],[gs(n)],!1,!0);let s=0;return vl(t).Y({index:"documentTargetsIndex",J:!0,range:r},(([t,e],n,r)=>{0!==t&&(s++,r.done())})).next((()=>s>0))}_t(t,e){return yl(t).get(e).next((t=>t?bc(t):null))}}function yl(t){return xi(t,"targets")}function wl(t){return xi(t,"targetGlobal")}function vl(t){return xi(t,"targetDocuments")}function bl([t,e],[n,r]){const s=ds(t,n);return 0===s?ds(e,r):s}class _l{constructor(t){this.Kn=t,this.buffer=new Mi(bl),this.$n=0}Un(){return++this.$n}Wn(t){const e=[t,this.Un()];if(this.buffer.size<this.Kn)this.buffer=this.buffer.add(e);else{const t=this.buffer.last();bl(e,t)<0&&(this.buffer=this.buffer.delete(t).add(e))}}get maxValue(){return this.buffer.last()[0]}}class Il{constructor(t,e,n){this.garbageCollector=t,this.asyncQueue=e,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.zn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}zn(t){jr("LruGarbageCollector",`Garbage collection scheduled in ${t}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",t,(async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(t){Us(t)?jr("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",t):await Os(t)}await this.zn(3e5)}))}}class El{constructor(t,e){this.jn=t,this.params=e}calculateTargetCount(t,e){return this.jn.Hn(t).next((t=>Math.floor(e/100*t)))}nthSequenceNumber(t,e){if(0===e)return Ps.resolve(Hs._e);const n=new _l(e);return this.jn.forEachTarget(t,(t=>n.Wn(t.sequenceNumber))).next((()=>this.jn.Jn(t,(t=>n.Wn(t))))).next((()=>n.maxValue))}removeTargets(t,e,n){return this.jn.removeTargets(t,e,n)}removeOrphanedDocuments(t,e){return this.jn.removeOrphanedDocuments(t,e)}collect(t,e){return-1===this.params.cacheSizeCollectionThreshold?(jr("LruGarbageCollector","Garbage collection skipped; disabled"),Ps.resolve(ol)):this.getCacheSize(t).next((n=>n<this.params.cacheSizeCollectionThreshold?(jr("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),ol):this.Yn(t,e)))}getCacheSize(t){return this.jn.getCacheSize(t)}Yn(t,e){let n,r,s,i,o,a,u;const c=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next((e=>(e>this.params.maximumSequenceNumbersToCollect?(jr("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${e}`),r=this.params.maximumSequenceNumbersToCollect):r=e,i=Date.now(),this.nthSequenceNumber(t,r)))).next((r=>(n=r,o=Date.now(),this.removeTargets(t,n,e)))).next((e=>(s=e,a=Date.now(),this.removeOrphanedDocuments(t,n)))).next((t=>(u=Date.now(),zr()<=_.DEBUG&&jr("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${i-c}ms\n\tDetermined least recently used ${r} in `+(o-i)+"ms\n"+`\tRemoved ${s} targets in `+(a-o)+"ms\n"+`\tRemoved ${t} documents in `+(u-a)+"ms\n"+`Total Duration: ${u-c}ms`),Ps.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:t}))))}}function Tl(t,e){return new El(t,e)}class Sl{constructor(t,e){this.db=t,this.garbageCollector=Tl(this,e)}Hn(t){const e=this.Zn(t);return this.db.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Zn(t){let e=0;return this.Jn(t,(t=>{e++})).next((()=>e))}forEachTarget(t,e){return this.db.getTargetCache().forEachTarget(t,e)}Jn(t,e){return this.Xn(t,((t,n)=>e(n)))}addReference(t,e,n){return xl(t,n)}removeReference(t,e,n){return xl(t,n)}removeTargets(t,e,n){return this.db.getTargetCache().removeTargets(t,e,n)}markPotentiallyOrphaned(t,e){return xl(t,e)}er(t,e){return function(t,e){let n=!1;return gl(t).Z((r=>hl(t,r,e).next((t=>(t&&(n=!0),Ps.resolve(!t)))))).next((()=>n))}(t,e)}removeOrphanedDocuments(t,e){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Xn(t,((i,o)=>{if(o<=e){const e=this.er(t,i).next((e=>{if(!e)return s++,n.getEntry(t,i).next((()=>(n.removeEntry(i,ps.min()),vl(t).delete(function(t){return[0,Js(t.path)]}(i)))))}));r.push(e)}})).next((()=>Ps.waitFor(r))).next((()=>n.apply(t))).next((()=>s))}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(t,n)}updateLimboDocument(t,e){return xl(t,e)}Xn(t,e){const n=vl(t);let r,s=Hs._e;return n.Y({index:"documentTargetsIndex"},(([t,n],{path:i,sequenceNumber:o})=>{0===t?(s!==Hs._e&&e(new _s(ei(r)),s),s=o,r=i):s=Hs._e})).next((()=>{s!==Hs._e&&e(new _s(ei(r)),s)}))}getCacheSize(t){return this.db.getRemoteDocumentCache().getSize(t)}}function xl(t,e){return vl(t).put(function(t,e){return{targetId:0,path:Js(t.path),sequenceNumber:e}}(e,t.currentSequenceNumber))}class Cl{constructor(){this.changes=new pa((t=>t.toString()),((t,e)=>t.isEqual(e))),this.changesApplied=!1}addEntry(t){this.assertNotApplied(),this.changes.set(t.key,t)}removeEntry(t,e){this.assertNotApplied(),this.changes.set(t,bo.newInvalidDocument(t).setReadTime(e))}getEntry(t,e){this.assertNotApplied();const n=this.changes.get(e);return void 0!==n?Ps.resolve(n):this.getFromCache(t,e)}getEntries(t,e){return this.getAllFromCache(t,e)}apply(t){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(t)}assertNotApplied(){}}class Dl{constructor(t){this.serializer=t}setIndexManager(t){this.indexManager=t}addEntry(t,e,n){return Rl(t).put(n)}removeEntry(t,e,n){return Rl(t).delete(function(t,e){const n=t.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],pc(e),n[n.length-1]]}(e,n))}updateMetadata(t,e){return this.getMetadata(t).next((n=>(n.byteSize+=e,this.tr(t,n))))}getEntry(t,e){let n=bo.newInvalidDocument(e);return Rl(t).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Ml(e))},((t,r)=>{n=this.nr(e,r)})).next((()=>n))}rr(t,e){let n={size:0,document:bo.newInvalidDocument(e)};return Rl(t).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Ml(e))},((t,r)=>{n={document:this.nr(e,r),size:cl(r)}})).next((()=>n))}getEntries(t,e){let n=wa();return this.ir(t,e,((t,e)=>{const r=this.nr(t,e);n=n.insert(t,r)})).next((()=>n))}sr(t,e){let n=wa(),r=new Ni(_s.comparator);return this.ir(t,e,((t,e)=>{const s=this.nr(t,e);n=n.insert(t,s),r=r.insert(t,cl(e))})).next((()=>({documents:n,_r:r})))}ir(t,e,n){if(e.isEmpty())return Ps.resolve();let r=new Mi(Ol);e.forEach((t=>r=r.add(t)));const s=IDBKeyRange.bound(Ml(r.first()),Ml(r.last())),i=r.getIterator();let o=i.getNext();return Rl(t).Y({index:"documentKeyIndex",range:s},((t,e,r)=>{const s=_s.fromSegments([...e.prefixPath,e.collectionGroup,e.documentId]);for(;o&&Ol(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,e),o=i.hasNext()?i.getNext():null),o?r.U(Ml(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(t,e,n,r,s){const i=e.path,o=[i.popLast().toArray(),i.lastSegment(),pc(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],a=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Rl(t).W(IDBKeyRange.bound(o,a,!0)).next((t=>{null==s||s.incrementDocumentReadCount(t.length);let n=wa();for(const s of t){const t=this.nr(_s.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);t.isFoundDocument()&&(da(e,t)||r.has(t.key))&&(n=n.insert(t.key,t))}return n}))}getAllFromCollectionGroup(t,e,n,r){let s=wa();const i=Ll(e,n),o=Ll(e,ks.max());return Rl(t).Y({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((t,e,n)=>{const i=this.nr(_s.fromSegments(e.prefixPath.concat(e.collectionGroup,e.documentId)),e);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(t){return new Nl(this,!!t&&t.trackRemovals)}getSize(t){return this.getMetadata(t).next((t=>t.byteSize))}getMetadata(t){return kl(t).get("remoteDocumentGlobalKey").next((t=>(Wr(!!t),t)))}tr(t,e){return kl(t).put("remoteDocumentGlobalKey",e)}nr(t,e){if(e){const t=function(t,e){let n;if(e.document)n=Ju(t.ct,e.document,!!e.hasCommittedMutations);else if(e.noDocument){const t=_s.fromSegments(e.noDocument.path),r=wc(e.noDocument.readTime);n=bo.newNoDocument(t,r),e.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!e.unknownDocument)return Hr();{const t=_s.fromSegments(e.unknownDocument.path),r=wc(e.unknownDocument.version);n=bo.newUnknownDocument(t,r)}}return e.readTime&&n.setReadTime(function(t){const e=new ms(t[0],t[1]);return ps.fromTimestamp(e)}(e.readTime)),n}(this.serializer,e);if(!t.isNoDocument()||!t.version.isEqual(ps.min()))return t}return bo.newInvalidDocument(t)}}function Al(t){return new Dl(t)}class Nl extends Cl{constructor(t,e){super(),this.ar=t,this.trackRemovals=e,this.ur=new pa((t=>t.toString()),((t,e)=>t.isEqual(e)))}applyChanges(t){const e=[];let n=0,r=new Mi(((t,e)=>ds(t.canonicalString(),e.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.ur.get(s);if(e.push(this.ar.removeEntry(t,s,o.readTime)),i.isValidDocument()){const a=mc(this.ar.serializer,i);r=r.add(s.path.popLast());const u=cl(a);n+=u-o.size,e.push(this.ar.addEntry(t,s,a))}else if(n-=o.size,this.trackRemovals){const n=mc(this.ar.serializer,i.convertToNoDocument(ps.min()));e.push(this.ar.addEntry(t,s,n))}})),r.forEach((n=>{e.push(this.ar.indexManager.addToCollectionParentIndex(t,n))})),e.push(this.ar.updateMetadata(t,n)),Ps.waitFor(e)}getFromCache(t,e){return this.ar.rr(t,e).next((t=>(this.ur.set(e,{size:t.size,readTime:t.document.readTime}),t.document)))}getAllFromCache(t,e){return this.ar.sr(t,e).next((({documents:t,_r:e})=>(e.forEach(((e,n)=>{this.ur.set(e,{size:n,readTime:t.get(e).readTime})})),t)))}}function kl(t){return xi(t,"remoteDocumentGlobal")}function Rl(t){return xi(t,"remoteDocumentsV14")}function Ml(t){const e=t.path.toArray();return[e.slice(0,e.length-2),e[e.length-2],e[e.length-1]]}function Ll(t,e){const n=e.documentKey.path.toArray();return[t,pc(e.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Ol(t,e){const n=t.path.toArray(),r=e.path.toArray();let s=0;for(let t=0;t<n.length-2&&t<r.length-2;++t)if(s=ds(n[t],r[t]),s)return s;return s=ds(n.length,r.length),s||(s=ds(n[n.length-2],r[r.length-2]),s||ds(n[n.length-1],r[r.length-1]))}class Pl{constructor(t,e){this.overlayedDocument=t,this.mutatedFields=e}}class Fl{constructor(t,e,n,r){this.remoteDocumentCache=t,this.mutationQueue=e,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,e){let n=null;return this.documentOverlayCache.getOverlay(t,e).next((r=>(n=r,this.remoteDocumentCache.getEntry(t,e)))).next((t=>(null!==n&&Ja(n.mutation,t,Pi.empty(),ms.now()),t)))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.getLocalViewOfDocuments(t,e,Ca()).next((()=>e))))}getLocalViewOfDocuments(t,e,n=Ca()){const r=Ia();return this.populateOverlays(t,r,e).next((()=>this.computeViews(t,e,r,n).next((t=>{let e=ba();return t.forEach(((t,n)=>{e=e.insert(t,n.overlayedDocument)})),e}))))}getOverlayedDocuments(t,e){const n=Ia();return this.populateOverlays(t,n,e).next((()=>this.computeViews(t,e,n,Ca())))}populateOverlays(t,e,n){const r=[];return n.forEach((t=>{e.has(t)||r.push(t)})),this.documentOverlayCache.getOverlays(t,r).next((t=>{t.forEach(((t,n)=>{e.set(t,n)}))}))}computeViews(t,e,n,r){let s=wa();const i=Ta(),o=Ta();return e.forEach(((t,e)=>{const o=n.get(e.key);r.has(e.key)&&(void 0===o||o.mutation instanceof nu)?s=s.insert(e.key,e):void 0!==o?(i.set(e.key,o.mutation.getFieldMask()),Ja(o.mutation,e,o.mutation.getFieldMask(),ms.now())):i.set(e.key,Pi.empty())})),this.recalculateAndSaveOverlays(t,s).next((t=>(t.forEach(((t,e)=>i.set(t,e))),e.forEach(((t,e)=>{var n;return o.set(t,new Pl(e,null!==(n=i.get(t))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(t,e){const n=Ta();let r=new Ni(((t,e)=>t-e)),s=Ca();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(t,e).next((t=>{for(const s of t)s.keys().forEach((t=>{const i=e.get(t);if(null===i)return;let o=n.get(t)||Pi.empty();o=s.applyToLocalView(i,o),n.set(t,o);const a=(r.get(s.batchId)||Ca()).add(t);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,u=r.value,c=Ea();u.forEach((t=>{if(!s.has(t)){const r=Ya(e.get(t),n.get(t));null!==r&&c.set(t,r),s=s.add(t)}})),i.push(this.documentOverlayCache.saveOverlays(t,a,c))}return Ps.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next((e=>this.recalculateAndSaveOverlays(t,e)))}getDocumentsMatchingQuery(t,e,n,r){return function(t){return _s.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length}(e)?this.getDocumentsMatchingDocumentQuery(t,e.path):ra(e)?this.getDocumentsMatchingCollectionGroupQuery(t,e,n,r):this.getDocumentsMatchingCollectionQuery(t,e,n,r)}getNextDocuments(t,e,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(t,e,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(t,e,n.largestBatchId,r-s.size):Ps.resolve(Ia());let o=-1,a=s;return i.next((e=>Ps.forEach(e,((e,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(e)?Ps.resolve():this.remoteDocumentCache.getEntry(t,e).next((t=>{a=a.insert(e,t)}))))).next((()=>this.populateOverlays(t,e,s))).next((()=>this.computeViews(t,a,e,Ca()))).next((t=>({batchId:o,changes:_a(t)})))))}))}getDocumentsMatchingDocumentQuery(t,e){return this.getDocument(t,new _s(e)).next((t=>{let e=ba();return t.isFoundDocument()&&(e=e.insert(t.key,t)),e}))}getDocumentsMatchingCollectionGroupQuery(t,e,n,r){const s=e.collectionGroup;let i=ba();return this.indexManager.getCollectionParents(t,s).next((o=>Ps.forEach(o,(o=>{const a=function(t,e){return new Zo(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(e,o.child(s));return this.getDocumentsMatchingCollectionQuery(t,a,n,r).next((t=>{t.forEach(((t,e)=>{i=i.insert(t,e)}))}))})).next((()=>i))))}getDocumentsMatchingCollectionQuery(t,e,n,r){let s;return this.documentOverlayCache.getOverlaysForCollection(t,e.path,n.largestBatchId).next((i=>(s=i,this.remoteDocumentCache.getDocumentsMatchingQuery(t,e,n,s,r)))).next((t=>{s.forEach(((e,n)=>{const r=n.getKey();null===t.get(r)&&(t=t.insert(r,bo.newInvalidDocument(r)))}));let n=ba();return t.forEach(((t,r)=>{const i=s.get(t);void 0!==i&&Ja(i.mutation,r,Pi.empty(),ms.now()),da(e,r)&&(n=n.insert(t,r))})),n}))}}class Vl{constructor(t){this.serializer=t,this.cr=new Map,this.lr=new Map}getBundleMetadata(t,e){return Ps.resolve(this.cr.get(e))}saveBundleMetadata(t,e){return this.cr.set(e.id,function(t){return{id:t.id,version:t.version,createTime:Uu(t.createTime)}}(e)),Ps.resolve()}getNamedQuery(t,e){return Ps.resolve(this.lr.get(e))}saveNamedQuery(t,e){return this.lr.set(e.name,function(t){return{name:t.name,query:Ic(t.bundledQuery),readTime:Uu(t.readTime)}}(e)),Ps.resolve()}}class ql{constructor(){this.overlays=new Ni(_s.comparator),this.hr=new Map}getOverlay(t,e){return Ps.resolve(this.overlays.get(e))}getOverlays(t,e){const n=Ia();return Ps.forEach(e,(e=>this.getOverlay(t,e).next((t=>{null!==t&&n.set(e,t)})))).next((()=>n))}saveOverlays(t,e,n){return n.forEach(((n,r)=>{this.ht(t,e,r)})),Ps.resolve()}removeOverlaysForBatchId(t,e,n){const r=this.hr.get(n);return void 0!==r&&(r.forEach((t=>this.overlays=this.overlays.remove(t))),this.hr.delete(n)),Ps.resolve()}getOverlaysForCollection(t,e,n){const r=Ia(),s=e.length+1,i=new _s(e.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const t=o.getNext().value,i=t.getKey();if(!e.isPrefixOf(i.path))break;i.path.length===s&&t.largestBatchId>n&&r.set(t.getKey(),t)}return Ps.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new Ni(((t,e)=>t-e));const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=Ia(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const o=Ia(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((t,e)=>o.set(t,e))),!(o.size()>=r)););return Ps.resolve(o)}ht(t,e,n){const r=this.overlays.get(n.key);if(null!==r){const t=this.hr.get(r.largestBatchId).delete(n.key);this.hr.set(r.largestBatchId,t)}this.overlays=this.overlays.insert(n.key,new lu(e,n));let s=this.hr.get(e);void 0===s&&(s=Ca(),this.hr.set(e,s)),this.hr.set(e,s.add(n.key))}}class Bl{constructor(){this.Pr=new Mi(Ul.Ir),this.Tr=new Mi(Ul.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(t,e){const n=new Ul(t,e);this.Pr=this.Pr.add(n),this.Tr=this.Tr.add(n)}dr(t,e){t.forEach((t=>this.addReference(t,e)))}removeReference(t,e){this.Ar(new Ul(t,e))}Rr(t,e){t.forEach((t=>this.removeReference(t,e)))}Vr(t){const e=new _s(new ws([])),n=new Ul(e,t),r=new Ul(e,t+1),s=[];return this.Tr.forEachInRange([n,r],(t=>{this.Ar(t),s.push(t.key)})),s}mr(){this.Pr.forEach((t=>this.Ar(t)))}Ar(t){this.Pr=this.Pr.delete(t),this.Tr=this.Tr.delete(t)}gr(t){const e=new _s(new ws([])),n=new Ul(e,t),r=new Ul(e,t+1);let s=Ca();return this.Tr.forEachInRange([n,r],(t=>{s=s.add(t.key)})),s}containsKey(t){const e=new Ul(t,0),n=this.Pr.firstAfterOrEqual(e);return null!==n&&t.isEqual(n.key)}}class Ul{constructor(t,e){this.key=t,this.pr=e}static Ir(t,e){return _s.comparator(t.key,e.key)||ds(t.pr,e.pr)}static Er(t,e){return ds(t.pr,e.pr)||_s.comparator(t.key,e.key)}}class zl{constructor(t,e){this.indexManager=t,this.referenceDelegate=e,this.mutationQueue=[],this.yr=1,this.wr=new Mi(Ul.Ir)}checkEmpty(t){return Ps.resolve(0===this.mutationQueue.length)}addMutationBatch(t,e,n,r){const s=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new uu(s,e,n,r);this.mutationQueue.push(i);for(const e of r)this.wr=this.wr.add(new Ul(e.key,s)),this.indexManager.addToCollectionParentIndex(t,e.key.path.popLast());return Ps.resolve(i)}lookupMutationBatch(t,e){return Ps.resolve(this.Sr(e))}getNextMutationBatchAfterBatchId(t,e){const n=e+1,r=this.br(n),s=r<0?0:r;return Ps.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return Ps.resolve(0===this.mutationQueue.length?-1:this.yr-1)}getAllMutationBatches(t){return Ps.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(t,e){const n=new Ul(e,0),r=new Ul(e,Number.POSITIVE_INFINITY),s=[];return this.wr.forEachInRange([n,r],(t=>{const e=this.Sr(t.pr);s.push(e)})),Ps.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(t,e){let n=new Mi(ds);return e.forEach((t=>{const e=new Ul(t,0),r=new Ul(t,Number.POSITIVE_INFINITY);this.wr.forEachInRange([e,r],(t=>{n=n.add(t.pr)}))})),Ps.resolve(this.Dr(n))}getAllMutationBatchesAffectingQuery(t,e){const n=e.path,r=n.length+1;let s=n;_s.isDocumentKey(s)||(s=s.child(""));const i=new Ul(new _s(s),0);let o=new Mi(ds);return this.wr.forEachWhile((t=>{const e=t.key.path;return!!n.isPrefixOf(e)&&(e.length===r&&(o=o.add(t.pr)),!0)}),i),Ps.resolve(this.Dr(o))}Dr(t){const e=[];return t.forEach((t=>{const n=this.Sr(t);null!==n&&e.push(n)})),e}removeMutationBatch(t,e){Wr(0===this.Cr(e.batchId,"removed")),this.mutationQueue.shift();let n=this.wr;return Ps.forEach(e.mutations,(r=>{const s=new Ul(r.key,e.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(t,r.key)})).next((()=>{this.wr=n}))}Mn(t){}containsKey(t,e){const n=new Ul(e,0),r=this.wr.firstAfterOrEqual(n);return Ps.resolve(e.isEqual(r&&r.key))}performConsistencyCheck(t){return this.mutationQueue.length,Ps.resolve()}Cr(t,e){return this.br(t)}br(t){return 0===this.mutationQueue.length?0:t-this.mutationQueue[0].batchId}Sr(t){const e=this.br(t);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class Gl{constructor(t){this.vr=t,this.docs=new Ni(_s.comparator),this.size=0}setIndexManager(t){this.indexManager=t}addEntry(t,e){const n=e.key,r=this.docs.get(n),s=r?r.size:0,i=this.vr(e);return this.docs=this.docs.insert(n,{document:e.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(t,n.path.popLast())}removeEntry(t){const e=this.docs.get(t);e&&(this.docs=this.docs.remove(t),this.size-=e.size)}getEntry(t,e){const n=this.docs.get(e);return Ps.resolve(n?n.document.mutableCopy():bo.newInvalidDocument(e))}getEntries(t,e){let n=wa();return e.forEach((t=>{const e=this.docs.get(t);n=n.insert(t,e?e.document.mutableCopy():bo.newInvalidDocument(t))})),Ps.resolve(n)}getDocumentsMatchingQuery(t,e,n,r){let s=wa();const i=e.path,o=new _s(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:t,value:{document:o}}=a.getNext();if(!i.isPrefixOf(t.path))break;t.path.length>i.length+1||Rs(Ns(o),n)<=0||(r.has(o.key)||da(e,o))&&(s=s.insert(o.key,o.mutableCopy()))}return Ps.resolve(s)}getAllFromCollectionGroup(t,e,n,r){Hr()}Fr(t,e){return Ps.forEach(this.docs,(t=>e(t)))}newChangeBuffer(t){return new jl(this)}getSize(t){return Ps.resolve(this.size)}}class jl extends Cl{constructor(t){super(),this.ar=t}applyChanges(t){const e=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?e.push(this.ar.addEntry(t,r)):this.ar.removeEntry(n)})),Ps.waitFor(e)}getFromCache(t,e){return this.ar.getEntry(t,e)}getAllFromCache(t,e){return this.ar.getEntries(t,e)}}class Kl{constructor(t){this.persistence=t,this.Mr=new pa((t=>Qo(t)),Ho),this.lastRemoteSnapshotVersion=ps.min(),this.highestTargetId=0,this.Or=0,this.Nr=new Bl,this.targetCount=0,this.Br=ml.Nn()}forEachTarget(t,e){return this.Mr.forEach(((t,n)=>e(n))),Ps.resolve()}getLastRemoteSnapshotVersion(t){return Ps.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(t){return Ps.resolve(this.Or)}allocateTargetId(t){return this.highestTargetId=this.Br.next(),Ps.resolve(this.highestTargetId)}setTargetsMetadata(t,e,n){return n&&(this.lastRemoteSnapshotVersion=n),e>this.Or&&(this.Or=e),Ps.resolve()}qn(t){this.Mr.set(t.target,t);const e=t.targetId;e>this.highestTargetId&&(this.Br=new ml(e),this.highestTargetId=e),t.sequenceNumber>this.Or&&(this.Or=t.sequenceNumber)}addTargetData(t,e){return this.qn(e),this.targetCount+=1,Ps.resolve()}updateTargetData(t,e){return this.qn(e),Ps.resolve()}removeTargetData(t,e){return this.Mr.delete(e.target),this.Nr.Vr(e.targetId),this.targetCount-=1,Ps.resolve()}removeTargets(t,e,n){let r=0;const s=[];return this.Mr.forEach(((i,o)=>{o.sequenceNumber<=e&&null===n.get(o.targetId)&&(this.Mr.delete(i),s.push(this.removeMatchingKeysForTargetId(t,o.targetId)),r++)})),Ps.waitFor(s).next((()=>r))}getTargetCount(t){return Ps.resolve(this.targetCount)}getTargetData(t,e){const n=this.Mr.get(e)||null;return Ps.resolve(n)}addMatchingKeys(t,e,n){return this.Nr.dr(e,n),Ps.resolve()}removeMatchingKeys(t,e,n){this.Nr.Rr(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach((e=>{s.push(r.markPotentiallyOrphaned(t,e))})),Ps.waitFor(s)}removeMatchingKeysForTargetId(t,e){return this.Nr.Vr(e),Ps.resolve()}getMatchingKeysForTargetId(t,e){const n=this.Nr.gr(e);return Ps.resolve(n)}containsKey(t,e){return Ps.resolve(this.Nr.containsKey(e))}}class $l{constructor(t,e){this.Lr={},this.overlays={},this.kr=new Hs(0),this.qr=!1,this.qr=!0,this.referenceDelegate=t(this),this.Qr=new Kl(this),this.indexManager=new Xc,this.remoteDocumentCache=function(t){return new Gl(t)}((t=>this.referenceDelegate.Kr(t))),this.serializer=new gc(e),this.$r=new Vl(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(t){return this.indexManager}getDocumentOverlayCache(t){let e=this.overlays[t.toKey()];return e||(e=new ql,this.overlays[t.toKey()]=e),e}getMutationQueue(t,e){let n=this.Lr[t.toKey()];return n||(n=new zl(e,this.referenceDelegate),this.Lr[t.toKey()]=n),n}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(t,e,n){jr("MemoryPersistence","Starting transaction:",t);const r=new Ql(this.kr.next());return this.referenceDelegate.Ur(),n(r).next((t=>this.referenceDelegate.Wr(r).next((()=>t)))).toPromise().then((t=>(r.raiseOnCommittedEvent(),t)))}Gr(t,e){return Ps.or(Object.values(this.Lr).map((n=>()=>n.containsKey(t,e))))}}class Ql extends Ls{constructor(t){super(),this.currentSequenceNumber=t}}class Hl{constructor(t){this.persistence=t,this.zr=new Bl,this.jr=null}static Hr(t){return new Hl(t)}get Jr(){if(this.jr)return this.jr;throw Hr()}addReference(t,e,n){return this.zr.addReference(n,e),this.Jr.delete(n.toString()),Ps.resolve()}removeReference(t,e,n){return this.zr.removeReference(n,e),this.Jr.add(n.toString()),Ps.resolve()}markPotentiallyOrphaned(t,e){return this.Jr.add(e.toString()),Ps.resolve()}removeTarget(t,e){this.zr.Vr(e.targetId).forEach((t=>this.Jr.add(t.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(t,e.targetId).next((t=>{t.forEach((t=>this.Jr.add(t.toString())))})).next((()=>n.removeTargetData(t,e)))}Ur(){this.jr=new Set}Wr(t){const e=this.persistence.getRemoteDocumentCache().newChangeBuffer();return Ps.forEach(this.Jr,(n=>{const r=_s.fromPath(n);return this.Yr(t,r).next((t=>{t||e.removeEntry(r,ps.min())}))})).next((()=>(this.jr=null,e.apply(t))))}updateLimboDocument(t,e){return this.Yr(t,e).next((t=>{t?this.Jr.delete(e.toString()):this.Jr.add(e.toString())}))}Kr(t){return 0}Yr(t,e){return Ps.or([()=>Ps.resolve(this.zr.containsKey(e)),()=>this.persistence.getTargetCache().containsKey(t,e),()=>this.persistence.Gr(t,e)])}}class Wl{constructor(t,e){this.persistence=t,this.Zr=new pa((t=>Js(t.path)),((t,e)=>t.isEqual(e))),this.garbageCollector=Tl(this,e)}static Hr(t,e){return new Wl(t,e)}Ur(){}Wr(t){return Ps.resolve()}forEachTarget(t,e){return this.persistence.getTargetCache().forEachTarget(t,e)}Hn(t){const e=this.Zn(t);return this.persistence.getTargetCache().getTargetCount(t).next((t=>e.next((e=>t+e))))}Zn(t){let e=0;return this.Jn(t,(t=>{e++})).next((()=>e))}Jn(t,e){return Ps.forEach(this.Zr,((n,r)=>this.er(t,n,r).next((t=>t?Ps.resolve():e(r)))))}removeTargets(t,e,n){return this.persistence.getTargetCache().removeTargets(t,e,n)}removeOrphanedDocuments(t,e){let n=0;const r=this.persistence.getRemoteDocumentCache(),s=r.newChangeBuffer();return r.Fr(t,(r=>this.er(t,r,e).next((t=>{t||(n++,s.removeEntry(r,ps.min()))})))).next((()=>s.apply(t))).next((()=>n))}markPotentiallyOrphaned(t,e){return this.Zr.set(e,t.currentSequenceNumber),Ps.resolve()}removeTarget(t,e){const n=e.withSequenceNumber(t.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(t,n)}addReference(t,e,n){return this.Zr.set(n,t.currentSequenceNumber),Ps.resolve()}removeReference(t,e,n){return this.Zr.set(n,t.currentSequenceNumber),Ps.resolve()}updateLimboDocument(t,e){return this.Zr.set(e,t.currentSequenceNumber),Ps.resolve()}Kr(t){let e=t.key.toString().length;return t.isFoundDocument()&&(e+=so(t.data.value)),e}er(t,e,n){return Ps.or([()=>this.persistence.Gr(t,e),()=>this.persistence.getTargetCache().containsKey(t,e),()=>{const t=this.Zr.get(e);return Ps.resolve(void 0!==t&&t>n)}])}getCacheSize(t){return this.persistence.getRemoteDocumentCache().getSize(t)}}class Yl{constructor(t){this.serializer=t}N(t,e,n,r){const s=new Fs("createOrUpgrade",e);n<1&&r>=1&&(function(t){t.createObjectStore("owner")}(t),function(t){t.createObjectStore("mutationQueues",{keyPath:"userId"}),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",ni,{unique:!0}),t.createObjectStore("documentMutations")}(t),Xl(t),function(t){t.createObjectStore("remoteDocuments")}(t));let i=Ps.resolve();return n<3&&r>=3&&(0!==n&&(function(t){t.deleteObjectStore("targetDocuments"),t.deleteObjectStore("targets"),t.deleteObjectStore("targetGlobal")}(t),Xl(t)),i=i.next((()=>function(t){const e=t.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:ps.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(t,e){return e.store("mutations").W().next((n=>{t.deleteObjectStore("mutations"),t.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",ni,{unique:!0});const r=e.store("mutations"),s=n.map((t=>r.put(t)));return Ps.waitFor(s)}))}(t,s)))),i=i.next((()=>{!function(t){t.createObjectStore("clientMetadata",{keyPath:"clientId"})}(t)}))),n<5&&r>=5&&(i=i.next((()=>this.Xr(s)))),n<6&&r>=6&&(i=i.next((()=>(function(t){t.createObjectStore("remoteDocumentGlobal")}(t),this.ei(s))))),n<7&&r>=7&&(i=i.next((()=>this.ti(s)))),n<8&&r>=8&&(i=i.next((()=>this.ni(t,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(t){t.objectStoreNames.contains("remoteDocumentChanges")&&t.deleteObjectStore("remoteDocumentChanges")}(t)}))),n<10&&r>=10&&(i=i.next((()=>this.ri(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(t){t.createObjectStore("bundles",{keyPath:"bundleId"})}(t),function(t){t.createObjectStore("namedQueries",{keyPath:"name"})}(t)}))),n<12&&r>=12&&(i=i.next((()=>{!function(t){const e=t.createObjectStore("documentOverlays",{keyPath:yi});e.createIndex("collectionPathOverlayIndex",wi,{unique:!1}),e.createIndex("collectionGroupOverlayIndex",vi,{unique:!1})}(t)}))),n<13&&r>=13&&(i=i.next((()=>function(t){const e=t.createObjectStore("remoteDocumentsV14",{keyPath:oi});e.createIndex("documentKeyIndex",ai),e.createIndex("collectionGroupIndex",ui)}(t))).next((()=>this.ii(t,s))).next((()=>t.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>this.si(t,s)))),n<15&&r>=15&&(i=i.next((()=>function(t){t.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),t.createObjectStore("indexState",{keyPath:fi}).createIndex("sequenceNumberIndex",gi,{unique:!1}),t.createObjectStore("indexEntries",{keyPath:mi}).createIndex("documentKeyIndex",pi,{unique:!1})}(t)))),i}ei(t){let e=0;return t.store("remoteDocuments").Y(((t,n)=>{e+=cl(n)})).next((()=>{const n={byteSize:e};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Xr(t){const e=t.store("mutationQueues"),n=t.store("mutations");return e.W().next((e=>Ps.forEach(e,(e=>{const r=IDBKeyRange.bound([e.userId,-1],[e.userId,e.lastAcknowledgedBatchId]);return n.W("userMutationsIndex",r).next((n=>Ps.forEach(n,(n=>{Wr(n.userId===e.userId);const r=vc(this.serializer,n);return ul(t,e.userId,r).next((()=>{}))}))))}))))}ti(t){const e=t.store("targetDocuments"),n=t.store("remoteDocuments");return t.store("targetGlobal").get("targetGlobalKey").next((t=>{const r=[];return n.Y(((n,s)=>{const i=new ws(n),o=function(t){return[0,Js(t)]}(i);r.push(e.get(o).next((n=>n?Ps.resolve():(n=>e.put({targetId:0,path:Js(n),sequenceNumber:t.highestListenSequenceNumber}))(i))))})).next((()=>Ps.waitFor(r)))}))}ni(t,e){t.createObjectStore("collectionParents",{keyPath:di});const n=e.store("collectionParents"),r=new Jc,s=t=>{if(r.add(t)){const e=t.lastSegment(),r=t.popLast();return n.put({collectionId:e,parent:Js(r)})}};return e.store("remoteDocuments").Y({J:!0},((t,e)=>{const n=new ws(t);return s(n.popLast())})).next((()=>e.store("documentMutations").Y({J:!0},(([t,e,n],r)=>{const i=ei(e);return s(i.popLast())}))))}ri(t){const e=t.store("targets");return e.Y(((t,n)=>{const r=bc(n),s=_c(this.serializer,r);return e.put(s)}))}ii(t,e){const n=e.store("remoteDocuments"),r=[];return n.Y(((t,n)=>{const s=e.store("remoteDocumentsV14"),i=function(t){return t.document?new _s(ws.fromString(t.document.name).popFirst(5)):t.noDocument?_s.fromSegments(t.noDocument.path):t.unknownDocument?_s.fromSegments(t.unknownDocument.path):Hr()}(n).path.toArray(),o={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(o))})).next((()=>Ps.waitFor(r)))}si(t,e){const n=e.store("mutations"),r=Al(this.serializer),s=new $l(Hl.Hr,this.serializer.ct);return n.W().next((t=>{const n=new Map;return t.forEach((t=>{var e;let r=null!==(e=n.get(t.userId))&&void 0!==e?e:Ca();vc(this.serializer,t).keys().forEach((t=>r=r.add(t))),n.set(t.userId,r)})),Ps.forEach(n,((t,n)=>{const i=new qr(n),o=Ac.lt(this.serializer,i),a=s.getIndexManager(i),u=ll.lt(i,this.serializer,a,s.referenceDelegate);return new Fl(r,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new Si(e,Hs._e),t).next()}))}))}}function Xl(t){t.createObjectStore("targetDocuments",{keyPath:li}).createIndex("documentTargetsIndex",hi,{unique:!0}),t.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",ci,{unique:!0}),t.createObjectStore("targetGlobal")}const Jl="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Zl{constructor(t,e,n,r,s,i,o,a,u,c,l=15){if(this.allowTabSynchronization=t,this.persistenceKey=e,this.clientId=n,this.oi=s,this.window=i,this.document=o,this._i=u,this.ai=c,this.ui=l,this.kr=null,this.qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.li=null,this.hi=null,this.Pi=Number.NEGATIVE_INFINITY,this.Ii=t=>Promise.resolve(),!Zl.D())throw new Zr(Jr.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Sl(this,r),this.Ti=e+"main",this.serializer=new gc(a),this.Ei=new Vs(this.Ti,this.ui,new Yl(this.serializer)),this.Qr=new pl(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Al(this.serializer),this.$r=new xc,this.window&&this.window.localStorage?this.di=this.window.localStorage:(this.di=null,!1===c&&Kr("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ai().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new Zr(Jr.FAILED_PRECONDITION,Jl);return this.Ri(),this.Vi(),this.mi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(t=>this.Qr.getHighestSequenceNumber(t)))})).then((t=>{this.kr=new Hs(t,this._i)})).then((()=>{this.qr=!0})).catch((t=>(this.Ei&&this.Ei.close(),Promise.reject(t))))}fi(t){return this.Ii=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.Ei.L((async e=>{null===e.newVersion&&await t()}))}setNetworkEnabled(t){this.networkEnabled!==t&&(this.networkEnabled=t,this.oi.enqueueAndForget((async()=>{this.started&&await this.Ai()})))}Ai(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(t=>eh(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.gi(t).next((t=>{t||(this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))))}))})).next((()=>this.pi(t))).next((e=>this.isPrimary&&!e?this.yi(t).next((()=>!1)):!!e&&this.wi(t).next((()=>!0)))))).catch((t=>{if(Us(t))return jr("IndexedDbPersistence","Failed to extend owner lease: ",t),this.isPrimary;if(!this.allowTabSynchronization)throw t;return jr("IndexedDbPersistence","Releasing owner lease after error during lease refresh",t),!1})).then((t=>{this.isPrimary!==t&&this.oi.enqueueRetryable((()=>this.Ii(t))),this.isPrimary=t}))}gi(t){return th(t).get("owner").next((t=>Ps.resolve(this.Si(t))))}bi(t){return eh(t).delete(this.clientId)}async Di(){if(this.isPrimary&&!this.Ci(this.Pi,18e5)){this.Pi=Date.now();const t=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(t=>{const e=xi(t,"clientMetadata");return e.W().next((t=>{const n=this.vi(t,18e5),r=t.filter((t=>-1===n.indexOf(t)));return Ps.forEach(r,(t=>e.delete(t.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.di)for(const e of t)this.di.removeItem(this.Fi(e.clientId))}}mi(){this.hi=this.oi.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.Ai().then((()=>this.Di())).then((()=>this.mi()))))}Si(t){return!!t&&t.ownerId===this.clientId}pi(t){return this.ai?Ps.resolve(!0):th(t).get("owner").next((e=>{if(null!==e&&this.Ci(e.leaseTimestampMs,5e3)&&!this.Mi(e.ownerId)){if(this.Si(e)&&this.networkEnabled)return!0;if(!this.Si(e)){if(!e.allowTabSynchronization)throw new Zr(Jr.FAILED_PRECONDITION,Jl);return!1}}return!(!this.networkEnabled||!this.inForeground)||eh(t).W().next((t=>void 0===this.vi(t,5e3).find((t=>{if(this.clientId!==t.clientId){const e=!this.networkEnabled&&t.networkEnabled,n=!this.inForeground&&t.inForeground,r=this.networkEnabled===t.networkEnabled;if(e||n&&r)return!0}return!1}))))})).next((t=>(this.isPrimary!==t&&jr("IndexedDbPersistence",`Client ${t?"is":"is not"} eligible for a primary lease.`),t)))}async shutdown(){this.qr=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Oi(),this.Ni(),await this.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(t=>{const e=new Si(t,Hs._e);return this.yi(e).next((()=>this.bi(e)))})),this.Ei.close(),this.Bi()}vi(t,e){return t.filter((t=>this.Ci(t.updateTimeMs,e)&&!this.Mi(t.clientId)))}Li(){return this.runTransaction("getActiveClients","readonly",(t=>eh(t).W().next((t=>this.vi(t,18e5).map((t=>t.clientId))))))}get started(){return this.qr}getMutationQueue(t,e){return ll.lt(t,this.serializer,e,this.referenceDelegate)}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(t){return new tl(t,this.serializer.ct.databaseId)}getDocumentOverlayCache(t){return Ac.lt(this.serializer,t)}getBundleCache(){return this.$r}runTransaction(t,e,n){jr("IndexedDbPersistence","Starting transaction:",t);const r="readonly"===e?"readonly":"readwrite",s=function(t){return 15===t?Ti:14===t?Ei:13===t?Ii:12===t?_i:11===t?bi:void Hr()}(this.ui);let i;return this.Ei.runTransaction(t,r,s,(r=>(i=new Si(r,this.kr?this.kr.next():Hs._e),"readwrite-primary"===e?this.gi(i).next((t=>!!t||this.pi(i))).next((e=>{if(!e)throw Kr(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))),new Zr(Jr.FAILED_PRECONDITION,Ms);return n(i)})).next((t=>this.wi(i).next((()=>t)))):this.ki(i).next((()=>n(i)))))).then((t=>(i.raiseOnCommittedEvent(),t)))}ki(t){return th(t).get("owner").next((t=>{if(null!==t&&this.Ci(t.leaseTimestampMs,5e3)&&!this.Mi(t.ownerId)&&!this.Si(t)&&!(this.ai||this.allowTabSynchronization&&t.allowTabSynchronization))throw new Zr(Jr.FAILED_PRECONDITION,Jl)}))}wi(t){const e={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return th(t).put("owner",e)}static D(){return Vs.D()}yi(t){const e=th(t);return e.get("owner").next((t=>this.Si(t)?(jr("IndexedDbPersistence","Releasing primary lease."),e.delete("owner")):Ps.resolve()))}Ci(t,e){const n=Date.now();return!(t<n-e||t>n&&(Kr(`Detected an update time that is in the future: ${t} > ${n}`),1))}Ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.li=()=>{this.oi.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.Ai())))},this.document.addEventListener("visibilitychange",this.li),this.inForeground="visible"===this.document.visibilityState)}Oi(){this.li&&(this.document.removeEventListener("visibilitychange",this.li),this.li=null)}Vi(){var t;"function"==typeof(null===(t=this.window)||void 0===t?void 0:t.addEventListener)&&(this.ci=()=>{this.xi();const t=/(?:Version|Mobile)\/1[456]/;f()&&(navigator.appVersion.match(t)||navigator.userAgent.match(t))&&this.oi.enterRestrictedMode(!0),this.oi.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ci))}Ni(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Mi(t){var e;try{const n=null!==(null===(e=this.di)||void 0===e?void 0:e.getItem(this.Fi(t)));return jr("IndexedDbPersistence",`Client '${t}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(t){return Kr("IndexedDbPersistence","Failed to get zombied client id.",t),!1}}xi(){if(this.di)try{this.di.setItem(this.Fi(this.clientId),String(Date.now()))}catch(t){Kr("Failed to set zombie client id.",t)}}Bi(){if(this.di)try{this.di.removeItem(this.Fi(this.clientId))}catch(t){}}Fi(t){return`firestore_zombie_${this.persistenceKey}_${t}`}}function th(t){return xi(t,"owner")}function eh(t){return xi(t,"clientMetadata")}function nh(t,e){let n=t.projectId;return t.isDefaultDatabase||(n+="."+t.database),"firestore/"+e+"/"+n+"/"}class rh{constructor(t,e,n,r){this.targetId=t,this.fromCache=e,this.qi=n,this.Qi=r}static Ki(t,e){let n=Ca(),r=Ca();for(const t of e.docChanges)switch(t.type){case 0:n=n.add(t.doc.key);break;case 1:r=r.add(t.doc.key)}return new rh(t,e.fromCache,n,r)}}class sh{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(t){this._documentReadCount+=t}}class ih{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=f()?8:Vs.v(d())>0?6:4}initialize(t,e){this.zi=t,this.indexManager=e,this.$i=!0}getDocumentsMatchingQuery(t,e,n,r){const s={result:null};return this.ji(t,e).next((t=>{s.result=t})).next((()=>{if(!s.result)return this.Hi(t,e,r,n).next((t=>{s.result=t}))})).next((()=>{if(s.result)return;const n=new sh;return this.Ji(t,e,n).next((r=>{if(s.result=r,this.Ui)return this.Yi(t,e,n,r.size)}))})).next((()=>s.result))}Yi(t,e,n,r){return n.documentReadCount<this.Wi?(zr()<=_.DEBUG&&jr("QueryEngine","SDK will not create cache indexes for query:",ha(e),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),Ps.resolve()):(zr()<=_.DEBUG&&jr("QueryEngine","Query:",ha(e),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Gi*r?(zr()<=_.DEBUG&&jr("QueryEngine","The SDK decides to create cache indexes for query:",ha(e),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(t,ia(e))):Ps.resolve())}ji(t,e){if(na(e))return Ps.resolve(null);let n=ia(e);return this.indexManager.getIndexType(t,n).next((r=>0===r?null:(null!==e.limit&&1===r&&(e=ua(e,null,"F"),n=ia(e)),this.indexManager.getDocumentsMatchingTarget(t,n).next((r=>{const s=Ca(...r);return this.zi.getDocuments(t,s).next((r=>this.indexManager.getMinOffset(t,n).next((n=>{const i=this.Zi(e,r);return this.Xi(e,i,s,n.readTime)?this.ji(t,ua(e,null,"F")):this.es(t,i,e,n)}))))})))))}Hi(t,e,n,r){return na(e)||r.isEqual(ps.min())?Ps.resolve(null):this.zi.getDocuments(t,n).next((s=>{const i=this.Zi(e,s);return this.Xi(e,i,n,r)?Ps.resolve(null):(zr()<=_.DEBUG&&jr("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),ha(e)),this.es(t,i,e,As(r,-1)).next((t=>t)))}))}Zi(t,e){let n=new Mi(ga(t));return e.forEach(((e,r)=>{da(t,r)&&(n=n.add(r))})),n}Xi(t,e,n,r){if(null===t.limit)return!1;if(n.size!==e.size)return!0;const s="F"===t.limitType?e.last():e.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Ji(t,e,n){return zr()<=_.DEBUG&&jr("QueryEngine","Using full collection scan to execute query:",ha(e)),this.zi.getDocumentsMatchingQuery(t,e,ks.min(),n)}es(t,e,n,r){return this.zi.getDocumentsMatchingQuery(t,n,r).next((t=>(e.forEach((e=>{t=t.insert(e.key,e)})),t)))}}class oh{constructor(t,e,n,r){this.persistence=t,this.ts=e,this.serializer=r,this.ns=new Ni(ds),this.rs=new pa((t=>Qo(t)),Ho),this.ss=new Map,this.os=t.getRemoteDocumentCache(),this.Qr=t.getTargetCache(),this.$r=t.getBundleCache(),this._s(n)}_s(t){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(t),this.indexManager=this.persistence.getIndexManager(t),this.mutationQueue=this.persistence.getMutationQueue(t,this.indexManager),this.localDocuments=new Fl(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(e=>t.collect(e,this.ns)))}}function ah(t,e,n,r){return new oh(t,e,n,r)}async function uh(t,e){const n=Xr(t);return await n.persistence.runTransaction("Handle user change","readonly",(t=>{let r;return n.mutationQueue.getAllMutationBatches(t).next((s=>(r=s,n._s(e),n.mutationQueue.getAllMutationBatches(t)))).next((e=>{const s=[],i=[];let o=Ca();for(const t of r){s.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}for(const t of e){i.push(t.batchId);for(const e of t.mutations)o=o.add(e.key)}return n.localDocuments.getDocuments(t,o).next((t=>({us:t,removedBatchIds:s,addedBatchIds:i})))}))}))}function ch(t){const e=Xr(t);return e.persistence.runTransaction("Get last remote snapshot version","readonly",(t=>e.Qr.getLastRemoteSnapshotVersion(t)))}function lh(t,e,n){let r=Ca(),s=Ca();return n.forEach((t=>r=r.add(t))),e.getEntries(t,r).next((t=>{let r=wa();return n.forEach(((n,i)=>{const o=t.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(ps.min())?(e.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(e.addEntry(i),r=r.insert(n,i)):jr("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{cs:r,ls:s}}))}function hh(t,e){const n=Xr(t);return n.persistence.runTransaction("Get next mutation batch","readonly",(t=>(void 0===e&&(e=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(t,e))))}function dh(t,e){const n=Xr(t);return n.persistence.runTransaction("Allocate target","readwrite",(t=>{let r;return n.Qr.getTargetData(t,e).next((s=>s?(r=s,Ps.resolve(r)):n.Qr.allocateTargetId(t).next((s=>(r=new fc(e,s,"TargetPurposeListen",t.currentSequenceNumber),n.Qr.addTargetData(t,r).next((()=>r)))))))})).then((t=>{const r=n.ns.get(t.targetId);return(null===r||t.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.ns=n.ns.insert(t.targetId,t),n.rs.set(e,t.targetId)),t}))}async function fh(t,e,n){const r=Xr(t),s=r.ns.get(e),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(t=>r.persistence.referenceDelegate.removeTarget(t,s)))}catch(t){if(!Us(t))throw t;jr("LocalStore",`Failed to update sequence numbers for target ${e}: ${t}`)}r.ns=r.ns.remove(e),r.rs.delete(s.target)}function gh(t,e,n){const r=Xr(t);let s=ps.min(),i=Ca();return r.persistence.runTransaction("Execute query","readwrite",(t=>function(t,e,n){const r=Xr(t),s=r.rs.get(n);return void 0!==s?Ps.resolve(r.ns.get(s)):r.Qr.getTargetData(e,n)}(r,t,ia(e)).next((e=>{if(e)return s=e.lastLimboFreeSnapshotVersion,r.Qr.getMatchingKeysForTargetId(t,e.targetId).next((t=>{i=t}))})).next((()=>r.ts.getDocumentsMatchingQuery(t,e,n?s:ps.min(),n?i:Ca()))).next((t=>(yh(r,fa(e),t),{documents:t,hs:i})))))}function mh(t,e){const n=Xr(t),r=Xr(n.Qr),s=n.ns.get(e);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(t=>r._t(t,e).next((t=>t?t.target:null))))}function ph(t,e){const n=Xr(t),r=n.ss.get(e)||ps.min();return n.persistence.runTransaction("Get new document changes","readonly",(t=>n.os.getAllFromCollectionGroup(t,e,As(r,-1),Number.MAX_SAFE_INTEGER))).then((t=>(yh(n,e,t),t)))}function yh(t,e,n){let r=t.ss.get(e)||ps.min();n.forEach(((t,e)=>{e.readTime.compareTo(r)>0&&(r=e.readTime)})),t.ss.set(e,r)}async function wh(t,e,n=Ca()){const r=await dh(t,ia(Ic(e.bundledQuery))),s=Xr(t);return s.persistence.runTransaction("Save named query","readwrite",(t=>{const i=Uu(e.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.$r.saveNamedQuery(t,e);const o=r.withResumeToken(qi.EMPTY_BYTE_STRING,i);return s.ns=s.ns.insert(o.targetId,o),s.Qr.updateTargetData(t,o).next((()=>s.Qr.removeMatchingKeysForTargetId(t,r.targetId))).next((()=>s.Qr.addMatchingKeys(t,n,r.targetId))).next((()=>s.$r.saveNamedQuery(t,e)))}))}function vh(t,e){return`firestore_clients_${t}_${e}`}function bh(t,e,n){let r=`firestore_mutations_${t}_${n}`;return e.isAuthenticated()&&(r+=`_${e.uid}`),r}function _h(t,e){return`firestore_targets_${t}_${e}`}class Ih{constructor(t,e,n,r){this.user=t,this.batchId=e,this.state=n,this.error=r}static Es(t,e,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new Zr(r.error.code,r.error.message))),i?new Ih(t,e,r.state,s):(Kr("SharedClientState",`Failed to parse mutation state for ID '${e}': ${n}`),null)}ds(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Eh{constructor(t,e,n){this.targetId=t,this.state=e,this.error=n}static Es(t,e){const n=JSON.parse(e);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new Zr(n.error.code,n.error.message))),s?new Eh(t,n.state,r):(Kr("SharedClientState",`Failed to parse target state for ID '${t}': ${e}`),null)}ds(){const t={state:this.state,updateTimeMs:Date.now()};return this.error&&(t.error={code:this.error.code,message:this.error.message}),JSON.stringify(t)}}class Th{constructor(t,e){this.clientId=t,this.activeTargetIds=e}static Es(t,e){const n=JSON.parse(e);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Aa();for(let t=0;r&&t<n.activeTargetIds.length;++t)r=Xs(n.activeTargetIds[t]),s=s.add(n.activeTargetIds[t]);return r?new Th(t,s):(Kr("SharedClientState",`Failed to parse client data for instance '${t}': ${e}`),null)}}class Sh{constructor(t,e){this.clientId=t,this.onlineState=e}static Es(t){const e=JSON.parse(t);return"object"==typeof e&&-1!==["Unknown","Online","Offline"].indexOf(e.onlineState)&&"string"==typeof e.clientId?new Sh(e.clientId,e.onlineState):(Kr("SharedClientState",`Failed to parse online state: ${t}`),null)}}class xh{constructor(){this.activeTargetIds=Aa()}As(t){this.activeTargetIds=this.activeTargetIds.add(t)}Rs(t){this.activeTargetIds=this.activeTargetIds.delete(t)}ds(){const t={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(t)}}class Ch{constructor(t,e,n,r,s){this.window=t,this.oi=e,this.persistenceKey=n,this.Vs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.fs=this.gs.bind(this),this.ps=new Ni(ds),this.started=!1,this.ys=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ws=vh(this.persistenceKey,this.Vs),this.Ss=function(t){return`firestore_sequence_number_${t}`}(this.persistenceKey),this.ps=this.ps.insert(this.Vs,new xh),this.bs=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Ds=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Cs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.vs=function(t){return`firestore_online_state_${t}`}(this.persistenceKey),this.Fs=function(t){return`firestore_bundle_loaded_v2_${t}`}(this.persistenceKey),this.window.addEventListener("storage",this.fs)}static D(t){return!(!t||!t.localStorage)}async start(){const t=await this.syncEngine.Li();for(const e of t){if(e===this.Vs)continue;const t=this.getItem(vh(this.persistenceKey,e));if(t){const n=Th.Es(e,t);n&&(this.ps=this.ps.insert(n.clientId,n))}}this.Ms();const e=this.storage.getItem(this.vs);if(e){const t=this.xs(e);t&&this.Os(t)}for(const t of this.ys)this.gs(t);this.ys=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(t){this.setItem(this.Ss,JSON.stringify(t))}getAllActiveQueryTargets(){return this.Ns(this.ps)}isActiveQueryTarget(t){let e=!1;return this.ps.forEach(((n,r)=>{r.activeTargetIds.has(t)&&(e=!0)})),e}addPendingMutation(t){this.Bs(t,"pending")}updateMutationState(t,e,n){this.Bs(t,e,n),this.Ls(t)}addLocalQueryTarget(t){let e="not-current";if(this.isActiveQueryTarget(t)){const n=this.storage.getItem(_h(this.persistenceKey,t));if(n){const r=Eh.Es(t,n);r&&(e=r.state)}}return this.ks.As(t),this.Ms(),e}removeLocalQueryTarget(t){this.ks.Rs(t),this.Ms()}isLocalQueryTarget(t){return this.ks.activeTargetIds.has(t)}clearQueryState(t){this.removeItem(_h(this.persistenceKey,t))}updateQueryState(t,e,n){this.qs(t,e,n)}handleUserChange(t,e,n){e.forEach((t=>{this.Ls(t)})),this.currentUser=t,n.forEach((t=>{this.addPendingMutation(t)}))}setOnlineState(t){this.Qs(t)}notifyBundleLoaded(t){this.Ks(t)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.fs),this.removeItem(this.ws),this.started=!1)}getItem(t){const e=this.storage.getItem(t);return jr("SharedClientState","READ",t,e),e}setItem(t,e){jr("SharedClientState","SET",t,e),this.storage.setItem(t,e)}removeItem(t){jr("SharedClientState","REMOVE",t),this.storage.removeItem(t)}gs(t){const e=t;if(e.storageArea===this.storage){if(jr("SharedClientState","EVENT",e.key,e.newValue),e.key===this.ws)return void Kr("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.oi.enqueueRetryable((async()=>{if(this.started){if(null!==e.key)if(this.bs.test(e.key)){if(null==e.newValue){const t=this.$s(e.key);return this.Us(t,null)}{const t=this.Ws(e.key,e.newValue);if(t)return this.Us(t.clientId,t)}}else if(this.Ds.test(e.key)){if(null!==e.newValue){const t=this.Gs(e.key,e.newValue);if(t)return this.zs(t)}}else if(this.Cs.test(e.key)){if(null!==e.newValue){const t=this.js(e.key,e.newValue);if(t)return this.Hs(t)}}else if(e.key===this.vs){if(null!==e.newValue){const t=this.xs(e.newValue);if(t)return this.Os(t)}}else if(e.key===this.Ss){const t=function(t){let e=Hs._e;if(null!=t)try{const n=JSON.parse(t);Wr("number"==typeof n),e=n}catch(t){Kr("SharedClientState","Failed to read sequence number from WebStorage",t)}return e}(e.newValue);t!==Hs._e&&this.sequenceNumberHandler(t)}else if(e.key===this.Fs){const t=this.Js(e.newValue);await Promise.all(t.map((t=>this.syncEngine.Ys(t))))}}else this.ys.push(e)}))}}get ks(){return this.ps.get(this.Vs)}Ms(){this.setItem(this.ws,this.ks.ds())}Bs(t,e,n){const r=new Ih(this.currentUser,t,e,n),s=bh(this.persistenceKey,this.currentUser,t);this.setItem(s,r.ds())}Ls(t){const e=bh(this.persistenceKey,this.currentUser,t);this.removeItem(e)}Qs(t){const e={clientId:this.Vs,onlineState:t};this.storage.setItem(this.vs,JSON.stringify(e))}qs(t,e,n){const r=_h(this.persistenceKey,t),s=new Eh(t,e,n);this.setItem(r,s.ds())}Ks(t){const e=JSON.stringify(Array.from(t));this.setItem(this.Fs,e)}$s(t){const e=this.bs.exec(t);return e?e[1]:null}Ws(t,e){const n=this.$s(t);return Th.Es(n,e)}Gs(t,e){const n=this.Ds.exec(t),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return Ih.Es(new qr(s),r,e)}js(t,e){const n=this.Cs.exec(t),r=Number(n[1]);return Eh.Es(r,e)}xs(t){return Sh.Es(t)}Js(t){return JSON.parse(t)}async zs(t){if(t.user.uid===this.currentUser.uid)return this.syncEngine.Zs(t.batchId,t.state,t.error);jr("SharedClientState",`Ignoring mutation for non-active user ${t.user.uid}`)}Hs(t){return this.syncEngine.Xs(t.targetId,t.state,t.error)}Us(t,e){const n=e?this.ps.insert(t,e):this.ps.remove(t),r=this.Ns(this.ps),s=this.Ns(n),i=[],o=[];return s.forEach((t=>{r.has(t)||i.push(t)})),r.forEach((t=>{s.has(t)||o.push(t)})),this.syncEngine.eo(i,o).then((()=>{this.ps=n}))}Os(t){this.ps.get(t.clientId)&&this.onlineStateHandler(t.onlineState)}Ns(t){let e=Aa();return t.forEach(((t,n)=>{e=e.unionWith(n.activeTargetIds)})),e}}class Dh{constructor(){this.no=new xh,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(t){}updateMutationState(t,e,n){}addLocalQueryTarget(t){return this.no.As(t),this.ro[t]||"not-current"}updateQueryState(t,e,n){this.ro[t]=e}removeLocalQueryTarget(t){this.no.Rs(t)}isLocalQueryTarget(t){return this.no.activeTargetIds.has(t)}clearQueryState(t){delete this.ro[t]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(t){return this.no.activeTargetIds.has(t)}start(){return this.no=new xh,Promise.resolve()}handleUserChange(t,e,n){}setOnlineState(t){}shutdown(){}writeSequenceNumber(t){}notifyBundleLoaded(t){}}class Ah{io(t){}shutdown(){}}class Nh{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(t){this.uo.push(t)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){jr("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const t of this.uo)t(0)}ao(){jr("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const t of this.uo)t(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let kh=null;function Rh(){return null===kh?kh=268435456+Math.round(2147483648*Math.random()):kh++,"0x"+kh.toString(16)}const Mh={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class Lh{constructor(t){this.lo=t.lo,this.ho=t.ho}Po(t){this.Io=t}To(t){this.Eo=t}onMessage(t){this.Ao=t}close(){this.ho()}send(t){this.lo(t)}Ro(){this.Io()}Vo(t){this.Eo(t)}mo(t){this.Ao(t)}}const Oh="WebChannelConnection";class Ph extends class{constructor(t){this.databaseInfo=t,this.databaseId=t.databaseId;const e=t.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.fo=e+"://"+t.host,this.po=`projects/${n}/databases/${r}`,this.yo="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get wo(){return!1}So(t,e,n,r,s){const i=Rh(),o=this.bo(t,e.toUriEncodedString());jr("RestConnection",`Sending RPC '${t}' ${i}:`,o,n);const a={"google-cloud-resource-prefix":this.po,"x-goog-request-params":this.yo};return this.Do(a,r,s),this.Co(t,o,a,n).then((e=>(jr("RestConnection",`Received RPC '${t}' ${i}: `,e),e)),(e=>{throw $r("RestConnection",`RPC '${t}' ${i} failed with error: `,e,"url: ",o,"request:",n),e}))}vo(t,e,n,r,s,i){return this.So(t,e,n,r,s)}Do(t,e,n){t["X-Goog-Api-Client"]="gl-js/ fire/"+Br,t["Content-Type"]="text/plain",this.databaseInfo.appId&&(t["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach(((e,n)=>t[n]=e)),n&&n.headers.forEach(((e,n)=>t[n]=e))}bo(t,e){const n=Mh[t];return`${this.fo}/v1/${e}:${n}`}terminate(){}}{constructor(t){super(t),this.forceLongPolling=t.forceLongPolling,this.autoDetectLongPolling=t.autoDetectLongPolling,this.useFetchStreams=t.useFetchStreams,this.longPollingOptions=t.longPollingOptions}Co(t,e,n,r){const s=Rh();return new Promise(((i,o)=>{const a=new Or;a.setWithCredentials(!0),a.listenOnce(Rr.COMPLETE,(()=>{try{switch(a.getLastErrorCode()){case kr.NO_ERROR:const e=a.getResponseJson();jr(Oh,`XHR for RPC '${t}' ${s} received:`,JSON.stringify(e)),i(e);break;case kr.TIMEOUT:jr(Oh,`RPC '${t}' ${s} timed out`),o(new Zr(Jr.DEADLINE_EXCEEDED,"Request time out"));break;case kr.HTTP_ERROR:const n=a.getStatus();if(jr(Oh,`RPC '${t}' ${s} failed with status:`,n,"response text:",a.getResponseText()),n>0){let t=a.getResponseJson();Array.isArray(t)&&(t=t[0]);const e=null==t?void 0:t.error;if(e&&e.status&&e.message){const t=function(t){const e=t.toLowerCase().replace(/_/g,"-");return Object.values(Jr).indexOf(e)>=0?e:Jr.UNKNOWN}(e.status);o(new Zr(t,e.message))}else o(new Zr(Jr.UNKNOWN,"Server responded with status "+a.getStatus()))}else o(new Zr(Jr.UNAVAILABLE,"Connection failed."));break;default:Hr()}}finally{jr(Oh,`RPC '${t}' ${s} completed.`)}}));const u=JSON.stringify(r);jr(Oh,`RPC '${t}' ${s} sending request:`,r),a.send(e,"POST",u,n,15)}))}Fo(t,e,n){const r=Rh(),s=[this.fo,"/","google.firestore.v1.Firestore","/",t,"/channel"],i=new ar,o=oe(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(a.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(a.useFetchStreams=!0),this.Do(a.initMessageHeaders,e,n),a.encodeInitMessageHeaders=!0;const c=s.join("");jr(Oh,`Creating RPC '${t}' stream ${r}: ${c}`,a);const l=i.createWebChannel(c,a);let h=!1,d=!1;const f=new Lh({lo:e=>{d?jr(Oh,`Not sending because RPC '${t}' stream ${r} is closed:`,e):(h||(jr(Oh,`Opening RPC '${t}' stream ${r} transport.`),l.open(),h=!0),jr(Oh,`RPC '${t}' stream ${r} sending:`,e),l.send(e))},ho:()=>l.close()}),g=(t,e,n)=>{t.listen(e,(t=>{try{n(t)}catch(t){setTimeout((()=>{throw t}),0)}}))};return g(l,Lr.EventType.OPEN,(()=>{d||jr(Oh,`RPC '${t}' stream ${r} transport opened.`)})),g(l,Lr.EventType.CLOSE,(()=>{d||(d=!0,jr(Oh,`RPC '${t}' stream ${r} transport closed`),f.Vo())})),g(l,Lr.EventType.ERROR,(e=>{d||(d=!0,$r(Oh,`RPC '${t}' stream ${r} transport errored:`,e),f.Vo(new Zr(Jr.UNAVAILABLE,"The operation could not be completed")))})),g(l,Lr.EventType.MESSAGE,(e=>{var n;if(!d){const s=e.data[0];Wr(!!s);const i=s,o=i.error||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){jr(Oh,`RPC '${t}' stream ${r} received error:`,o);const e=o.status;let n=function(t){const e=fu[t];if(void 0!==e)return pu(e)}(e),s=o.message;void 0===n&&(n=Jr.INTERNAL,s="Unknown error status: "+e+" with message "+o.message),d=!0,f.Vo(new Zr(n,s)),l.close()}else jr(Oh,`RPC '${t}' stream ${r} received:`,s),f.mo(s)}})),g(o,Mr.STAT_EVENT,(e=>{10===e.stat?jr(Oh,`RPC '${t}' stream ${r} detected buffering proxy`):11===e.stat&&jr(Oh,`RPC '${t}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{f.Ro()}),0),f}}function Fh(){return"undefined"!=typeof window?window:null}function Vh(){return"undefined"!=typeof document?document:null}function qh(t){return new Pu(t,!0)}class Bh{constructor(t,e,n=1e3,r=1.5,s=6e4){this.oi=t,this.timerId=e,this.Mo=n,this.xo=r,this.Oo=s,this.No=0,this.Bo=null,this.Lo=Date.now(),this.reset()}reset(){this.No=0}ko(){this.No=this.Oo}qo(t){this.cancel();const e=Math.floor(this.No+this.Qo()),n=Math.max(0,Date.now()-this.Lo),r=Math.max(0,e-n);r>0&&jr("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.No} ms, delay with jitter: ${e} ms, last attempt: ${n} ms ago)`),this.Bo=this.oi.enqueueAfterDelay(this.timerId,r,(()=>(this.Lo=Date.now(),t()))),this.No*=this.xo,this.No<this.Mo&&(this.No=this.Mo),this.No>this.Oo&&(this.No=this.Oo)}Ko(){null!==this.Bo&&(this.Bo.skipDelay(),this.Bo=null)}cancel(){null!==this.Bo&&(this.Bo.cancel(),this.Bo=null)}Qo(){return(Math.random()-.5)*this.No}}class Uh{constructor(t,e,n,r,s,i,o,a){this.oi=t,this.$o=n,this.Uo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Wo=0,this.Go=null,this.zo=null,this.stream=null,this.jo=new Bh(t,e)}Ho(){return 1===this.state||5===this.state||this.Jo()}Jo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Yo()}async stop(){this.Ho()&&await this.close(0)}Zo(){this.state=0,this.jo.reset()}Xo(){this.Jo()&&null===this.Go&&(this.Go=this.oi.enqueueAfterDelay(this.$o,6e4,(()=>this.e_())))}t_(t){this.n_(),this.stream.send(t)}async e_(){if(this.Jo())return this.close(0)}n_(){this.Go&&(this.Go.cancel(),this.Go=null)}r_(){this.zo&&(this.zo.cancel(),this.zo=null)}async close(t,e){this.n_(),this.r_(),this.jo.cancel(),this.Wo++,4!==t?this.jo.reset():e&&e.code===Jr.RESOURCE_EXHAUSTED?(Kr(e.toString()),Kr("Using maximum backoff delay to prevent overloading the backend."),this.jo.ko()):e&&e.code===Jr.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.i_(),this.stream.close(),this.stream=null),this.state=t,await this.listener.To(e)}i_(){}auth(){this.state=1;const t=this.s_(this.Wo),e=this.Wo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([t,n])=>{this.Wo===e&&this.o_(t,n)}),(e=>{t((()=>{const t=new Zr(Jr.UNKNOWN,"Fetching auth token failed: "+e.message);return this.__(t)}))}))}o_(t,e){const n=this.s_(this.Wo);this.stream=this.a_(t,e),this.stream.Po((()=>{n((()=>(this.state=2,this.zo=this.oi.enqueueAfterDelay(this.Uo,1e4,(()=>(this.Jo()&&(this.state=3),Promise.resolve()))),this.listener.Po())))})),this.stream.To((t=>{n((()=>this.__(t)))})),this.stream.onMessage((t=>{n((()=>this.onMessage(t)))}))}Yo(){this.state=5,this.jo.qo((async()=>{this.state=0,this.start()}))}__(t){return jr("PersistentStream",`close with error: ${t}`),this.stream=null,this.close(4,t)}s_(t){return e=>{this.oi.enqueueAndForget((()=>this.Wo===t?e():(jr("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class zh extends Uh{constructor(t,e,n,r,s,i){super(t,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",e,n,r,i),this.serializer=s}a_(t,e){return this.connection.Fo("Listen",t,e)}onMessage(t){this.jo.reset();const e=function(t,e){let n;if("targetChange"in e){e.targetChange;const r=function(t){return"NO_CHANGE"===t?0:"ADD"===t?1:"REMOVE"===t?2:"CURRENT"===t?3:"RESET"===t?4:Hr()}(e.targetChange.targetChangeType||"NO_CHANGE"),s=e.targetChange.targetIds||[],i=function(t,e){return t.useProto3Json?(Wr(void 0===e||"string"==typeof e),qi.fromBase64String(e||"")):(Wr(void 0===e||e instanceof Uint8Array),qi.fromUint8Array(e||new Uint8Array))}(t,e.targetChange.resumeToken),o=e.targetChange.cause,a=o&&function(t){const e=void 0===t.code?Jr.UNKNOWN:pu(t.code);return new Zr(e,t.message||"")}(o);n=new Du(r,s,i,a||null)}else if("documentChange"in e){e.documentChange;const r=e.documentChange;r.document,r.document.name,r.document.updateTime;const s=$u(t,r.document.name),i=Uu(r.document.updateTime),o=r.document.createTime?Uu(r.document.createTime):ps.min(),a=new wo({mapValue:{fields:r.document.fields}}),u=bo.newFoundDocument(s,i,o,a),c=r.targetIds||[],l=r.removedTargetIds||[];n=new xu(c,l,u.key,u)}else if("documentDelete"in e){e.documentDelete;const r=e.documentDelete;r.document;const s=$u(t,r.document),i=r.readTime?Uu(r.readTime):ps.min(),o=bo.newNoDocument(s,i),a=r.removedTargetIds||[];n=new xu([],a,o.key,o)}else if("documentRemove"in e){e.documentRemove;const r=e.documentRemove;r.document;const s=$u(t,r.document),i=r.removedTargetIds||[];n=new xu([],i,s,null)}else{if(!("filter"in e))return Hr();{e.filter;const t=e.filter;t.targetId;const{count:r=0,unchangedNames:s}=t,i=new du(r,s),o=t.targetId;n=new Cu(o,i)}}return n}(this.serializer,t),n=function(t){if(!("targetChange"in t))return ps.min();const e=t.targetChange;return e.targetIds&&e.targetIds.length?ps.min():e.readTime?Uu(e.readTime):ps.min()}(t);return this.listener.u_(e,n)}c_(t){const e={};e.database=Wu(this.serializer),e.addTarget=function(t,e){let n;const r=e.target;if(n=Wo(r)?{documents:ec(t,r)}:{query:nc(t,r).ut},n.targetId=e.targetId,e.resumeToken.approximateByteSize()>0){n.resumeToken=qu(t,e.resumeToken);const r=Fu(t,e.expectedCount);null!==r&&(n.expectedCount=r)}else if(e.snapshotVersion.compareTo(ps.min())>0){n.readTime=Vu(t,e.snapshotVersion.toTimestamp());const r=Fu(t,e.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,t);const n=function(t,e){const n=function(t){switch(t){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return Hr()}}(e.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,t);n&&(e.labels=n),this.t_(e)}l_(t){const e={};e.database=Wu(this.serializer),e.removeTarget=t,this.t_(e)}}class Gh extends Uh{constructor(t,e,n,r,s,i){super(t,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",e,n,r,i),this.serializer=s,this.h_=!1}get P_(){return this.h_}start(){this.h_=!1,this.lastStreamToken=void 0,super.start()}i_(){this.h_&&this.I_([])}a_(t,e){return this.connection.Fo("Write",t,e)}onMessage(t){if(Wr(!!t.streamToken),this.lastStreamToken=t.streamToken,this.h_){this.jo.reset();const e=function(t,e){return t&&t.length>0?(Wr(void 0!==e),t.map((t=>function(t,e){let n=t.updateTime?Uu(t.updateTime):Uu(e);return n.isEqual(ps.min())&&(n=Uu(e)),new $a(n,t.transformResults||[])}(t,e)))):[]}(t.writeResults,t.commitTime),n=Uu(t.commitTime);return this.listener.T_(n,e)}return Wr(!t.writeResults||0===t.writeResults.length),this.h_=!0,this.listener.E_()}d_(){const t={};t.database=Wu(this.serializer),this.t_(t)}I_(t){const e={streamToken:this.lastStreamToken,writes:t.map((t=>Zu(this.serializer,t)))};this.t_(e)}}class jh extends class{}{constructor(t,e,n,r){super(),this.authCredentials=t,this.appCheckCredentials=e,this.connection=n,this.serializer=r,this.A_=!1}R_(){if(this.A_)throw new Zr(Jr.FAILED_PRECONDITION,"The client has already been terminated.")}So(t,e,n,r){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection.So(t,Gu(e,n),r,s,i))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Jr.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Zr(Jr.UNKNOWN,t.toString())}))}vo(t,e,n,r,s){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,o])=>this.connection.vo(t,Gu(e,n),r,i,o,s))).catch((t=>{throw"FirebaseError"===t.name?(t.code===Jr.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),t):new Zr(Jr.UNKNOWN,t.toString())}))}terminate(){this.A_=!0,this.connection.terminate()}}class Kh{constructor(t,e){this.asyncQueue=t,this.onlineStateHandler=e,this.state="Unknown",this.m_=0,this.f_=null,this.g_=!0}p_(){0===this.m_&&(this.y_("Unknown"),this.f_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.f_=null,this.w_("Backend didn't respond within 10 seconds."),this.y_("Offline"),Promise.resolve()))))}S_(t){"Online"===this.state?this.y_("Unknown"):(this.m_++,this.m_>=1&&(this.b_(),this.w_(`Connection failed 1 times. Most recent error: ${t.toString()}`),this.y_("Offline")))}set(t){this.b_(),this.m_=0,"Online"===t&&(this.g_=!1),this.y_(t)}y_(t){t!==this.state&&(this.state=t,this.onlineStateHandler(t))}w_(t){const e=`Could not reach Cloud Firestore backend. ${t}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.g_?(Kr(e),this.g_=!1):jr("OnlineStateTracker",e)}b_(){null!==this.f_&&(this.f_.cancel(),this.f_=null)}}class $h{constructor(t,e,n,r,s){this.localStore=t,this.datastore=e,this.asyncQueue=n,this.remoteSyncer={},this.D_=[],this.C_=new Map,this.v_=new Set,this.F_=[],this.M_=s,this.M_.io((t=>{n.enqueueAndForget((async()=>{ed(this)&&(jr("RemoteStore","Restarting streams for network reachability change."),await async function(t){const e=Xr(t);e.v_.add(4),await Hh(e),e.x_.set("Unknown"),e.v_.delete(4),await Qh(e)}(this))}))})),this.x_=new Kh(n,r)}}async function Qh(t){if(ed(t))for(const e of t.F_)await e(!0)}async function Hh(t){for(const e of t.F_)await e(!1)}function Wh(t,e){const n=Xr(t);n.C_.has(e.targetId)||(n.C_.set(e.targetId,e),td(n)?Zh(n):vd(n).Jo()&&Xh(n,e))}function Yh(t,e){const n=Xr(t),r=vd(n);n.C_.delete(e),r.Jo()&&Jh(n,e),0===n.C_.size&&(r.Jo()?r.Xo():ed(n)&&n.x_.set("Unknown"))}function Xh(t,e){if(t.O_.Oe(e.targetId),e.resumeToken.approximateByteSize()>0||e.snapshotVersion.compareTo(ps.min())>0){const n=t.remoteSyncer.getRemoteKeysForTarget(e.targetId).size;e=e.withExpectedCount(n)}vd(t).c_(e)}function Jh(t,e){t.O_.Oe(e),vd(t).l_(e)}function Zh(t){t.O_=new Nu({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),_t:e=>t.C_.get(e)||null,nt:()=>t.datastore.serializer.databaseId}),vd(t).start(),t.x_.p_()}function td(t){return ed(t)&&!vd(t).Ho()&&t.C_.size>0}function ed(t){return 0===Xr(t).v_.size}function nd(t){t.O_=void 0}async function rd(t){t.C_.forEach(((e,n)=>{Xh(t,e)}))}async function sd(t,e){nd(t),td(t)?(t.x_.S_(e),Zh(t)):t.x_.set("Unknown")}async function id(t,e,n){if(t.x_.set("Online"),e instanceof Du&&2===e.state&&e.cause)try{await async function(t,e){const n=e.cause;for(const r of e.targetIds)t.C_.has(r)&&(await t.remoteSyncer.rejectListen(r,n),t.C_.delete(r),t.O_.removeTarget(r))}(t,e)}catch(n){jr("RemoteStore","Failed to remove targets %s: %s ",e.targetIds.join(","),n),await od(t,n)}else if(e instanceof xu?t.O_.$e(e):e instanceof Cu?t.O_.Je(e):t.O_.Ge(e),!n.isEqual(ps.min()))try{const e=await ch(t.localStore);n.compareTo(e)>=0&&await function(t,e){const n=t.O_.it(e);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=t.C_.get(r);s&&t.C_.set(r,s.withResumeToken(n.resumeToken,e))}})),n.targetMismatches.forEach(((e,n)=>{const r=t.C_.get(e);if(!r)return;t.C_.set(e,r.withResumeToken(qi.EMPTY_BYTE_STRING,r.snapshotVersion)),Jh(t,e);const s=new fc(r.target,e,n,r.sequenceNumber);Xh(t,s)})),t.remoteSyncer.applyRemoteEvent(n)}(t,n)}catch(e){jr("RemoteStore","Failed to raise snapshot:",e),await od(t,e)}}async function od(t,e,n){if(!Us(e))throw e;t.v_.add(1),await Hh(t),t.x_.set("Offline"),n||(n=()=>ch(t.localStore)),t.asyncQueue.enqueueRetryable((async()=>{jr("RemoteStore","Retrying IndexedDB access"),await n(),t.v_.delete(1),await Qh(t)}))}function ad(t,e){return e().catch((n=>od(t,n,e)))}async function ud(t){const e=Xr(t),n=bd(e);let r=e.D_.length>0?e.D_[e.D_.length-1].batchId:-1;for(;cd(e);)try{const t=await hh(e.localStore,r);if(null===t){0===e.D_.length&&n.Xo();break}r=t.batchId,ld(e,t)}catch(t){await od(e,t)}hd(e)&&dd(e)}function cd(t){return ed(t)&&t.D_.length<10}function ld(t,e){t.D_.push(e);const n=bd(t);n.Jo()&&n.P_&&n.I_(e.mutations)}function hd(t){return ed(t)&&!bd(t).Ho()&&t.D_.length>0}function dd(t){bd(t).start()}async function fd(t){bd(t).d_()}async function gd(t){const e=bd(t);for(const n of t.D_)e.I_(n.mutations)}async function md(t,e,n){const r=t.D_.shift(),s=cu.from(r,e,n);await ad(t,(()=>t.remoteSyncer.applySuccessfulWrite(s))),await ud(t)}async function pd(t,e){e&&bd(t).P_&&await async function(t,e){if(function(t){return mu(t)&&t!==Jr.ABORTED}(e.code)){const n=t.D_.shift();bd(t).Zo(),await ad(t,(()=>t.remoteSyncer.rejectFailedWrite(n.batchId,e))),await ud(t)}}(t,e),hd(t)&&dd(t)}async function yd(t,e){const n=Xr(t);n.asyncQueue.verifyOperationInProgress(),jr("RemoteStore","RemoteStore received new credentials");const r=ed(n);n.v_.add(3),await Hh(n),r&&n.x_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(e),n.v_.delete(3),await Qh(n)}async function wd(t,e){const n=Xr(t);e?(n.v_.delete(2),await Qh(n)):e||(n.v_.add(2),await Hh(n),n.x_.set("Unknown"))}function vd(t){return t.N_||(t.N_=function(t,e,n){const r=Xr(t);return r.R_(),new zh(e,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Po:rd.bind(null,t),To:sd.bind(null,t),u_:id.bind(null,t)}),t.F_.push((async e=>{e?(t.N_.Zo(),td(t)?Zh(t):t.x_.set("Unknown")):(await t.N_.stop(),nd(t))}))),t.N_}function bd(t){return t.B_||(t.B_=function(t,e,n){const r=Xr(t);return r.R_(),new Gh(e,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(t.datastore,t.asyncQueue,{Po:fd.bind(null,t),To:pd.bind(null,t),E_:gd.bind(null,t),T_:md.bind(null,t)}),t.F_.push((async e=>{e?(t.B_.Zo(),await ud(t)):(await t.B_.stop(),t.D_.length>0&&(jr("RemoteStore",`Stopping write stream with ${t.D_.length} pending writes`),t.D_=[]))}))),t.B_}class _d{constructor(t,e,n,r,s){this.asyncQueue=t,this.timerId=e,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new ts,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((t=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(t,e,n,r,s){const i=Date.now()+n,o=new _d(t,e,i,r,s);return o.start(n),o}start(t){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),t)}skipDelay(){return this.handleDelayElapsed()}cancel(t){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new Zr(Jr.CANCELLED,"Operation cancelled"+(t?": "+t:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((t=>this.deferred.resolve(t)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Id(t,e){if(Kr("AsyncQueue",`${e}: ${t}`),Us(t))return new Zr(Jr.UNAVAILABLE,`${e}: ${t}`);throw t}class Ed{constructor(t){this.comparator=t?(e,n)=>t(e,n)||_s.comparator(e.key,n.key):(t,e)=>_s.comparator(t.key,e.key),this.keyedMap=ba(),this.sortedSet=new Ni(this.comparator)}static emptySet(t){return new Ed(t.comparator)}has(t){return null!=this.keyedMap.get(t)}get(t){return this.keyedMap.get(t)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(t){const e=this.keyedMap.get(t);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(t){this.sortedSet.inorderTraversal(((e,n)=>(t(e),!1)))}add(t){const e=this.delete(t.key);return e.copy(e.keyedMap.insert(t.key,t),e.sortedSet.insert(t,null))}delete(t){const e=this.get(t);return e?this.copy(this.keyedMap.remove(t),this.sortedSet.remove(e)):this}isEqual(t){if(!(t instanceof Ed))return!1;if(this.size!==t.size)return!1;const e=this.sortedSet.getIterator(),n=t.sortedSet.getIterator();for(;e.hasNext();){const t=e.getNext().key,r=n.getNext().key;if(!t.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach((e=>{t.push(e.toString())})),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(t,e){const n=new Ed;return n.comparator=this.comparator,n.keyedMap=t,n.sortedSet=e,n}}class Td{constructor(){this.L_=new Ni(_s.comparator)}track(t){const e=t.doc.key,n=this.L_.get(e);n?0!==t.type&&3===n.type?this.L_=this.L_.insert(e,t):3===t.type&&1!==n.type?this.L_=this.L_.insert(e,{type:n.type,doc:t.doc}):2===t.type&&2===n.type?this.L_=this.L_.insert(e,{type:2,doc:t.doc}):2===t.type&&0===n.type?this.L_=this.L_.insert(e,{type:0,doc:t.doc}):1===t.type&&0===n.type?this.L_=this.L_.remove(e):1===t.type&&2===n.type?this.L_=this.L_.insert(e,{type:1,doc:n.doc}):0===t.type&&1===n.type?this.L_=this.L_.insert(e,{type:2,doc:t.doc}):Hr():this.L_=this.L_.insert(e,t)}k_(){const t=[];return this.L_.inorderTraversal(((e,n)=>{t.push(n)})),t}}class Sd{constructor(t,e,n,r,s,i,o,a,u){this.query=t,this.docs=e,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=u}static fromInitialDocuments(t,e,n,r,s){const i=[];return e.forEach((t=>{i.push({type:0,doc:t})})),new Sd(t,e,Ed.emptySet(e),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(t){if(!(this.fromCache===t.fromCache&&this.hasCachedResults===t.hasCachedResults&&this.syncStateChanged===t.syncStateChanged&&this.mutatedKeys.isEqual(t.mutatedKeys)&&ca(this.query,t.query)&&this.docs.isEqual(t.docs)&&this.oldDocs.isEqual(t.oldDocs)))return!1;const e=this.docChanges,n=t.docChanges;if(e.length!==n.length)return!1;for(let t=0;t<e.length;t++)if(e[t].type!==n[t].type||!e[t].doc.isEqual(n[t].doc))return!1;return!0}}class xd{constructor(){this.q_=void 0,this.Q_=[]}}class Cd{constructor(){this.queries=new pa((t=>la(t)),ca),this.onlineState="Unknown",this.K_=new Set}}async function Dd(t,e){const n=Xr(t),r=e.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new xd),s)try{i.q_=await n.onListen(r)}catch(t){const n=Id(t,`Initialization of query '${ha(e.query)}' failed`);return void e.onError(n)}n.queries.set(r,i),i.Q_.push(e),e.U_(n.onlineState),i.q_&&e.W_(i.q_)&&Rd(n)}async function Ad(t,e){const n=Xr(t),r=e.query;let s=!1;const i=n.queries.get(r);if(i){const t=i.Q_.indexOf(e);t>=0&&(i.Q_.splice(t,1),s=0===i.Q_.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Nd(t,e){const n=Xr(t);let r=!1;for(const t of e){const e=t.query,s=n.queries.get(e);if(s){for(const e of s.Q_)e.W_(t)&&(r=!0);s.q_=t}}r&&Rd(n)}function kd(t,e,n){const r=Xr(t),s=r.queries.get(e);if(s)for(const t of s.Q_)t.onError(n);r.queries.delete(e)}function Rd(t){t.K_.forEach((t=>{t.next()}))}class Md{constructor(t,e,n){this.query=t,this.G_=e,this.z_=!1,this.j_=null,this.onlineState="Unknown",this.options=n||{}}W_(t){if(!this.options.includeMetadataChanges){const e=[];for(const n of t.docChanges)3!==n.type&&e.push(n);t=new Sd(t.query,t.docs,t.oldDocs,e,t.mutatedKeys,t.fromCache,t.syncStateChanged,!0,t.hasCachedResults)}let e=!1;return this.z_?this.H_(t)&&(this.G_.next(t),e=!0):this.J_(t,this.onlineState)&&(this.Y_(t),e=!0),this.j_=t,e}onError(t){this.G_.error(t)}U_(t){this.onlineState=t;let e=!1;return this.j_&&!this.z_&&this.J_(this.j_,t)&&(this.Y_(this.j_),e=!0),e}J_(t,e){if(!t.fromCache)return!0;const n="Offline"!==e;return(!this.options.Z_||!n)&&(!t.docs.isEmpty()||t.hasCachedResults||"Offline"===e)}H_(t){if(t.docChanges.length>0)return!0;const e=this.j_&&this.j_.hasPendingWrites!==t.hasPendingWrites;return!(!t.syncStateChanged&&!e)&&!0===this.options.includeMetadataChanges}Y_(t){t=Sd.fromInitialDocuments(t.query,t.docs,t.mutatedKeys,t.fromCache,t.hasCachedResults),this.z_=!0,this.G_.next(t)}}class Ld{constructor(t,e){this.X_=t,this.byteLength=e}ea(){return"metadata"in this.X_}}class Od{constructor(t){this.serializer=t}Ps(t){return $u(this.serializer,t)}Is(t){return t.metadata.exists?Ju(this.serializer,t.document,!1):bo.newNoDocument(this.Ps(t.metadata.name),this.Ts(t.metadata.readTime))}Ts(t){return Uu(t)}}class Pd{constructor(t,e,n){this.ta=t,this.localStore=e,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Fd(t)}na(t){this.progress.bytesLoaded+=t.byteLength;let e=this.progress.documentsLoaded;if(t.X_.namedQuery)this.queries.push(t.X_.namedQuery);else if(t.X_.documentMetadata){this.documents.push({metadata:t.X_.documentMetadata}),t.X_.documentMetadata.exists||++e;const n=ws.fromString(t.X_.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else t.X_.document&&(this.documents[this.documents.length-1].document=t.X_.document,++e);return e!==this.progress.documentsLoaded?(this.progress.documentsLoaded=e,Object.assign({},this.progress)):null}ra(t){const e=new Map,n=new Od(this.serializer);for(const r of t)if(r.metadata.queries){const t=n.Ps(r.metadata.name);for(const n of r.metadata.queries){const r=(e.get(n)||Ca()).add(t);e.set(n,r)}}return e}async complete(){const t=await async function(t,e,n,r){const s=Xr(t);let i=Ca(),o=wa();for(const t of n){const n=e.Ps(t.metadata.name);t.document&&(i=i.add(n));const r=e.Is(t);r.setReadTime(e.Ts(t.metadata.readTime)),o=o.insert(n,r)}const a=s.os.newChangeBuffer({trackRemovals:!0}),u=await dh(s,function(t){return ia(ea(ws.fromString(`__bundle__/docs/${t}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(t=>lh(t,a,o).next((e=>(a.apply(t),e))).next((e=>s.Qr.removeMatchingKeysForTargetId(t,u.targetId).next((()=>s.Qr.addMatchingKeys(t,i,u.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(t,e.cs,e.ls))).next((()=>e.cs))))))}(this.localStore,new Od(this.serializer),this.documents,this.ta.id),e=this.ra(this.documents);for(const t of this.queries)await wh(this.localStore,t,e.get(t.name));return this.progress.taskState="Success",{progress:this.progress,ia:this.collectionGroups,sa:t}}}function Fd(t){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}class Vd{constructor(t){this.key=t}}class qd{constructor(t){this.key=t}}class Bd{constructor(t,e){this.query=t,this.oa=e,this._a=null,this.hasCachedResults=!1,this.current=!1,this.aa=Ca(),this.mutatedKeys=Ca(),this.ua=ga(t),this.ca=new Ed(this.ua)}get la(){return this.oa}ha(t,e){const n=e?e.Pa:new Td,r=e?e.ca:this.ca;let s=e?e.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(t.inorderTraversal(((t,e)=>{const c=r.get(t),l=da(this.query,e)?e:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;c&&l?c.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Ia(c,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.ua(l,a)>0||u&&this.ua(l,u)<0)&&(o=!0)):!c&&l?(n.track({type:0,doc:l}),f=!0):c&&!l&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(t):s.delete(t)):(i=i.delete(t),s=s.delete(t)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const t="F"===this.query.limitType?i.last():i.first();i=i.delete(t.key),s=s.delete(t.key),n.track({type:1,doc:t})}return{ca:i,Pa:n,Xi:o,mutatedKeys:s}}Ia(t,e){return t.hasLocalMutations&&e.hasCommittedMutations&&!e.hasLocalMutations}applyChanges(t,e,n,r){const s=this.ca;this.ca=t.ca,this.mutatedKeys=t.mutatedKeys;const i=t.Pa.k_();i.sort(((t,e)=>function(t,e){const n=t=>{switch(t){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return Hr()}};return n(t)-n(e)}(t.type,e.type)||this.ua(t.doc,e.doc))),this.Ta(n),r=null!=r&&r;const o=e&&!r?this.Ea():[],a=0===this.aa.size&&this.current&&!r?1:0,u=a!==this._a;return this._a=a,0!==i.length||u?{snapshot:new Sd(this.query,t.ca,s,i,t.mutatedKeys,0===a,u,!1,!!n&&n.resumeToken.approximateByteSize()>0),da:o}:{da:o}}U_(t){return this.current&&"Offline"===t?(this.current=!1,this.applyChanges({ca:this.ca,Pa:new Td,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{da:[]}}Aa(t){return!this.oa.has(t)&&!!this.ca.has(t)&&!this.ca.get(t).hasLocalMutations}Ta(t){t&&(t.addedDocuments.forEach((t=>this.oa=this.oa.add(t))),t.modifiedDocuments.forEach((t=>{})),t.removedDocuments.forEach((t=>this.oa=this.oa.delete(t))),this.current=t.current)}Ea(){if(!this.current)return[];const t=this.aa;this.aa=Ca(),this.ca.forEach((t=>{this.Aa(t.key)&&(this.aa=this.aa.add(t.key))}));const e=[];return t.forEach((t=>{this.aa.has(t)||e.push(new qd(t))})),this.aa.forEach((n=>{t.has(n)||e.push(new Vd(n))})),e}Ra(t){this.oa=t.hs,this.aa=Ca();const e=this.ha(t.documents);return this.applyChanges(e,!0)}Va(){return Sd.fromInitialDocuments(this.query,this.ca,this.mutatedKeys,0===this._a,this.hasCachedResults)}}class Ud{constructor(t,e,n){this.query=t,this.targetId=e,this.view=n}}class zd{constructor(t){this.key=t,this.ma=!1}}class Gd{constructor(t,e,n,r,s,i){this.localStore=t,this.remoteStore=e,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.fa={},this.ga=new pa((t=>la(t)),ca),this.pa=new Map,this.ya=new Set,this.wa=new Ni(_s.comparator),this.Sa=new Map,this.ba=new Bl,this.Da={},this.Ca=new Map,this.va=ml.Bn(),this.onlineState="Unknown",this.Fa=void 0}get isPrimaryClient(){return!0===this.Fa}}async function jd(t,e){const n=yf(t);let r,s;const i=n.ga.get(e);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Va();else{const t=await dh(n.localStore,ia(e)),i=n.sharedClientState.addLocalQueryTarget(t.targetId);r=t.targetId,s=await Kd(n,e,r,"current"===i,t.resumeToken),n.isPrimaryClient&&Wh(n.remoteStore,t)}return s}async function Kd(t,e,n,r,s){t.Ma=(e,n,r)=>async function(t,e,n,r){let s=e.view.ha(n);s.Xi&&(s=await gh(t.localStore,e.query,!1).then((({documents:t})=>e.view.ha(t,s))));const i=r&&r.targetChanges.get(e.targetId),o=r&&null!=r.targetMismatches.get(e.targetId),a=e.view.applyChanges(s,t.isPrimaryClient,i,o);return nf(t,e.targetId,a.da),a.snapshot}(t,e,n,r);const i=await gh(t.localStore,e,!0),o=new Bd(e,i.hs),a=o.ha(i.documents),u=Su.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==t.onlineState,s),c=o.applyChanges(a,t.isPrimaryClient,u);nf(t,n,c.da);const l=new Ud(e,n,o);return t.ga.set(e,l),t.pa.has(n)?t.pa.get(n).push(e):t.pa.set(n,[e]),c.snapshot}async function $d(t,e){const n=Xr(t),r=n.ga.get(e),s=n.pa.get(r.targetId);if(s.length>1)return n.pa.set(r.targetId,s.filter((t=>!ca(t,e)))),void n.ga.delete(e);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await fh(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),Yh(n.remoteStore,r.targetId),tf(n,r.targetId)})).catch(Os)):(tf(n,r.targetId),await fh(n.localStore,r.targetId,!0))}async function Qd(t,e){const n=Xr(t);try{const t=await function(t,e){const n=Xr(t),r=e.snapshotVersion;let s=n.ns;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(t=>{const i=n.os.newChangeBuffer({trackRemovals:!0});s=n.ns;const o=[];e.targetChanges.forEach(((i,a)=>{const u=s.get(a);if(!u)return;o.push(n.Qr.removeMatchingKeys(t,i.removedDocuments,a).next((()=>n.Qr.addMatchingKeys(t,i.addedDocuments,a))));let c=u.withSequenceNumber(t.currentSequenceNumber);null!==e.targetMismatches.get(a)?c=c.withResumeToken(qi.EMPTY_BYTE_STRING,ps.min()).withLastLimboFreeSnapshotVersion(ps.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,r)),s=s.insert(a,c),function(t,e,n){return 0===t.resumeToken.approximateByteSize()||e.snapshotVersion.toMicroseconds()-t.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.Qr.updateTargetData(t,c))}));let a=wa(),u=Ca();if(e.documentUpdates.forEach((r=>{e.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(t,r))})),o.push(lh(t,i,e.documentUpdates).next((t=>{a=t.cs,u=t.ls}))),!r.isEqual(ps.min())){const e=n.Qr.getLastRemoteSnapshotVersion(t).next((e=>n.Qr.setTargetsMetadata(t,t.currentSequenceNumber,r)));o.push(e)}return Ps.waitFor(o).next((()=>i.apply(t))).next((()=>n.localDocuments.getLocalViewOfDocuments(t,a,u))).next((()=>a))})).then((t=>(n.ns=s,t)))}(n.localStore,e);e.targetChanges.forEach(((t,e)=>{const r=n.Sa.get(e);r&&(Wr(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1),t.addedDocuments.size>0?r.ma=!0:t.modifiedDocuments.size>0?Wr(r.ma):t.removedDocuments.size>0&&(Wr(r.ma),r.ma=!1))})),await of(n,t,e)}catch(t){await Os(t)}}function Hd(t,e,n){const r=Xr(t);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const t=[];r.ga.forEach(((n,r)=>{const s=r.view.U_(e);s.snapshot&&t.push(s.snapshot)})),function(t,e){const n=Xr(t);n.onlineState=e;let r=!1;n.queries.forEach(((t,n)=>{for(const t of n.Q_)t.U_(e)&&(r=!0)})),r&&Rd(n)}(r.eventManager,e),t.length&&r.fa.u_(t),r.onlineState=e,r.isPrimaryClient&&r.sharedClientState.setOnlineState(e)}}async function Wd(t,e,n){const r=Xr(t);r.sharedClientState.updateQueryState(e,"rejected",n);const s=r.Sa.get(e),i=s&&s.key;if(i){let t=new Ni(_s.comparator);t=t.insert(i,bo.newNoDocument(i,ps.min()));const n=Ca().add(i),s=new Tu(ps.min(),new Map,new Ni(ds),t,n);await Qd(r,s),r.wa=r.wa.remove(i),r.Sa.delete(e),sf(r)}else await fh(r.localStore,e,!1).then((()=>tf(r,e,n))).catch(Os)}async function Yd(t,e){const n=Xr(t),r=e.batch.batchId;try{const t=await function(t,e){const n=Xr(t);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(t=>{const r=e.batch.keys(),s=n.os.newChangeBuffer({trackRemovals:!0});return function(t,e,n,r){const s=n.batch,i=s.keys();let o=Ps.resolve();return i.forEach((t=>{o=o.next((()=>r.getEntry(e,t))).next((e=>{const i=n.docVersions.get(t);Wr(null!==i),e.version.compareTo(i)<0&&(s.applyToRemoteDocument(e,n),e.isValidDocument()&&(e.setReadTime(n.commitVersion),r.addEntry(e)))}))})),o.next((()=>t.mutationQueue.removeMutationBatch(e,s)))}(n,t,e,s).next((()=>s.apply(t))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,r,e.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,function(t){let e=Ca();for(let n=0;n<t.mutationResults.length;++n)t.mutationResults[n].transformResults.length>0&&(e=e.add(t.batch.mutations[n].key));return e}(e)))).next((()=>n.localDocuments.getDocuments(t,r)))}))}(n.localStore,e);Zd(n,r,null),Jd(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await of(n,t)}catch(t){await Os(t)}}async function Xd(t,e,n){const r=Xr(t);try{const t=await function(t,e){const n=Xr(t);return n.persistence.runTransaction("Reject batch","readwrite-primary",(t=>{let r;return n.mutationQueue.lookupMutationBatch(t,e).next((e=>(Wr(null!==e),r=e.keys(),n.mutationQueue.removeMutationBatch(t,e)))).next((()=>n.mutationQueue.performConsistencyCheck(t))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(t,r,e))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,r))).next((()=>n.localDocuments.getDocuments(t,r)))}))}(r.localStore,e);Zd(r,e,n),Jd(r,e),r.sharedClientState.updateMutationState(e,"rejected",n),await of(r,t)}catch(t){await Os(t)}}function Jd(t,e){(t.Ca.get(e)||[]).forEach((t=>{t.resolve()})),t.Ca.delete(e)}function Zd(t,e,n){const r=Xr(t);let s=r.Da[r.currentUser.toKey()];if(s){const t=s.get(e);t&&(n?t.reject(n):t.resolve(),s=s.remove(e)),r.Da[r.currentUser.toKey()]=s}}function tf(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.pa.get(e))t.ga.delete(r),n&&t.fa.xa(r,n);t.pa.delete(e),t.isPrimaryClient&&t.ba.Vr(e).forEach((e=>{t.ba.containsKey(e)||ef(t,e)}))}function ef(t,e){t.ya.delete(e.path.canonicalString());const n=t.wa.get(e);null!==n&&(Yh(t.remoteStore,n),t.wa=t.wa.remove(e),t.Sa.delete(n),sf(t))}function nf(t,e,n){for(const r of n)r instanceof Vd?(t.ba.addReference(r.key,e),rf(t,r)):r instanceof qd?(jr("SyncEngine","Document no longer in limbo: "+r.key),t.ba.removeReference(r.key,e),t.ba.containsKey(r.key)||ef(t,r.key)):Hr()}function rf(t,e){const n=e.key,r=n.path.canonicalString();t.wa.get(n)||t.ya.has(r)||(jr("SyncEngine","New document in limbo: "+n),t.ya.add(r),sf(t))}function sf(t){for(;t.ya.size>0&&t.wa.size<t.maxConcurrentLimboResolutions;){const e=t.ya.values().next().value;t.ya.delete(e);const n=new _s(ws.fromString(e)),r=t.va.next();t.Sa.set(r,new zd(n)),t.wa=t.wa.insert(n,r),Wh(t.remoteStore,new fc(ia(ea(n.path)),r,"TargetPurposeLimboResolution",Hs._e))}}async function of(t,e,n){const r=Xr(t),s=[],i=[],o=[];r.ga.isEmpty()||(r.ga.forEach(((t,a)=>{o.push(r.Ma(a,e,n).then((t=>{if((t||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,(null==t?void 0:t.fromCache)?"not-current":"current"),t){s.push(t);const e=rh.Ki(a.targetId,t);i.push(e)}})))})),await Promise.all(o),r.fa.u_(s),await async function(t,e){const n=Xr(t);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(t=>Ps.forEach(e,(e=>Ps.forEach(e.qi,(r=>n.persistence.referenceDelegate.addReference(t,e.targetId,r))).next((()=>Ps.forEach(e.Qi,(r=>n.persistence.referenceDelegate.removeReference(t,e.targetId,r)))))))))}catch(t){if(!Us(t))throw t;jr("LocalStore","Failed to update sequence numbers: "+t)}for(const t of e){const e=t.targetId;if(!t.fromCache){const t=n.ns.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.ns=n.ns.insert(e,s)}}}(r.localStore,i))}async function af(t,e){const n=Xr(t);if(!n.currentUser.isEqual(e)){jr("SyncEngine","User change. New user:",e.toKey());const t=await uh(n.localStore,e);n.currentUser=e,function(t,e){t.Ca.forEach((t=>{t.forEach((t=>{t.reject(new Zr(Jr.CANCELLED,e))}))})),t.Ca.clear()}(n,"'waitForPendingWrites' promise is rejected due to a user change."),n.sharedClientState.handleUserChange(e,t.removedBatchIds,t.addedBatchIds),await of(n,t.us)}}function uf(t,e){const n=Xr(t),r=n.Sa.get(e);if(r&&r.ma)return Ca().add(r.key);{let t=Ca();const r=n.pa.get(e);if(!r)return t;for(const e of r){const r=n.ga.get(e);t=t.unionWith(r.view.la)}return t}}async function cf(t,e){const n=Xr(t),r=await gh(n.localStore,e.query,!0),s=e.view.Ra(r);return n.isPrimaryClient&&nf(n,e.targetId,s.da),s}async function lf(t,e){const n=Xr(t);return ph(n.localStore,e).then((t=>of(n,t)))}async function hf(t,e,n,r){const s=Xr(t),i=await function(t,e){const n=Xr(t),r=Xr(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(t=>r.vn(t,e).next((e=>e?n.localDocuments.getDocuments(t,e):Ps.resolve(null)))))}(s.localStore,e);null!==i?("pending"===n?await ud(s.remoteStore):"acknowledged"===n||"rejected"===n?(Zd(s,e,r||null),Jd(s,e),function(t,e){Xr(Xr(t).mutationQueue).Mn(e)}(s.localStore,e)):Hr(),await of(s,i)):jr("SyncEngine","Cannot apply mutation batch with id: "+e)}async function df(t,e,n){const r=Xr(t),s=[],i=[];for(const t of e){let e;const n=r.pa.get(t);if(n&&0!==n.length){e=await dh(r.localStore,ia(n[0]));for(const t of n){const e=r.ga.get(t),n=await cf(r,e);n.snapshot&&i.push(n.snapshot)}}else{const n=await mh(r.localStore,t);e=await dh(r.localStore,n),await Kd(r,ff(n),t,!1,e.resumeToken)}s.push(e)}return r.fa.u_(i),s}function ff(t){return ta(t.path,t.collectionGroup,t.orderBy,t.filters,t.limit,"F",t.startAt,t.endAt)}function gf(t){return function(t){return Xr(Xr(t).persistence).Li()}(Xr(t).localStore)}async function mf(t,e,n,r){const s=Xr(t);if(s.Fa)return void jr("SyncEngine","Ignoring unexpected query state notification.");const i=s.pa.get(e);if(i&&i.length>0)switch(n){case"current":case"not-current":{const t=await ph(s.localStore,fa(i[0])),r=Tu.createSynthesizedRemoteEventForCurrentChange(e,"current"===n,qi.EMPTY_BYTE_STRING);await of(s,t,r);break}case"rejected":await fh(s.localStore,e,!0),tf(s,e,r);break;default:Hr()}}async function pf(t,e,n){const r=yf(t);if(r.Fa){for(const t of e){if(r.pa.has(t)){jr("SyncEngine","Adding an already active target "+t);continue}const e=await mh(r.localStore,t),n=await dh(r.localStore,e);await Kd(r,ff(e),n.targetId,!1,n.resumeToken),Wh(r.remoteStore,n)}for(const t of n)r.pa.has(t)&&await fh(r.localStore,t,!1).then((()=>{Yh(r.remoteStore,t),tf(r,t)})).catch(Os)}}function yf(t){const e=Xr(t);return e.remoteStore.remoteSyncer.applyRemoteEvent=Qd.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=uf.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=Wd.bind(null,e),e.fa.u_=Nd.bind(null,e.eventManager),e.fa.xa=kd.bind(null,e.eventManager),e}function wf(t){const e=Xr(t);return e.remoteStore.remoteSyncer.applySuccessfulWrite=Yd.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=Xd.bind(null,e),e}class vf{constructor(){this.synchronizeTabs=!1}async initialize(t){this.serializer=qh(t.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(t),this.persistence=this.createPersistence(t),await this.persistence.start(),this.localStore=this.createLocalStore(t),this.gcScheduler=this.createGarbageCollectionScheduler(t,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(t,this.localStore)}createGarbageCollectionScheduler(t,e){return null}createIndexBackfillerScheduler(t,e){return null}createLocalStore(t){return ah(this.persistence,new ih,t.initialUser,this.serializer)}createPersistence(t){return new $l(Hl.Hr,this.serializer)}createSharedClientState(t){return new Dh}async terminate(){var t,e;null===(t=this.gcScheduler)||void 0===t||t.stop(),null===(e=this.indexBackfillerScheduler)||void 0===e||e.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class bf extends vf{constructor(t){super(),this.cacheSizeBytes=t}createGarbageCollectionScheduler(t,e){Wr(this.persistence.referenceDelegate instanceof Wl);const n=this.persistence.referenceDelegate.garbageCollector;return new Il(n,t.asyncQueue,e)}createPersistence(t){const e=void 0!==this.cacheSizeBytes?al.withCacheSize(this.cacheSizeBytes):al.DEFAULT;return new $l((t=>Wl.Hr(t,e)),this.serializer)}}class _f extends vf{constructor(t,e,n){super(),this.Na=t,this.cacheSizeBytes=e,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(t){await super.initialize(t),await this.Na.initialize(this,t),await wf(this.Na.syncEngine),await ud(this.Na.remoteStore),await this.persistence.fi((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(t){return ah(this.persistence,new ih,t.initialUser,this.serializer)}createGarbageCollectionScheduler(t,e){const n=this.persistence.referenceDelegate.garbageCollector;return new Il(n,t.asyncQueue,e)}createIndexBackfillerScheduler(t,e){const n=new Qs(e,this.persistence);return new $s(t.asyncQueue,n)}createPersistence(t){const e=nh(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?al.withCacheSize(this.cacheSizeBytes):al.DEFAULT;return new Zl(this.synchronizeTabs,e,t.clientId,n,t.asyncQueue,Fh(),Vh(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(t){return new Dh}}class If extends _f{constructor(t,e){super(t,e,!1),this.Na=t,this.cacheSizeBytes=e,this.synchronizeTabs=!0}async initialize(t){await super.initialize(t);const e=this.Na.syncEngine;this.sharedClientState instanceof Ch&&(this.sharedClientState.syncEngine={Zs:hf.bind(null,e),Xs:mf.bind(null,e),eo:pf.bind(null,e),Li:gf.bind(null,e),Ys:lf.bind(null,e)},await this.sharedClientState.start()),await this.persistence.fi((async t=>{await async function(t,e){const n=Xr(t);if(yf(n),wf(n),!0===e&&!0!==n.Fa){const t=n.sharedClientState.getAllActiveQueryTargets(),e=await df(n,t.toArray());n.Fa=!0,await wd(n.remoteStore,!0);for(const t of e)Wh(n.remoteStore,t)}else if(!1===e&&!1!==n.Fa){const t=[];let e=Promise.resolve();n.pa.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?t.push(s):e=e.then((()=>(tf(n,s),fh(n.localStore,s,!0)))),Yh(n.remoteStore,s)})),await e,await df(n,t),function(t){const e=Xr(t);e.Sa.forEach(((t,n)=>{Yh(e.remoteStore,n)})),e.ba.mr(),e.Sa=new Map,e.wa=new Ni(_s.comparator)}(n),n.Fa=!1,await wd(n.remoteStore,!1)}}(this.Na.syncEngine,t),this.gcScheduler&&(t&&!this.gcScheduler.started?this.gcScheduler.start():t||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(t&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():t||this.indexBackfillerScheduler.stop())}))}createSharedClientState(t){const e=Fh();if(!Ch.D(e))throw new Zr(Jr.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=nh(t.databaseInfo.databaseId,t.databaseInfo.persistenceKey);return new Ch(e,t.asyncQueue,n,t.clientId,t.initialUser)}}class Ef{async initialize(t,e){this.localStore||(this.localStore=t.localStore,this.sharedClientState=t.sharedClientState,this.datastore=this.createDatastore(e),this.remoteStore=this.createRemoteStore(e),this.eventManager=this.createEventManager(e),this.syncEngine=this.createSyncEngine(e,!t.synchronizeTabs),this.sharedClientState.onlineStateHandler=t=>Hd(this.syncEngine,t,1),this.remoteStore.remoteSyncer.handleCredentialChange=af.bind(null,this.syncEngine),await wd(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(t){return new Cd}createDatastore(t){const e=qh(t.databaseInfo.databaseId),n=function(t){return new Ph(t)}(t.databaseInfo);return function(t,e,n,r){return new jh(t,e,n,r)}(t.authCredentials,t.appCheckCredentials,n,e)}createRemoteStore(t){return function(t,e,n,r,s){return new $h(t,e,n,r,s)}(this.localStore,this.datastore,t.asyncQueue,(t=>Hd(this.syncEngine,t,0)),Nh.D()?new Nh:new Ah)}createSyncEngine(t,e){return function(t,e,n,r,s,i,o){const a=new Gd(t,e,n,r,s,i);return o&&(a.Fa=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,t.initialUser,t.maxConcurrentLimboResolutions,e)}async terminate(){var t;await async function(t){const e=Xr(t);jr("RemoteStore","RemoteStore shutting down."),e.v_.add(5),await Hh(e),e.M_.shutdown(),e.x_.set("Unknown")}(this.remoteStore),null===(t=this.datastore)||void 0===t||t.terminate()}}function Tf(t,e=10240){let n=0;return{async read(){if(n<t.byteLength){const r={value:t.slice(n,n+e),done:!1};return n+=e,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class Sf{constructor(t){this.observer=t,this.muted=!1}next(t){this.observer.next&&this.Ba(this.observer.next,t)}error(t){this.observer.error?this.Ba(this.observer.error,t):Kr("Uncaught Error in snapshot listener:",t.toString())}La(){this.muted=!0}Ba(t,e){this.muted||setTimeout((()=>{this.muted||t(e)}),0)}}class xf{constructor(t,e){this.ka=t,this.serializer=e,this.metadata=new ts,this.buffer=new Uint8Array,this.qa=new TextDecoder("utf-8"),this.Qa().then((t=>{t&&t.ea()?this.metadata.resolve(t.X_.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==t?void 0:t.X_)}`))}),(t=>this.metadata.reject(t)))}close(){return this.ka.cancel()}async getMetadata(){return this.metadata.promise}async Oa(){return await this.getMetadata(),this.Qa()}async Qa(){const t=await this.Ka();if(null===t)return null;const e=this.qa.decode(t),n=Number(e);isNaN(n)&&this.$a(`length string (${e}) is not valid number`);const r=await this.Ua(n);return new Ld(JSON.parse(r),t.length+n)}Wa(){return this.buffer.findIndex((t=>t==="{".charCodeAt(0)))}async Ka(){for(;this.Wa()<0&&!await this.Ga(););if(0===this.buffer.length)return null;const t=this.Wa();t<0&&this.$a("Reached the end of bundle when a length string is expected.");const e=this.buffer.slice(0,t);return this.buffer=this.buffer.slice(t),e}async Ua(t){for(;this.buffer.length<t;)await this.Ga()&&this.$a("Reached the end of bundle when more is expected.");const e=this.qa.decode(this.buffer.slice(0,t));return this.buffer=this.buffer.slice(t),e}$a(t){throw this.ka.cancel(),new Error(`Invalid bundle format: ${t}`)}async Ga(){const t=await this.ka.read();if(!t.done){const e=new Uint8Array(this.buffer.length+t.value.length);e.set(this.buffer),e.set(t.value,this.buffer.length),this.buffer=e}return t.done}}class Cf{constructor(t){this.datastore=t,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(t){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new Zr(Jr.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const e=await async function(t,e){const n=Xr(t),r={documents:e.map((t=>Ku(n.serializer,t)))},s=await n.vo("BatchGetDocuments",n.serializer.databaseId,ws.emptyPath(),r,e.length),i=new Map;s.forEach((t=>{const e=function(t,e){return"found"in e?function(t,e){Wr(!!e.found),e.found.name,e.found.updateTime;const n=$u(t,e.found.name),r=Uu(e.found.updateTime),s=e.found.createTime?Uu(e.found.createTime):ps.min(),i=new wo({mapValue:{fields:e.found.fields}});return bo.newFoundDocument(n,r,s,i)}(t,e):"missing"in e?function(t,e){Wr(!!e.missing),Wr(!!e.readTime);const n=$u(t,e.missing),r=Uu(e.readTime);return bo.newNoDocument(n,r)}(t,e):Hr()}(n.serializer,t);i.set(e.key.toString(),e)}));const o=[];return e.forEach((t=>{const e=i.get(t.toString());Wr(!!e),o.push(e)})),o}(this.datastore,t);return e.forEach((t=>this.recordVersion(t))),e}set(t,e){this.write(e.toMutation(t,this.precondition(t))),this.writtenDocs.add(t.toString())}update(t,e){try{this.write(e.toMutation(t,this.preconditionForUpdate(t)))}catch(t){this.lastTransactionError=t}this.writtenDocs.add(t.toString())}delete(t){this.write(new ou(t,this.precondition(t))),this.writtenDocs.add(t.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const t=this.readVersions;this.mutations.forEach((e=>{t.delete(e.key.toString())})),t.forEach(((t,e)=>{const n=_s.fromPath(e);this.mutations.push(new au(n,this.precondition(n)))})),await async function(t,e){const n=Xr(t),r={writes:e.map((t=>Zu(n.serializer,t)))};await n.So("Commit",n.serializer.databaseId,ws.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(t){let e;if(t.isFoundDocument())e=t.version;else{if(!t.isNoDocument())throw Hr();e=ps.min()}const n=this.readVersions.get(t.key.toString());if(n){if(!e.isEqual(n))throw new Zr(Jr.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(t.key.toString(),e)}precondition(t){const e=this.readVersions.get(t.toString());return!this.writtenDocs.has(t.toString())&&e?e.isEqual(ps.min())?Qa.exists(!1):Qa.updateTime(e):Qa.none()}preconditionForUpdate(t){const e=this.readVersions.get(t.toString());if(!this.writtenDocs.has(t.toString())&&e){if(e.isEqual(ps.min()))throw new Zr(Jr.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Qa.updateTime(e)}return Qa.exists(!0)}write(t){this.ensureCommitNotCalled(),this.mutations.push(t)}ensureCommitNotCalled(){}}class Df{constructor(t,e,n,r,s){this.asyncQueue=t,this.datastore=e,this.options=n,this.updateFunction=r,this.deferred=s,this.za=n.maxAttempts,this.jo=new Bh(this.asyncQueue,"transaction_retry")}ja(){this.za-=1,this.Ha()}Ha(){this.jo.qo((async()=>{const t=new Cf(this.datastore),e=this.Ja(t);e&&e.then((e=>{this.asyncQueue.enqueueAndForget((()=>t.commit().then((()=>{this.deferred.resolve(e)})).catch((t=>{this.Ya(t)}))))})).catch((t=>{this.Ya(t)}))}))}Ja(t){try{const e=this.updateFunction(t);return!Ws(e)&&e.catch&&e.then?e:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(t){return this.deferred.reject(t),null}}Ya(t){this.za>0&&this.Za(t)?(this.za-=1,this.asyncQueue.enqueueAndForget((()=>(this.Ha(),Promise.resolve())))):this.deferred.reject(t)}Za(t){if("FirebaseError"===t.name){const e=t.code;return"aborted"===e||"failed-precondition"===e||"already-exists"===e||!mu(e)}return!1}}class Af{constructor(t,e,n,r){this.authCredentials=t,this.appCheckCredentials=e,this.asyncQueue=n,this.databaseInfo=r,this.user=qr.UNAUTHENTICATED,this.clientId=hs.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async t=>{jr("FirestoreClient","Received user=",t.uid),await this.authCredentialListener(t),this.user=t})),this.appCheckCredentials.start(n,(t=>(jr("FirestoreClient","Received new app check token=",t),this.appCheckCredentialListener(t,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(t){this.authCredentialListener=t}setAppCheckTokenChangeListener(t){this.appCheckCredentialListener=t}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new Zr(Jr.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const t=new ts;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),t.resolve()}catch(e){const n=Id(e,"Failed to shutdown persistence");t.reject(n)}})),t.promise}}async function Nf(t,e){t.asyncQueue.verifyOperationInProgress(),jr("FirestoreClient","Initializing OfflineComponentProvider");const n=t.configuration;await e.initialize(n);let r=n.initialUser;t.setCredentialChangeListener((async t=>{r.isEqual(t)||(await uh(e.localStore,t),r=t)})),e.persistence.setDatabaseDeletedListener((()=>t.terminate())),t._offlineComponents=e}async function kf(t,e){t.asyncQueue.verifyOperationInProgress();const n=await Mf(t);jr("FirestoreClient","Initializing OnlineComponentProvider"),await e.initialize(n,t.configuration),t.setCredentialChangeListener((t=>yd(e.remoteStore,t))),t.setAppCheckTokenChangeListener(((t,n)=>yd(e.remoteStore,n))),t._onlineComponents=e}function Rf(t){return"FirebaseError"===t.name?t.code===Jr.FAILED_PRECONDITION||t.code===Jr.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code}async function Mf(t){if(!t._offlineComponents)if(t._uninitializedComponentsProvider){jr("FirestoreClient","Using user provided OfflineComponentProvider");try{await Nf(t,t._uninitializedComponentsProvider._offline)}catch(e){const n=e;if(!Rf(n))throw n;$r("Error using user provided cache. Falling back to memory cache: "+n),await Nf(t,new vf)}}else jr("FirestoreClient","Using default OfflineComponentProvider"),await Nf(t,new vf);return t._offlineComponents}async function Lf(t){return t._onlineComponents||(t._uninitializedComponentsProvider?(jr("FirestoreClient","Using user provided OnlineComponentProvider"),await kf(t,t._uninitializedComponentsProvider._online)):(jr("FirestoreClient","Using default OnlineComponentProvider"),await kf(t,new Ef))),t._onlineComponents}function Of(t){return Mf(t).then((t=>t.persistence))}function Pf(t){return Mf(t).then((t=>t.localStore))}function Ff(t){return Lf(t).then((t=>t.remoteStore))}function Vf(t){return Lf(t).then((t=>t.syncEngine))}function qf(t){return Lf(t).then((t=>t.datastore))}async function Bf(t){const e=await Lf(t),n=e.eventManager;return n.onListen=jd.bind(null,e.syncEngine),n.onUnlisten=$d.bind(null,e.syncEngine),n}function Uf(t,e,n={}){const r=new ts;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new Sf({next:i=>{e.enqueueAndForget((()=>Ad(t,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new Zr(Jr.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new Zr(Jr.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:t=>s.reject(t)}),o=new Md(ea(n.path),i,{includeMetadataChanges:!0,Z_:!0});return Dd(t,o)}(await Bf(t),t.asyncQueue,e,n,r))),r.promise}function zf(t,e,n={}){const r=new ts;return t.asyncQueue.enqueueAndForget((async()=>function(t,e,n,r,s){const i=new Sf({next:n=>{e.enqueueAndForget((()=>Ad(t,o))),n.fromCache&&"server"===r.source?s.reject(new Zr(Jr.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:t=>s.reject(t)}),o=new Md(n,i,{includeMetadataChanges:!0,Z_:!0});return Dd(t,o)}(await Bf(t),t.asyncQueue,e,n,r))),r.promise}function Gf(t){const e={};return void 0!==t.timeoutSeconds&&(e.timeoutSeconds=t.timeoutSeconds),e}const jf=new Map;function Kf(t,e,n){if(!n)throw new Zr(Jr.INVALID_ARGUMENT,`Function ${t}() cannot be called with an empty ${e}.`)}function $f(t,e,n,r){if(!0===e&&!0===r)throw new Zr(Jr.INVALID_ARGUMENT,`${t} and ${n} cannot be used together.`)}function Qf(t){if(!_s.isDocumentKey(t))throw new Zr(Jr.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${t} has ${t.length}.`)}function Hf(t){if(_s.isDocumentKey(t))throw new Zr(Jr.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${t} has ${t.length}.`)}function Wf(t){if(void 0===t)return"undefined";if(null===t)return"null";if("string"==typeof t)return t.length>20&&(t=`${t.substring(0,20)}...`),JSON.stringify(t);if("number"==typeof t||"boolean"==typeof t)return""+t;if("object"==typeof t){if(t instanceof Array)return"an array";{const e=function(t){return t.constructor?t.constructor.name:null}(t);return e?`a custom ${e} object`:"an object"}}return"function"==typeof t?"a function":Hr()}function Yf(t,e){if("_delegate"in t&&(t=t._delegate),!(t instanceof e)){if(e.name===t.constructor.name)throw new Zr(Jr.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Wf(t);throw new Zr(Jr.INVALID_ARGUMENT,`Expected type '${e.name}', but it was: ${n}`)}}return t}function Xf(t,e){if(e<=0)throw new Zr(Jr.INVALID_ARGUMENT,`Function ${t}() requires a positive number, but it was: ${e}.`)}class Jf{constructor(t){var e,n;if(void 0===t.host){if(void 0!==t.ssl)throw new Zr(Jr.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=t.host,this.ssl=null===(e=t.ssl)||void 0===e||e;if(this.credentials=t.credentials,this.ignoreUndefinedProperties=!!t.ignoreUndefinedProperties,this.localCache=t.localCache,void 0===t.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new Zr(Jr.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=t.cacheSizeBytes}$f("experimentalForceLongPolling",t.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",t.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!t.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===t.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!t.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=Gf(null!==(n=t.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(t){if(void 0!==t.timeoutSeconds){if(isNaN(t.timeoutSeconds))throw new Zr(Jr.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (must not be NaN)`);if(t.timeoutSeconds<5)throw new Zr(Jr.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (minimum allowed value is 5)`);if(t.timeoutSeconds>30)throw new Zr(Jr.INVALID_ARGUMENT,`invalid long polling timeout: ${t.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!t.useFetchStreams}isEqual(t){return this.host===t.host&&this.ssl===t.ssl&&this.credentials===t.credentials&&this.cacheSizeBytes===t.cacheSizeBytes&&this.experimentalForceLongPolling===t.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===t.experimentalAutoDetectLongPolling&&function(t,e){return t.timeoutSeconds===e.timeoutSeconds}(this.experimentalLongPollingOptions,t.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===t.ignoreUndefinedProperties&&this.useFetchStreams===t.useFetchStreams}}class Zf{constructor(t,e,n,r){this._authCredentials=t,this._appCheckCredentials=e,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Jf({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new Zr(Jr.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(t){if(this._settingsFrozen)throw new Zr(Jr.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Jf(t),void 0!==t.credentials&&(this._authCredentials=function(t){if(!t)return new ns;switch(t.type){case"firstParty":return new os(t.sessionIndex||"0",t.iamToken||null,t.authTokenFactory||null);case"provider":return t.client;default:throw new Zr(Jr.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(t.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(t){const e=jf.get(t);e&&(jr("ComponentProvider","Removing Datastore"),jf.delete(t),e.terminate())}(this),Promise.resolve()}}function tg(t,e,n,r={}){var s;const i=(t=Yf(t,Zf))._getSettings(),o=`${e}:${n}`;if("firestore.googleapis.com"!==i.host&&i.host!==o&&$r("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),t._setSettings(Object.assign(Object.assign({},i),{host:o,ssl:!1})),r.mockUserToken){let e,n;if("string"==typeof r.mockUserToken)e=r.mockUserToken,n=qr.MOCK_USER;else{e=function(t,e){if(t.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const n=e||"demo-project",r=t.iat||0,s=t.sub||t.user_id;if(!s)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const i=Object.assign({iss:`https://securetoken.google.com/${n}`,aud:n,iat:r,exp:r+3600,auth_time:r,sub:s,user_id:s,firebase:{sign_in_provider:"custom",identities:{}}},t);return[l(JSON.stringify({alg:"none",type:"JWT"})),l(JSON.stringify(i)),""].join(".")}(r.mockUserToken,null===(s=t._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new Zr(Jr.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new qr(i)}t._authCredentials=new rs(new es(e,n))}}class eg{constructor(t,e,n){this.converter=e,this._query=n,this.type="query",this.firestore=t}withConverter(t){return new eg(this.firestore,t,this._query)}}class ng{constructor(t,e,n){this.converter=e,this._key=n,this.type="document",this.firestore=t}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new rg(this.firestore,this.converter,this._key.path.popLast())}withConverter(t){return new ng(this.firestore,t,this._key)}}class rg extends eg{constructor(t,e,n){super(t,e,ea(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const t=this._path.popLast();return t.isEmpty()?null:new ng(this.firestore,null,new _s(t))}withConverter(t){return new rg(this.firestore,t,this._path)}}function sg(t,e,...n){if(t=v(t),Kf("collection","path",e),t instanceof Zf){const r=ws.fromString(e,...n);return Hf(r),new rg(t,null,r)}{if(!(t instanceof ng||t instanceof rg))throw new Zr(Jr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(ws.fromString(e,...n));return Hf(r),new rg(t.firestore,null,r)}}function ig(t,e){if(t=Yf(t,Zf),Kf("collectionGroup","collection id",e),e.indexOf("/")>=0)throw new Zr(Jr.INVALID_ARGUMENT,`Invalid collection ID '${e}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new eg(t,null,function(t){return new Zo(ws.emptyPath(),t)}(e))}function og(t,e,...n){if(t=v(t),1===arguments.length&&(e=hs.newId()),Kf("doc","path",e),t instanceof Zf){const r=ws.fromString(e,...n);return Qf(r),new ng(t,null,new _s(r))}{if(!(t instanceof ng||t instanceof rg))throw new Zr(Jr.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=t._path.child(ws.fromString(e,...n));return Qf(r),new ng(t.firestore,t instanceof rg?t.converter:null,new _s(r))}}function ag(t,e){return t=v(t),e=v(e),(t instanceof ng||t instanceof rg)&&(e instanceof ng||e instanceof rg)&&t.firestore===e.firestore&&t.path===e.path&&t.converter===e.converter}function ug(t,e){return t=v(t),e=v(e),t instanceof eg&&e instanceof eg&&t.firestore===e.firestore&&ca(t._query,e._query)&&t.converter===e.converter}class cg{constructor(){this.Xa=Promise.resolve(),this.eu=[],this.tu=!1,this.nu=[],this.ru=null,this.iu=!1,this.su=!1,this.ou=[],this.jo=new Bh(this,"async_queue_retry"),this._u=()=>{const t=Vh();t&&jr("AsyncQueue","Visibility state changed to "+t.visibilityState),this.jo.Ko()};const t=Vh();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this._u)}get isShuttingDown(){return this.tu}enqueueAndForget(t){this.enqueue(t)}enqueueAndForgetEvenWhileRestricted(t){this.au(),this.uu(t)}enterRestrictedMode(t){if(!this.tu){this.tu=!0,this.su=t||!1;const e=Vh();e&&"function"==typeof e.removeEventListener&&e.removeEventListener("visibilitychange",this._u)}}enqueue(t){if(this.au(),this.tu)return new Promise((()=>{}));const e=new ts;return this.uu((()=>this.tu&&this.su?Promise.resolve():(t().then(e.resolve,e.reject),e.promise))).then((()=>e.promise))}enqueueRetryable(t){this.enqueueAndForget((()=>(this.eu.push(t),this.cu())))}async cu(){if(0!==this.eu.length){try{await this.eu[0](),this.eu.shift(),this.jo.reset()}catch(t){if(!Us(t))throw t;jr("AsyncQueue","Operation failed with retryable error: "+t)}this.eu.length>0&&this.jo.qo((()=>this.cu()))}}uu(t){const e=this.Xa.then((()=>(this.iu=!0,t().catch((t=>{this.ru=t,this.iu=!1;const e=function(t){let e=t.message||"";return t.stack&&(e=t.stack.includes(t.message)?t.stack:t.message+"\n"+t.stack),e}(t);throw Kr("INTERNAL UNHANDLED ERROR: ",e),t})).then((t=>(this.iu=!1,t))))));return this.Xa=e,e}enqueueAfterDelay(t,e,n){this.au(),this.ou.indexOf(t)>-1&&(e=0);const r=_d.createAndSchedule(this,t,e,n,(t=>this.lu(t)));return this.nu.push(r),r}au(){this.ru&&Hr()}verifyOperationInProgress(){}async hu(){let t;do{t=this.Xa,await t}while(t!==this.Xa)}Pu(t){for(const e of this.nu)if(e.timerId===t)return!0;return!1}Iu(t){return this.hu().then((()=>{this.nu.sort(((t,e)=>t.targetTimeMs-e.targetTimeMs));for(const e of this.nu)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.hu()}))}Tu(t){this.ou.push(t)}lu(t){const e=this.nu.indexOf(t);this.nu.splice(e,1)}}function lg(t){return function(t,e){if("object"!=typeof t||null===t)return!1;const n=t;for(const t of e)if(t in n&&"function"==typeof n[t])return!0;return!1}(t,["next","error","complete"])}class hg{constructor(){this._progressObserver={},this._taskCompletionResolver=new ts,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(t,e,n){this._progressObserver={next:t,error:e,complete:n}}catch(t){return this._taskCompletionResolver.promise.catch(t)}then(t,e){return this._taskCompletionResolver.promise.then(t,e)}_completeWith(t){this._updateProgress(t),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(t)}_failWith(t){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(t),this._taskCompletionResolver.reject(t)}_updateProgress(t){this._lastProgress=t,this._progressObserver.next&&this._progressObserver.next(t)}}const dg=-1;class fg extends Zf{constructor(t,e,n,r){super(t,e,n,r),this.type="firestore",this._queue=new cg,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||yg(this),this._firestoreClient.terminate()}}function gg(t,e,n){n||(n="(default)");const r=i._getProvider(t,"firestore");if(r.isInitialized(n)){const t=r.getImmediate({identifier:n});if(y(r.getOptions(n),e))return t;throw new Zr(Jr.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==e.cacheSizeBytes&&void 0!==e.localCache)throw new Zr(Jr.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==e.cacheSizeBytes&&-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new Zr(Jr.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return r.initialize({options:e,instanceIdentifier:n})}function mg(t,e){const n="object"==typeof t?t:i.getApp(),r="string"==typeof t?t:e||"(default)",s=i._getProvider(n,"firestore").getImmediate({identifier:r});if(!s._initialized){const t=(t=>{const e=(t=>{var e,n;return null===(n=null===(e=h())||void 0===e?void 0:e.emulatorHosts)||void 0===n?void 0:n[t]})(t);if(!e)return;const n=e.lastIndexOf(":");if(n<=0||n+1===e.length)throw new Error(`Invalid host ${e} with no separate hostname and port!`);const r=parseInt(e.substring(n+1),10);return"["===e[0]?[e.substring(1,n-1),r]:[e.substring(0,n),r]})("firestore");t&&tg(s,...t)}return s}function pg(t){return t._firestoreClient||yg(t),t._firestoreClient.verifyNotTerminated(),t._firestoreClient}function yg(t){var e,n,r;const s=t._freezeSettings(),i=function(t,e,n,r){return new Qi(t,e,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,Gf(r.experimentalLongPollingOptions),r.useFetchStreams)}(t._databaseId,(null===(e=t._app)||void 0===e?void 0:e.options.appId)||"",t._persistenceKey,s);t._firestoreClient=new Af(t._authCredentials,t._appCheckCredentials,t._queue,i),(null===(n=s.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(t._firestoreClient._uninitializedComponentsProvider={_offlineKind:s.localCache.kind,_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider})}function wg(t,e){Dg(t=Yf(t,fg));const n=pg(t);if(n._uninitializedComponentsProvider)throw new Zr(Jr.FAILED_PRECONDITION,"SDK cache is already specified.");$r("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const r=t._freezeSettings(),s=new Ef;return bg(n,s,new _f(s,r.cacheSizeBytes,null==e?void 0:e.forceOwnership))}function vg(t){Dg(t=Yf(t,fg));const e=pg(t);if(e._uninitializedComponentsProvider)throw new Zr(Jr.FAILED_PRECONDITION,"SDK cache is already specified.");$r("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=t._freezeSettings(),r=new Ef;return bg(e,r,new If(r,n.cacheSizeBytes))}function bg(t,e,n){const r=new ts;return t.asyncQueue.enqueue((async()=>{try{await Nf(t,n),await kf(t,e),r.resolve()}catch(t){const e=t;if(!Rf(e))throw e;$r("Error enabling indexeddb cache. Falling back to memory cache: "+e),r.reject(e)}})).then((()=>r.promise))}function _g(t){if(t._initialized&&!t._terminated)throw new Zr(Jr.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const e=new ts;return t._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(t){if(!Vs.D())return Promise.resolve();const e=t+"main";await Vs.delete(e)}(nh(t._databaseId,t._persistenceKey)),e.resolve()}catch(t){e.reject(t)}})),e.promise}function Ig(t){return function(t){const e=new ts;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e){const n=Xr(t);ed(n.remoteStore)||jr("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const t=await function(t){const e=Xr(t);return e.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(t=>e.mutationQueue.getHighestUnacknowledgedBatchId(t)))}(n.localStore);if(-1===t)return void e.resolve();const r=n.Ca.get(t)||[];r.push(e),n.Ca.set(t,r)}catch(t){const n=Id(t,"Initialization of waitForPendingWrites() operation failed");e.reject(n)}}(await Vf(t),e))),e.promise}(pg(t=Yf(t,fg)))}function Eg(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Of(t),n=await Ff(t);return e.setNetworkEnabled(!0),function(t){const e=Xr(t);return e.v_.delete(0),Qh(e)}(n)}))}(pg(t=Yf(t,fg)))}function Tg(t){return function(t){return t.asyncQueue.enqueue((async()=>{const e=await Of(t),n=await Ff(t);return e.setNetworkEnabled(!1),async function(t){const e=Xr(t);e.v_.add(0),await Hh(e),e.x_.set("Offline")}(n)}))}(pg(t=Yf(t,fg)))}function Sg(t){return i._removeServiceInstance(t.app,"firestore",t._databaseId.database),t._delete()}function xg(t,e){const n=pg(t=Yf(t,fg)),r=new hg;return function(t,e,n,r){const s=function(t,e){let n;return n="string"==typeof t?wu().encode(t):t,function(t,e){return new xf(t,e)}(function(t,e){if(t instanceof Uint8Array)return Tf(t,e);if(t instanceof ArrayBuffer)return Tf(new Uint8Array(t),e);if(t instanceof ReadableStream)return t.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),e)}(n,qh(e));t.asyncQueue.enqueueAndForget((async()=>{!function(t,e,n){const r=Xr(t);(async function(t,e,n){try{const r=await e.getMetadata();if(await function(t,e){const n=Xr(t),r=Uu(e.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(t=>n.$r.getBundleMetadata(t,e.id))).then((t=>!!t&&t.createTime.compareTo(r)>=0))}(t.localStore,r))return await e.close(),n._completeWith(function(t){return{taskState:"Success",documentsLoaded:t.totalDocuments,bytesLoaded:t.totalBytes,totalDocuments:t.totalDocuments,totalBytes:t.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(Fd(r));const s=new Pd(r,t.localStore,e.serializer);let i=await e.Oa();for(;i;){const t=await s.na(i);t&&n._updateProgress(t),i=await e.Oa()}const o=await s.complete();return await of(t,o.sa,void 0),await function(t,e){const n=Xr(t);return n.persistence.runTransaction("Save bundle","readwrite",(t=>n.$r.saveBundleMetadata(t,e)))}(t.localStore,r),n._completeWith(o.progress),Promise.resolve(o.ia)}catch(t){return $r("SyncEngine",`Loading bundle failed with ${t}`),n._failWith(t),Promise.resolve(new Set)}})(r,e,n).then((t=>{r.sharedClientState.notifyBundleLoaded(t)}))}(await Vf(t),s,r)}))}(n,t._databaseId,e,r),r}function Cg(t,e){return function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){const n=Xr(t);return n.persistence.runTransaction("Get named query","readonly",(t=>n.$r.getNamedQuery(t,e)))}(await Pf(t),e)))}(pg(t=Yf(t,fg)),e).then((e=>e?new eg(t,null,e.query):null))}function Dg(t){if(t._initialized||t._terminated)throw new Zr(Jr.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Ag{constructor(t="count",e){this._internalFieldPath=e,this.type="AggregateField",this.aggregateType=t}}class Ng{constructor(t,e,n){this._userDataWriter=e,this._data=n,this.type="AggregateQuerySnapshot",this.query=t}data(){return this._userDataWriter.convertObjectMap(this._data)}}class kg{constructor(t){this._byteString=t}static fromBase64String(t){try{return new kg(qi.fromBase64String(t))}catch(t){throw new Zr(Jr.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+t)}}static fromUint8Array(t){return new kg(qi.fromUint8Array(t))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(t){return this._byteString.isEqual(t._byteString)}}class Rg{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new Zr(Jr.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new bs(t)}isEqual(t){return this._internalPath.isEqual(t._internalPath)}}function Mg(){return new Rg("__name__")}class Lg{constructor(t){this._methodName=t}}class Og{constructor(t,e){if(!isFinite(t)||t<-90||t>90)throw new Zr(Jr.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+t);if(!isFinite(e)||e<-180||e>180)throw new Zr(Jr.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+e);this._lat=t,this._long=e}get latitude(){return this._lat}get longitude(){return this._long}isEqual(t){return this._lat===t._lat&&this._long===t._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(t){return ds(this._lat,t._lat)||ds(this._long,t._long)}}const Pg=/^__.*__$/;class Fg{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return null!==this.fieldMask?new nu(t,this.data,this.fieldMask,e,this.fieldTransforms):new eu(t,this.data,e,this.fieldTransforms)}}class Vg{constructor(t,e,n){this.data=t,this.fieldMask=e,this.fieldTransforms=n}toMutation(t,e){return new nu(t,this.data,this.fieldMask,e,this.fieldTransforms)}}function qg(t){switch(t){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw Hr()}}class Bg{constructor(t,e,n,r,s,i){this.settings=t,this.databaseId=e,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Eu(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get du(){return this.settings.du}Au(t){return new Bg(Object.assign(Object.assign({},this.settings),t),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Ru(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Au({path:n,Vu:!1});return r.mu(t),r}fu(t){var e;const n=null===(e=this.path)||void 0===e?void 0:e.child(t),r=this.Au({path:n,Vu:!1});return r.Eu(),r}gu(t){return this.Au({path:void 0,Vu:!0})}pu(t){return om(t,this.settings.methodName,this.settings.yu||!1,this.path,this.settings.wu)}contains(t){return void 0!==this.fieldMask.find((e=>t.isPrefixOf(e)))||void 0!==this.fieldTransforms.find((e=>t.isPrefixOf(e.field)))}Eu(){if(this.path)for(let t=0;t<this.path.length;t++)this.mu(this.path.get(t))}mu(t){if(0===t.length)throw this.pu("Document fields must not be empty");if(qg(this.du)&&Pg.test(t))throw this.pu('Document fields cannot begin and end with "__"')}}class Ug{constructor(t,e,n){this.databaseId=t,this.ignoreUndefinedProperties=e,this.serializer=n||qh(t)}Su(t,e,n,r=!1){return new Bg({du:t,methodName:e,wu:n,path:bs.emptyPath(),Vu:!1,yu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function zg(t){const e=t._freezeSettings(),n=qh(t._databaseId);return new Ug(t._databaseId,!!e.ignoreUndefinedProperties,n)}function Gg(t,e,n,r,s,i={}){const o=t.Su(i.merge||i.mergeFields?2:0,e,n,s);nm("Data must be an object, but it was:",o,r);const a=tm(r,o);let u,c;if(i.merge)u=new Pi(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const t=[];for(const r of i.mergeFields){const s=rm(e,r,n);if(!o.contains(s))throw new Zr(Jr.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);am(t,s)||t.push(s)}u=new Pi(t),c=o.fieldTransforms.filter((t=>u.covers(t.field)))}else u=null,c=o.fieldTransforms;return new Fg(new wo(a),u,c)}class jg extends Lg{_toFieldTransform(t){if(2!==t.du)throw 1===t.du?t.pu(`${this._methodName}() can only appear at the top level of your update data`):t.pu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return t.fieldMask.push(t.path),null}isEqual(t){return t instanceof jg}}function Kg(t,e,n){return new Bg({du:3,wu:e.settings.wu,methodName:t._methodName,Vu:n},e.databaseId,e.serializer,e.ignoreUndefinedProperties)}class $g extends Lg{_toFieldTransform(t){return new Ka(t.path,new Fa)}isEqual(t){return t instanceof $g}}class Qg extends Lg{constructor(t,e){super(t),this.bu=e}_toFieldTransform(t){const e=Kg(this,t,!0),n=this.bu.map((t=>Zg(t,e))),r=new Va(n);return new Ka(t.path,r)}isEqual(t){return t instanceof Qg&&y(this.bu,t.bu)}}class Hg extends Lg{constructor(t,e){super(t),this.bu=e}_toFieldTransform(t){const e=Kg(this,t,!0),n=this.bu.map((t=>Zg(t,e))),r=new Ba(n);return new Ka(t.path,r)}isEqual(t){return t instanceof Hg&&y(this.bu,t.bu)}}class Wg extends Lg{constructor(t,e){super(t),this.Du=e}_toFieldTransform(t){const e=new za(t.serializer,Ra(t.serializer,this.Du));return new Ka(t.path,e)}isEqual(t){return t instanceof Wg&&this.Du===t.Du}}function Yg(t,e,n,r){const s=t.Su(1,e,n);nm("Data must be an object, but it was:",s,r);const i=[],o=wo.empty();Di(r,((t,r)=>{const a=im(e,t,n);r=v(r);const u=s.fu(a);if(r instanceof jg)i.push(a);else{const t=Zg(r,u);null!=t&&(i.push(a),o.set(a,t))}}));const a=new Pi(i);return new Vg(o,a,s.fieldTransforms)}function Xg(t,e,n,r,s,i){const o=t.Su(1,e,n),a=[rm(e,r,n)],u=[s];if(i.length%2!=0)throw new Zr(Jr.INVALID_ARGUMENT,`Function ${e}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let t=0;t<i.length;t+=2)a.push(rm(e,i[t])),u.push(i[t+1]);const c=[],l=wo.empty();for(let t=a.length-1;t>=0;--t)if(!am(c,a[t])){const e=a[t];let n=u[t];n=v(n);const r=o.fu(e);if(n instanceof jg)c.push(e);else{const t=Zg(n,r);null!=t&&(c.push(e),l.set(e,t))}}const h=new Pi(c);return new Vg(l,h,o.fieldTransforms)}function Jg(t,e,n,r=!1){return Zg(n,t.Su(r?4:3,e))}function Zg(t,e){if(em(t=v(t)))return nm("Unsupported field value:",e,t),tm(t,e);if(t instanceof Lg)return function(t,e){if(!qg(e.du))throw e.pu(`${t._methodName}() can only be used with update() and set()`);if(!e.path)throw e.pu(`${t._methodName}() is not currently supported inside arrays`);const n=t._toFieldTransform(e);n&&e.fieldTransforms.push(n)}(t,e),null;if(void 0===t&&e.ignoreUndefinedProperties)return null;if(e.path&&e.fieldMask.push(e.path),t instanceof Array){if(e.settings.Vu&&4!==e.du)throw e.pu("Nested arrays are not supported");return function(t,e){const n=[];let r=0;for(const s of t){let t=Zg(s,e.gu(r));null==t&&(t={nullValue:"NULL_VALUE"}),n.push(t),r++}return{arrayValue:{values:n}}}(t,e)}return function(t,e){if(null===(t=v(t)))return{nullValue:"NULL_VALUE"};if("number"==typeof t)return Ra(e.serializer,t);if("boolean"==typeof t)return{booleanValue:t};if("string"==typeof t)return{stringValue:t};if(t instanceof Date){const n=ms.fromDate(t);return{timestampValue:Vu(e.serializer,n)}}if(t instanceof ms){const n=new ms(t.seconds,1e3*Math.floor(t.nanoseconds/1e3));return{timestampValue:Vu(e.serializer,n)}}if(t instanceof Og)return{geoPointValue:{latitude:t.latitude,longitude:t.longitude}};if(t instanceof kg)return{bytesValue:qu(e.serializer,t._byteString)};if(t instanceof ng){const n=e.databaseId,r=t.firestore._databaseId;if(!r.isEqual(n))throw e.pu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:zu(t.firestore._databaseId||e.databaseId,t._key.path)}}throw e.pu(`Unsupported field value: ${Wf(t)}`)}(t,e)}function tm(t,e){const n={};return Ai(t)?e.path&&e.path.length>0&&e.fieldMask.push(e.path):Di(t,((t,r)=>{const s=Zg(r,e.Ru(t));null!=s&&(n[t]=s)})),{mapValue:{fields:n}}}function em(t){return!("object"!=typeof t||null===t||t instanceof Array||t instanceof Date||t instanceof ms||t instanceof Og||t instanceof kg||t instanceof ng||t instanceof Lg)}function nm(t,e,n){if(!em(n)||!function(t){return"object"==typeof t&&null!==t&&(Object.getPrototypeOf(t)===Object.prototype||null===Object.getPrototypeOf(t))}(n)){const r=Wf(n);throw"an object"===r?e.pu(t+" a custom object"):e.pu(t+" "+r)}}function rm(t,e,n){if((e=v(e))instanceof Rg)return e._internalPath;if("string"==typeof e)return im(t,e);throw om("Field path arguments must be of type string or ",t,!1,void 0,n)}const sm=new RegExp("[~\\*/\\[\\]]");function im(t,e,n){if(e.search(sm)>=0)throw om(`Invalid field path (${e}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,n);try{return new Rg(...e.split("."))._internalPath}catch(r){throw om(`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,n)}}function om(t,e,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${e}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${r}`),o&&(u+=` in document ${s}`),u+=")"),new Zr(Jr.INVALID_ARGUMENT,a+t+u)}function am(t,e){return t.some((t=>t.isEqual(e)))}class um{constructor(t,e,n,r,s){this._firestore=t,this._userDataWriter=e,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new ng(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const t=new cm(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(t)}return this._userDataWriter.convertValue(this._document.data.value)}}get(t){if(this._document){const e=this._document.data.field(lm("DocumentSnapshot.get",t));if(null!==e)return this._userDataWriter.convertValue(e)}}}class cm extends um{data(){return super.data()}}function lm(t,e){return"string"==typeof e?im(t,e):e instanceof Rg?e._internalPath:e._delegate._internalPath}function hm(t){if("L"===t.limitType&&0===t.explicitOrderBy.length)throw new Zr(Jr.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class dm{}class fm extends dm{}function gm(t,e,...n){let r=[];e instanceof dm&&r.push(e),r=r.concat(n),function(t){const e=t.filter((t=>t instanceof ym)).length,n=t.filter((t=>t instanceof mm)).length;if(e>1||e>0&&n>0)throw new Zr(Jr.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const e of r)t=e._apply(t);return t}class mm extends fm{constructor(t,e,n){super(),this._field=t,this._op=e,this._value=n,this.type="where"}static _create(t,e,n){return new mm(t,e,n)}_apply(t){const e=this._parse(t);return Lm(t._query,e),new eg(t.firestore,t.converter,aa(t._query,e))}_parse(t){const e=zg(t.firestore),n=function(t,e,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new Zr(Jr.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Mm(o,i);const e=[];for(const n of o)e.push(Rm(r,t,n));a={arrayValue:{values:e}}}else a=Rm(r,t,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Mm(o,i),a=Jg(n,e,o,"in"===i||"not-in"===i);return Co.create(s,i,a)}(t._query,"where",e,t.firestore._databaseId,this._field,this._op,this._value);return n}}function pm(t,e,n){const r=e,s=lm("where",t);return mm._create(s,r,n)}class ym extends dm{constructor(t,e){super(),this.type=t,this._queryConstraints=e}static _create(t,e){return new ym(t,e)}_parse(t){const e=this._queryConstraints.map((e=>e._parse(t))).filter((t=>t.getFilters().length>0));return 1===e.length?e[0]:Do.create(e,this._getOperator())}_apply(t){const e=this._parse(t);return 0===e.getFilters().length?t:(function(t,e){let n=t;const r=e.getFlattenedFilters();for(const t of r)Lm(n,t),n=aa(n,t)}(t._query,e),new eg(t.firestore,t.converter,aa(t._query,e)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}function wm(...t){return t.forEach((t=>Om("or",t))),ym._create("or",t)}function vm(...t){return t.forEach((t=>Om("and",t))),ym._create("and",t)}class bm extends fm{constructor(t,e){super(),this._field=t,this._direction=e,this.type="orderBy"}static _create(t,e){return new bm(t,e)}_apply(t){const e=function(t,e,n){if(null!==t.startAt)throw new Zr(Jr.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==t.endAt)throw new Zr(Jr.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new To(e,n)}(t._query,this._field,this._direction);return new eg(t.firestore,t.converter,function(t,e){const n=t.explicitOrderBy.concat([e]);return new Zo(t.path,t.collectionGroup,n,t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt)}(t._query,e))}}function _m(t,e="asc"){const n=e,r=lm("orderBy",t);return bm._create(r,n)}class Im extends fm{constructor(t,e,n){super(),this.type=t,this._limit=e,this._limitType=n}static _create(t,e,n){return new Im(t,e,n)}_apply(t){return new eg(t.firestore,t.converter,ua(t._query,this._limit,this._limitType))}}function Em(t){return Xf("limit",t),Im._create("limit",t,"F")}function Tm(t){return Xf("limitToLast",t),Im._create("limitToLast",t,"L")}class Sm extends fm{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new Sm(t,e,n)}_apply(t){const e=km(t,this.type,this._docOrFields,this._inclusive);return new eg(t.firestore,t.converter,function(t,e){return new Zo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)}(t._query,e))}}function xm(...t){return Sm._create("startAt",t,!0)}function Cm(...t){return Sm._create("startAfter",t,!1)}class Dm extends fm{constructor(t,e,n){super(),this.type=t,this._docOrFields=e,this._inclusive=n}static _create(t,e,n){return new Dm(t,e,n)}_apply(t){const e=km(t,this.type,this._docOrFields,this._inclusive);return new eg(t.firestore,t.converter,function(t,e){return new Zo(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)}(t._query,e))}}function Am(...t){return Dm._create("endBefore",t,!1)}function Nm(...t){return Dm._create("endAt",t,!0)}function km(t,e,n,r){if(n[0]=v(n[0]),n[0]instanceof um)return function(t,e,n,r,s){if(!r)throw new Zr(Jr.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const n of sa(t))if(n.field.isKeyField())i.push(io(e,r.key));else{const t=r.data.field(n.field);if(ji(t))throw new Zr(Jr.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===t){const t=n.field.canonicalString();throw new Zr(Jr.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${t}' (used as the orderBy) does not exist.`)}i.push(t)}return new _o(i,s)}(t._query,t.firestore._databaseId,e,n[0]._document,r);{const s=zg(t.firestore);return function(t,e,n,r,s,i){const o=t.explicitOrderBy;if(s.length>o.length)throw new Zr(Jr.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let i=0;i<s.length;i++){const u=s[i];if(o[i].field.isKeyField()){if("string"!=typeof u)throw new Zr(Jr.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof u}`);if(!ra(t)&&-1!==u.indexOf("/"))throw new Zr(Jr.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${u}' contains a slash.`);const n=t.path.child(ws.fromString(u));if(!_s.isDocumentKey(n))throw new Zr(Jr.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new _s(n);a.push(io(e,s))}else{const t=Jg(n,r,u);a.push(t)}}return new _o(a,i)}(t._query,t.firestore._databaseId,s,e,n,r)}}function Rm(t,e,n){if("string"==typeof(n=v(n))){if(""===n)throw new Zr(Jr.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!ra(e)&&-1!==n.indexOf("/"))throw new Zr(Jr.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=e.path.child(ws.fromString(n));if(!_s.isDocumentKey(r))throw new Zr(Jr.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return io(t,new _s(r))}if(n instanceof ng)return io(t,n._key);throw new Zr(Jr.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Wf(n)}.`)}function Mm(t,e){if(!Array.isArray(t)||0===t.length)throw new Zr(Jr.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${e.toString()}' filters.`)}function Lm(t,e){const n=function(t,e){for(const n of t)for(const t of n.getFlattenedFilters())if(e.indexOf(t.op)>=0)return t.op;return null}(t.filters,function(t){switch(t){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(e.op));if(null!==n)throw n===e.op?new Zr(Jr.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${e.op.toString()}' filter.`):new Zr(Jr.INVALID_ARGUMENT,`Invalid query. You cannot use '${e.op.toString()}' filters with '${n.toString()}' filters.`)}function Om(t,e){if(!(e instanceof mm||e instanceof ym))throw new Zr(Jr.INVALID_ARGUMENT,`Function ${t}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class Pm{convertValue(t,e="none"){switch(Xi(t)){case 0:return null;case 1:return t.booleanValue;case 2:return zi(t.integerValue||t.doubleValue);case 3:return this.convertTimestamp(t.timestampValue);case 4:return this.convertServerTimestamp(t,e);case 5:return t.stringValue;case 6:return this.convertBytes(Gi(t.bytesValue));case 7:return this.convertReference(t.referenceValue);case 8:return this.convertGeoPoint(t.geoPointValue);case 9:return this.convertArray(t.arrayValue,e);case 10:return this.convertObject(t.mapValue,e);default:throw Hr()}}convertObject(t,e){return this.convertObjectMap(t.fields,e)}convertObjectMap(t,e="none"){const n={};return Di(t,((t,r)=>{n[t]=this.convertValue(r,e)})),n}convertGeoPoint(t){return new Og(zi(t.latitude),zi(t.longitude))}convertArray(t,e){return(t.values||[]).map((t=>this.convertValue(t,e)))}convertServerTimestamp(t,e){switch(e){case"previous":const n=Ki(t);return null==n?null:this.convertValue(n,e);case"estimate":return this.convertTimestamp($i(t));default:return null}}convertTimestamp(t){const e=Ui(t);return new ms(e.seconds,e.nanos)}convertDocumentKey(t,e){const n=ws.fromString(t);Wr(dc(n));const r=new Hi(n.get(1),n.get(3)),s=new _s(n.popFirst(5));return r.isEqual(e)||Kr(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${e.projectId}/${e.database}) instead.`),s}}function Fm(t,e,n){let r;return r=t?n&&(n.merge||n.mergeFields)?t.toFirestore(e,n):t.toFirestore(e):e,r}class Vm extends Pm{constructor(t){super(),this.firestore=t}convertBytes(t){return new kg(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new ng(this.firestore,null,e)}}function qm(t){return new Ag("sum",rm("sum",t))}function Bm(t){return new Ag("avg",rm("average",t))}function Um(){return new Ag("count")}function zm(t,e){var n,r;return t instanceof Ag&&e instanceof Ag&&t.aggregateType===e.aggregateType&&(null===(n=t._internalFieldPath)||void 0===n?void 0:n.canonicalString())===(null===(r=e._internalFieldPath)||void 0===r?void 0:r.canonicalString())}function Gm(t,e){return ug(t.query,e.query)&&y(t.data(),e.data())}class jm{constructor(t,e){this.hasPendingWrites=t,this.fromCache=e}isEqual(t){return this.hasPendingWrites===t.hasPendingWrites&&this.fromCache===t.fromCache}}class Km extends um{constructor(t,e,n,r,s,i){super(t,e,n,r,i),this._firestore=t,this._firestoreImpl=t,this.metadata=s}exists(){return super.exists()}data(t={}){if(this._document){if(this._converter){const e=new $m(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(e,t)}return this._userDataWriter.convertValue(this._document.data.value,t.serverTimestamps)}}get(t,e={}){if(this._document){const n=this._document.data.field(lm("DocumentSnapshot.get",t));if(null!==n)return this._userDataWriter.convertValue(n,e.serverTimestamps)}}}class $m extends Km{data(t={}){return super.data(t)}}class Qm{constructor(t,e,n,r){this._firestore=t,this._userDataWriter=e,this._snapshot=r,this.metadata=new jm(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach((e=>t.push(e))),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,e){this._snapshot.docs.forEach((n=>{t.call(e,new $m(this._firestore,this._userDataWriter,n.key,n,new jm(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(t={}){const e=!!t.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new Zr(Jr.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(t,e){if(t._snapshot.oldDocs.isEmpty()){let e=0;return t._snapshot.docChanges.map((n=>{const r=new $m(t._firestore,t._userDataWriter,n.doc.key,n.doc,new jm(t._snapshot.mutatedKeys.has(n.doc.key),t._snapshot.fromCache),t.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:e++}}))}{let n=t._snapshot.oldDocs;return t._snapshot.docChanges.filter((t=>e||3!==t.type)).map((e=>{const r=new $m(t._firestore,t._userDataWriter,e.doc.key,e.doc,new jm(t._snapshot.mutatedKeys.has(e.doc.key),t._snapshot.fromCache),t.query.converter);let s=-1,i=-1;return 0!==e.type&&(s=n.indexOf(e.doc.key),n=n.delete(e.doc.key)),1!==e.type&&(n=n.add(e.doc),i=n.indexOf(e.doc.key)),{type:Hm(e.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Hm(t){switch(t){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return Hr()}}function Wm(t,e){return t instanceof Km&&e instanceof Km?t._firestore===e._firestore&&t._key.isEqual(e._key)&&(null===t._document?null===e._document:t._document.isEqual(e._document))&&t._converter===e._converter:t instanceof Qm&&e instanceof Qm&&t._firestore===e._firestore&&ug(t.query,e.query)&&t.metadata.isEqual(e.metadata)&&t._snapshot.isEqual(e._snapshot)}function Ym(t){t=Yf(t,ng);const e=Yf(t.firestore,fg);return Uf(pg(e),t._key).then((n=>lp(e,t,n)))}class Xm extends Pm{constructor(t){super(),this.firestore=t}convertBytes(t){return new kg(t)}convertReference(t){const e=this.convertDocumentKey(t,this.firestore._databaseId);return new ng(this.firestore,null,e)}}function Jm(t){t=Yf(t,ng);const e=Yf(t.firestore,fg),n=pg(e),r=new Xm(e);return function(t,e){const n=new ts;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await function(t,e){const n=Xr(t);return n.persistence.runTransaction("read document","readonly",(t=>n.localDocuments.getDocument(t,e)))}(t,e);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new Zr(Jr.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(t){const r=Id(t,`Failed to get document '${e} from cache`);n.reject(r)}}(await Pf(t),e,n))),n.promise}(n,t._key).then((n=>new Km(e,r,t._key,n,new jm(null!==n&&n.hasLocalMutations,!0),t.converter)))}function Zm(t){t=Yf(t,ng);const e=Yf(t.firestore,fg);return Uf(pg(e),t._key,{source:"server"}).then((n=>lp(e,t,n)))}function tp(t){t=Yf(t,eg);const e=Yf(t.firestore,fg),n=pg(e),r=new Xm(e);return hm(t._query),zf(n,t._query).then((n=>new Qm(e,r,t,n)))}function ep(t){t=Yf(t,eg);const e=Yf(t.firestore,fg),n=pg(e),r=new Xm(e);return function(t,e){const n=new ts;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){try{const r=await gh(t,e,!0),s=new Bd(e,r.hs),i=s.ha(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(t){const r=Id(t,`Failed to execute query '${e} against cache`);n.reject(r)}}(await Pf(t),e,n))),n.promise}(n,t._query).then((n=>new Qm(e,r,t,n)))}function np(t){t=Yf(t,eg);const e=Yf(t.firestore,fg),n=pg(e),r=new Xm(e);return zf(n,t._query,{source:"server"}).then((n=>new Qm(e,r,t,n)))}function rp(t,e,n){t=Yf(t,ng);const r=Yf(t.firestore,fg),s=Fm(t.converter,e,n);return cp(r,[Gg(zg(r),"setDoc",t._key,s,null!==t.converter,n).toMutation(t._key,Qa.none())])}function sp(t,e,n,...r){t=Yf(t,ng);const s=Yf(t.firestore,fg),i=zg(s);let o;return o="string"==typeof(e=v(e))||e instanceof Rg?Xg(i,"updateDoc",t._key,e,n,r):Yg(i,"updateDoc",t._key,e),cp(s,[o.toMutation(t._key,Qa.exists(!0))])}function ip(t){return cp(Yf(t.firestore,fg),[new ou(t._key,Qa.none())])}function op(t,e){const n=Yf(t.firestore,fg),r=og(t),s=Fm(t.converter,e);return cp(n,[Gg(zg(t.firestore),"addDoc",r._key,s,null!==t.converter,{}).toMutation(r._key,Qa.exists(!1))]).then((()=>r))}function ap(t,...e){var n,r,s;t=v(t);let i={includeMetadataChanges:!1},o=0;"object"!=typeof e[o]||lg(e[o])||(i=e[o],o++);const a={includeMetadataChanges:i.includeMetadataChanges};if(lg(e[o])){const t=e[o];e[o]=null===(n=t.next)||void 0===n?void 0:n.bind(t),e[o+1]=null===(r=t.error)||void 0===r?void 0:r.bind(t),e[o+2]=null===(s=t.complete)||void 0===s?void 0:s.bind(t)}let u,c,l;if(t instanceof ng)c=Yf(t.firestore,fg),l=ea(t._key.path),u={next:n=>{e[o]&&e[o](lp(c,t,n))},error:e[o+1],complete:e[o+2]};else{const n=Yf(t,eg);c=Yf(n.firestore,fg),l=n._query;const r=new Xm(c);u={next:t=>{e[o]&&e[o](new Qm(c,r,n,t))},error:e[o+1],complete:e[o+2]},hm(t._query)}return function(t,e,n,r){const s=new Sf(r),i=new Md(e,s,n);return t.asyncQueue.enqueueAndForget((async()=>Dd(await Bf(t),i))),()=>{s.La(),t.asyncQueue.enqueueAndForget((async()=>Ad(await Bf(t),i)))}}(pg(c),l,a,u)}function up(t,e){return function(t,e){const n=new Sf(e);return t.asyncQueue.enqueueAndForget((async()=>function(t,e){Xr(t).K_.add(e),e.next()}(await Bf(t),n))),()=>{n.La(),t.asyncQueue.enqueueAndForget((async()=>function(t,e){Xr(t).K_.delete(e)}(await Bf(t),n)))}}(pg(t=Yf(t,fg)),lg(e)?e:{next:e})}function cp(t,e){return function(t,e){const n=new ts;return t.asyncQueue.enqueueAndForget((async()=>async function(t,e,n){const r=wf(t);try{const t=await function(t,e){const n=Xr(t),r=ms.now(),s=e.reduce(((t,e)=>t.add(e.key)),Ca());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(t=>{let a=wa(),u=Ca();return n.os.getEntries(t,s).next((t=>{a=t,a.forEach(((t,e)=>{e.isValidDocument()||(u=u.add(t))}))})).next((()=>n.localDocuments.getOverlayedDocuments(t,a))).next((s=>{i=s;const o=[];for(const t of e){const e=Za(t,i.get(t.key).overlayedDocument);null!=e&&o.push(new nu(t.key,e,vo(e.value.mapValue),Qa.exists(!0)))}return n.mutationQueue.addMutationBatch(t,r,o,e)})).next((e=>{o=e;const r=e.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(t,e.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:_a(i)})))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId),function(t,e,n){let r=t.Da[t.currentUser.toKey()];r||(r=new Ni(ds)),r=r.insert(e,n),t.Da[t.currentUser.toKey()]=r}(r,t.batchId,n),await of(r,t.changes),await ud(r.remoteStore)}catch(t){const e=Id(t,"Failed to persist write");n.reject(e)}}(await Vf(t),e,n))),n.promise}(pg(t),e)}function lp(t,e,n){const r=n.docs.get(e._key),s=new Xm(t);return new Km(t,s,e._key,r,new jm(n.hasPendingWrites,n.fromCache),e.converter)}function hp(t){return dp(t,{count:Um()})}function dp(t,e){const n=Yf(t.firestore,fg),r=pg(n),s=function(t,e){const n=[];for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&n.push(e(t[r],r,t));return n}(e,((t,e)=>new hu(e,t.aggregateType,t._internalFieldPath)));return function(t,e,n){const r=new ts;return t.asyncQueue.enqueueAndForget((async()=>{try{const s=await qf(t);r.resolve(async function(t,e,n){var r;const s=Xr(t),{request:i,V_:o,parent:a}=function(t,e,n){const{ut:r,parent:s}=nc(t,e),i={},o=[];let a=0;return n.forEach((t=>{const e="aggregate_"+a++;i[e]=t.alias,"count"===t.aggregateType?o.push({alias:e,count:{}}):"avg"===t.aggregateType?o.push({alias:e,avg:{field:uc(t.fieldPath)}}):"sum"===t.aggregateType&&o.push({alias:e,sum:{field:uc(t.fieldPath)}})})),{request:{structuredAggregationQuery:{aggregations:o,structuredQuery:r.structuredQuery},parent:r.parent},V_:i,parent:s}}(s.serializer,function(t){const e=Xr(t);return e.Pe||(e.Pe=oa(e,t.explicitOrderBy)),e.Pe}(e),n);s.connection.wo||delete i.parent;const u=(await s.vo("RunAggregationQuery",s.serializer.databaseId,a,i,1)).filter((t=>!!t.result));Wr(1===u.length);const c=null===(r=u[0].result)||void 0===r?void 0:r.aggregateFields;return Object.keys(c).reduce(((t,e)=>(t[o[e]]=c[e],t)),{})}(s,e,n))}catch(t){r.reject(t)}})),r.promise}(r,t._query,s).then((e=>function(t,e,n){const r=new Xm(t);return new Ng(e,r,n)}(n,t,e)))}class fp{constructor(t){this.kind="memory",this._onlineComponentProvider=new Ef,(null==t?void 0:t.garbageCollector)?this._offlineComponentProvider=t.garbageCollector._offlineComponentProvider:this._offlineComponentProvider=new vf}toJSON(){return{kind:this.kind}}}class gp{constructor(t){let e;this.kind="persistent",(null==t?void 0:t.tabManager)?(t.tabManager._initialize(t),e=t.tabManager):(e=Ep(void 0),e._initialize(t)),this._onlineComponentProvider=e._onlineComponentProvider,this._offlineComponentProvider=e._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class mp{constructor(){this.kind="memoryEager",this._offlineComponentProvider=new vf}toJSON(){return{kind:this.kind}}}class pp{constructor(t){this.kind="memoryLru",this._offlineComponentProvider=new bf(t)}toJSON(){return{kind:this.kind}}}function yp(){return new mp}function wp(t){return new pp(null==t?void 0:t.cacheSizeBytes)}function vp(t){return new fp(t)}function bp(t){return new gp(t)}class _p{constructor(t){this.forceOwnership=t,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(t){this._onlineComponentProvider=new Ef,this._offlineComponentProvider=new _f(this._onlineComponentProvider,null==t?void 0:t.cacheSizeBytes,this.forceOwnership)}}class Ip{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(t){this._onlineComponentProvider=new Ef,this._offlineComponentProvider=new If(this._onlineComponentProvider,null==t?void 0:t.cacheSizeBytes)}}function Ep(t){return new _p(null==t?void 0:t.forceOwnership)}function Tp(){return new Ip}const Sp={maxAttempts:5};class xp{constructor(t,e){this._firestore=t,this._commitHandler=e,this._mutations=[],this._committed=!1,this._dataReader=zg(t)}set(t,e,n){this._verifyNotCommitted();const r=Cp(t,this._firestore),s=Fm(r.converter,e,n),i=Gg(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,Qa.none())),this}update(t,e,n,...r){this._verifyNotCommitted();const s=Cp(t,this._firestore);let i;return i="string"==typeof(e=v(e))||e instanceof Rg?Xg(this._dataReader,"WriteBatch.update",s._key,e,n,r):Yg(this._dataReader,"WriteBatch.update",s._key,e),this._mutations.push(i.toMutation(s._key,Qa.exists(!0))),this}delete(t){this._verifyNotCommitted();const e=Cp(t,this._firestore);return this._mutations=this._mutations.concat(new ou(e._key,Qa.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new Zr(Jr.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Cp(t,e){if((t=v(t)).firestore!==e)throw new Zr(Jr.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return t}class Dp extends class{constructor(t,e){this._firestore=t,this._transaction=e,this._dataReader=zg(t)}get(t){const e=Cp(t,this._firestore),n=new Vm(this._firestore);return this._transaction.lookup([e._key]).then((t=>{if(!t||1!==t.length)return Hr();const r=t[0];if(r.isFoundDocument())return new um(this._firestore,n,r.key,r,e.converter);if(r.isNoDocument())return new um(this._firestore,n,e._key,null,e.converter);throw Hr()}))}set(t,e,n){const r=Cp(t,this._firestore),s=Fm(r.converter,e,n),i=Gg(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(t,e,n,...r){const s=Cp(t,this._firestore);let i;return i="string"==typeof(e=v(e))||e instanceof Rg?Xg(this._dataReader,"Transaction.update",s._key,e,n,r):Yg(this._dataReader,"Transaction.update",s._key,e),this._transaction.update(s._key,i),this}delete(t){const e=Cp(t,this._firestore);return this._transaction.delete(e._key),this}}{constructor(t,e){super(t,e),this._firestore=t}get(t){const e=Cp(t,this._firestore),n=new Xm(this._firestore);return super.get(t).then((t=>new Km(this._firestore,n,e._key,t._document,new jm(!1,!1),e.converter)))}}function Ap(t,e,n){t=Yf(t,fg);const r=Object.assign(Object.assign({},Sp),n);return function(t){if(t.maxAttempts<1)throw new Zr(Jr.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(t,e,n){const r=new ts;return t.asyncQueue.enqueueAndForget((async()=>{const s=await qf(t);new Df(t.asyncQueue,s,n,e,r).ja()})),r.promise}(pg(t),(n=>e(new Dp(t,n))),r)}function Np(){return new jg("deleteField")}function kp(){return new $g("serverTimestamp")}function Rp(...t){return new Qg("arrayUnion",t)}function Mp(...t){return new Hg("arrayRemove",t)}function Lp(t){return new Wg("increment",t)}function Op(t){return pg(t=Yf(t,fg)),new xp(t,(e=>cp(t,e)))}function Pp(t,e){var n;const r=pg(t=Yf(t,fg));if(!r._uninitializedComponentsProvider||"memory"===(null===(n=r._uninitializedComponentsProvider)||void 0===n?void 0:n._offlineKind))return $r("Cannot enable indexes when persistence is disabled"),Promise.resolve();const s=function(t){const e="string"==typeof t?function(t){try{return JSON.parse(t)}catch(t){throw new Zr(Jr.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==t?void 0:t.message))}}(t):t,n=[];if(Array.isArray(e.indexes))for(const t of e.indexes){const e=Fp(t,"collectionGroup"),r=[];if(Array.isArray(t.fields))for(const e of t.fields){const t=im("setIndexConfiguration",Fp(e,"fieldPath"));"CONTAINS"===e.arrayConfig?r.push(new xs(t,2)):"ASCENDING"===e.order?r.push(new xs(t,0)):"DESCENDING"===e.order&&r.push(new xs(t,1))}n.push(new Is(Is.UNKNOWN_ID,e,r,Ds.empty()))}return n}(e);return function(t,e){return t.asyncQueue.enqueue((async()=>async function(t,e){const n=Xr(t),r=n.indexManager,s=[];return n.persistence.runTransaction("Configure indexes","readwrite",(t=>r.getFieldIndexes(t).next((n=>function(t,e,n,r,s){t=[...t],e=[...e],t.sort(n),e.sort(n);const i=t.length,o=e.length;let a=0,u=0;for(;a<o&&u<i;){const i=n(t[u],e[a]);i<0?s(t[u++]):i>0?r(e[a++]):(a++,u++)}for(;a<o;)r(e[a++]);for(;u<i;)s(t[u++])}(n,e,Ss,(e=>{s.push(r.addFieldIndex(t,e))}),(e=>{s.push(r.deleteFieldIndex(t,e))})))).next((()=>Ps.waitFor(s)))))}(await Pf(t),e)))}(r,s)}function Fp(t,e){if("string"!=typeof t[e])throw new Zr(Jr.INVALID_ARGUMENT,"Missing string value for: "+e);return t[e]}class Vp{constructor(t){this._client=t,this.type="PersistentCacheIndexManager"}}function qp(t){var e;t=Yf(t,fg);const n=jp.get(t);if(n)return n;const r=pg(t);if("persistent"!==(null===(e=r._uninitializedComponentsProvider)||void 0===e?void 0:e._offlineKind))return null;const s=new Vp(r);return jp.set(t,s),s}function Bp(t){Gp(t,!0)}function Up(t){Gp(t,!1)}function zp(t){t._client.verifyNotTerminated(),function(t){return t.asyncQueue.enqueue((async()=>function(t){const e=Xr(t),n=e.indexManager;return e.persistence.runTransaction("Delete All Indexes","readwrite",(t=>n.deleteAllFieldIndexes(t)))}(await Pf(t))))}(t._client).then((t=>jr("deleting all persistent cache indexes succeeded"))).catch((t=>$r("deleting all persistent cache indexes failed",t)))}function Gp(t,e){t._client.verifyNotTerminated(),function(t,e){return t.asyncQueue.enqueue((async()=>function(t,e){Xr(t).ts.Ui=e}(await Pf(t),e)))}(t._client,e).then((t=>jr(`setting persistent cache index auto creation isEnabled=${e} succeeded`))).catch((t=>$r(`setting persistent cache index auto creation isEnabled=${e} failed`,t)))}const jp=new WeakMap;class Kp{constructor(){throw new Error("instances of this class should not be created")}static onExistenceFilterMismatch(t){return $p.instance.onExistenceFilterMismatch(t)}}class $p{constructor(){this.Cu=new Map}static get instance(){return Qp||(Qp=new $p,function(t){if(yu)throw new Error("a TestingHooksSpi instance is already set");yu=t}(Qp)),Qp}tt(t){this.Cu.forEach((e=>e(t)))}onExistenceFilterMismatch(t){const e=Symbol(),n=this.Cu;return n.set(e,t),()=>n.delete(e)}}let Qp=null;!function(t,e=!0){!function(t){Br=t}(i.SDK_VERSION),i._registerComponent(new b("firestore",((t,{instanceIdentifier:n,options:r})=>{const s=t.getProvider("app").getImmediate(),i=new fg(new ss(t.getProvider("auth-internal")),new us(t.getProvider("app-check-internal")),function(t,e){if(!Object.prototype.hasOwnProperty.apply(t.options,["projectId"]))throw new Zr(Jr.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Hi(t.options.projectId,e)}(s,n),s);return r=Object.assign({useFetchStreams:e},r),i._setSettings(r),i}),"PUBLIC").setMultipleInstances(!0)),i.registerVersion(Vr,"4.4.2",t),i.registerVersion(Vr,"4.4.2","esm2017")}()}))})();